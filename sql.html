<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sql</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="sql刷题">SQL刷题</h1>
<h2 id="题目">题目</h2>
<h3 id="easy">Easy</h3>
<ol>
<li><a href="#1">Actors and Directors Who Cooperated At Least Three Times</a></li>
<li><a href="#2">Ads Performance</a></li>
</ol>
<h3 id="span-id11.-actors-and-directors-who-cooperated-at-least-three-timesspan"><span id="1">1. Actors and Directors Who Cooperated At Least Three Times</span></h3>
<p>注意到，这里的table: <code>ActorDirector</code> 包含三列，其中timestamp是<a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1218728391867808">主键</a>。</p>
<p>我们需要找到所有的配对（actor_id, director_id）其中演员和导演合作过至少三次。</p>
<p>所以，我们要求<code>actor_id</code>和<code>director_id</code>配对的数量不小于三，<br>
利用<code>count</code>函数我们有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> actordirector
<span class="token keyword">group</span> <span class="token keyword">by</span> actor_id<span class="token punctuation">,</span> director_id
</code></pre>
<p>这一步的结果如下，我们对应每个演员、导演并且计算出他们合作的次数，分别为3，2，2。</p>
<p><code>{"headers": ["actor_id", "director_id", "c"], "values": [[1, 1, 3], [1, 2, 2], [2, 1, 2]]}</code></p>
<p>如果不清楚<code>group by</code>可以看<a href="https://www.w3schools.com/sql/sql_groupby.asp">这里</a>。</p>
<p>还有，我们可以用<code>group by 1,2</code>来代替<code>group by actor_id, director_id</code>，其实1和2代表的就是<code>select</code>前两列的意思。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> actordirector
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
</code></pre>
<p>接下来，我们只需在这个基础上找到所有的演员和导演满足<code>counts &gt;= 3</code>即可。</p>
<p><font color="red">最终答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> actordirector
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> counts <span class="token operator">&gt;=</span> <span class="token number">3</span>
</code></pre>
<p>这里使用了十分常见的<a href="https://www.1keydata.com/cn/sql/sql-subquery.php">subquery</a>，其中注意要在table后面加上别名（alias），这里用tmp表示</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql1.png?raw=true">
</p>
<h3 id="span-id22.-ads-performancespan"><span id="2">2. Ads Performance</span></h3>
<p>注意，<code>Ads</code>表里面<code>ad_id</code>和<code>user_id</code>是主键，我们需要按照给出的公式算出CTR。</p>
<p>所以根据每个<code>ad_id</code>，我们可以计算出其对应的<code>Clicked</code>和<code>Viewed</code>的个数，在利用公式可求得CTR。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> ad_id<span class="token punctuation">,</span>
<span class="token comment"># case when类似于if else语句，表示当action = 'Clicked'记为1，否则记为0,注意一定后面加上end！用sum函数计算每个不同的ad_id对应的Clicked的总数，同理用其除以后面的式子，得到ctr，并用round函数保留两位小数</span>
	<span class="token function">round</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token operator">or</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Viewed'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ctr
<span class="token keyword">from</span> ads
<span class="token keyword">group</span> <span class="token keyword">by</span> ad_id <span class="token comment"># 对应每个不同的ad_id</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> ctr <span class="token keyword">desc</span><span class="token punctuation">,</span> ad_id <span class="token keyword">asc</span><span class="token punctuation">;</span> <span class="token comment"># 排序</span>
</code></pre>
<p>结果如下：</p>
<p><code>{"headers": ["ad_id", "ctr"], "values": [[1, 66.67], [3, 50.00], [2, 33.33], [5, null]]}</code></p>
<p>我们发现，当<code>ad_id</code>等于<code>5</code>，ctr为<code>null</code>而不是<code>0.00</code>。所以我们需要对这种情况做些调整，用<code>ifnull</code>函数把<code>null</code>转换成<code>0</code>。</p>
<p><font color="red">最终答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># case when类似于if else语句，表示当action = 'Clicked'记为1，否则记为0,注意一定后面加上end！用sum函数计算每个不同的ad_id对应的Clicked的总数，同理用其除以后面的式子，得到ctr，并用round函数保留两位小数，且用ifnull函数处理缺失值。</span>
<span class="token keyword">select</span> ad_id<span class="token punctuation">,</span>
	ifnull<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token operator">or</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Viewed'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ctr
<span class="token keyword">from</span> ads
<span class="token keyword">group</span> <span class="token keyword">by</span> ad_id <span class="token comment"># 对应每个不同的ad_id</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> ctr <span class="token keyword">desc</span><span class="token punctuation">,</span> ad_id <span class="token keyword">asc</span><span class="token punctuation">;</span> <span class="token comment"># 排序</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql1.png?raw=true">
</p>
</div>
</body>

</html>
