<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sql</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p align="center">
	  <img src="https://thumbs.gfycat.com/InsistentSardonicAppaloosa-small.gif">
</p>
<h1 id="sql刷题">SQL刷题</h1>
<h2 id="题目">题目</h2>
<h3 id="easy">Easy</h3>
<blockquote>
<p>加粗的题目里面含有follow up question!<br>
斜体的题目是系列套题，可以一起做！</p>
</blockquote>
<ol>
<li><a href="#1">Actors and Directors Who Cooperated At Least Three Times</a></li>
<li><a href="#2">Ads Performance</a></li>
<li><a href="#3"><em>Article Views I</em></a></li>
<li><a href="#4">Average Selling Price</a></li>
<li><a href="#5">Biggest Single Number</a></li>
<li><a href="#6">Combine Two Tables</a></li>
<li><a href="#7">Consecutive Available Seats</a></li>
<li><a href="#8">Customer Order Frequency</a></li>
<li><strong><a href="#9">Customer Placing the Largest Number of Orders</a></strong></li>
<li><a href="#10">Customers Who Never Order</a></li>
<li><a href="#11">Delete Duplicate Emails</a></li>
<li><a href="#12">Duplicate Emails</a></li>
<li><a href="#13">Employee Bonus</a></li>
<li><a href="#14">Employees Earning More Than Their Managers</a></li>
<li><a href="#15">Find Customer Referee</a></li>
<li><a href="#16">Find Users With Valid E-Mails</a></li>
<li><a href="#17">Find the Team Size</a></li>
<li><a href="#18">Fix Product Name Format</a></li>
<li><strong><a href="#19"><em>Friend Requests I: Overall Acceptance Rate</em></a></strong></li>
<li><a href="#20">Unique Orders and Customers Per Month</a></li>
<li><a href="#21">Friendly Movies Streamed Last Month</a></li>
<li><a href="#22"><em>Game Play Analysis I</em></a></li>
<li><a href="#23"><em>Game Play Analysis II</em></a></li>
<li><a href="#24">Group Sold Products By The Date</a></li>
<li><a href="#25"><em>Immediate Food Delivery I</em></a></li>
<li><a href="#26">List the Products Ordered in a Period</a></li>
<li><a href="#27">Not Boring Movies</a></li>
<li><a href="#28"><em>Project Employees II</em></a></li>
<li><a href="#29">Customer Who Visited but Did Not Make Any Transactions</a></li>
<li><a href="#30">Queries Quality and Percentage</a></li>
<li><a href="#31">Reformat Department Table</a></li>
<li><a href="#32">Rising Temperature</a></li>
<li><a href="#33"><em>Sales Analysis I</em></a></li>
<li><a href="#34"><em>Sales Analysis II</em></a></li>
<li><a href="#35"><em>Sales Analysis III</em></a></li>
</ol>
<h3 id="span-id11.-actors-and-directors-who-cooperated-at-least-three-timesspan"><span id="1">1. Actors and Directors Who Cooperated At Least Three Times</span></h3>
<p>注意到，这里的table: <code>ActorDirector</code> 包含三列，其中timestamp是<a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1218728391867808">主键</a>。</p>
<p>我们需要找到所有的配对（actor_id, director_id）其中演员和导演合作过至少三次。</p>
<p>所以，我们要求<code>actor_id</code>和<code>director_id</code>配对的数量不小于三，<br>
利用<code>count</code>函数我们有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> actordirector
<span class="token keyword">group</span> <span class="token keyword">by</span> actor_id<span class="token punctuation">,</span> director_id
</code></pre>
<p>这一步的结果如下，我们对应每个演员、导演并且计算出他们合作的次数，分别为3，2，2。</p>
<p><code>{"headers": ["actor_id", "director_id", "c"], "values": [[1, 1, 3], [1, 2, 2], [2, 1, 2]]}</code></p>
<p>如果不清楚<code>group by</code>可以看<a href="https://www.w3schools.com/sql/sql_groupby.asp">这里</a>。</p>
<p>还有，我们可以用<code>group by 1,2</code>来代替<code>group by actor_id, director_id</code>，其实1和2代表的就是<code>select</code>前两列的意思。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> actordirector
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
</code></pre>
<p>接下来，我们只需在这个基础上找到所有的演员和导演满足<code>counts &gt;= 3</code>即可。</p>
<p><font color="red">最终答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> actor_id<span class="token punctuation">,</span> director_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> actordirector
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> counts <span class="token operator">&gt;=</span> <span class="token number">3</span>
</code></pre>
<p>这里使用了十分常见的<a href="https://www.1keydata.com/cn/sql/sql-subquery.php">subquery</a>，其中注意要在table后面加上别名（alias），这里用tmp表示</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql1.png?raw=true">
</p>
<h3 id="span-id22.-ads-performancespan"><span id="2">2. Ads Performance</span></h3>
<p>注意，<code>Ads</code>表里面<code>ad_id</code>和<code>user_id</code>是主键，我们需要按照给出的公式算出CTR。</p>
<p>所以根据每个<code>ad_id</code>，我们可以计算出其对应的<code>Clicked</code>和<code>Viewed</code>的个数，在利用公式可求得CTR。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> ad_id<span class="token punctuation">,</span>
<span class="token comment"># case when类似于if else语句，表示当action = 'Clicked'记为1，否则记为0,注意一定后面加上end！用sum函数计算每个不同的ad_id对应的Clicked的总数，同理用其除以后面的式子，得到ctr，并用round函数保留两位小数</span>
	<span class="token function">round</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token operator">or</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Viewed'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ctr
<span class="token keyword">from</span> ads
<span class="token keyword">group</span> <span class="token keyword">by</span> ad_id <span class="token comment"># 对应每个不同的ad_id</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> ctr <span class="token keyword">desc</span><span class="token punctuation">,</span> ad_id <span class="token keyword">asc</span><span class="token punctuation">;</span> <span class="token comment"># 排序</span>
</code></pre>
<p>结果如下：</p>
<p><code>{"headers": ["ad_id", "ctr"], "values": [[1, 66.67], [3, 50.00], [2, 33.33], [5, null]]}</code></p>
<p>我们发现，当<code>ad_id</code>等于<code>5</code>，ctr为<code>null</code>而不是<code>0.00</code>。所以我们需要对这种情况做些调整，用<code>ifnull</code>函数把<code>null</code>转换成<code>0</code>。</p>
<p><font color="red">最终答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># case when类似于if else语句，表示当action = 'Clicked'记为1，否则记为0,注意一定后面加上end！用sum函数计算每个不同的ad_id对应的Clicked的总数，同理用其除以后面的式子，得到ctr，并用round函数保留两位小数，且用ifnull函数处理缺失值。</span>
<span class="token keyword">select</span> ad_id<span class="token punctuation">,</span>
	ifnull<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Clicked'</span> <span class="token operator">or</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'Viewed'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ctr
<span class="token keyword">from</span> ads
<span class="token keyword">group</span> <span class="token keyword">by</span> ad_id <span class="token comment"># 对应每个不同的ad_id</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> ctr <span class="token keyword">desc</span><span class="token punctuation">,</span> ad_id <span class="token keyword">asc</span><span class="token punctuation">;</span> <span class="token comment"># 排序</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql2.png?raw=true">
</p>
<h3 id="span-id33.-article-views-ispan"><span id="3">3. Article Views I</span></h3>
<p>Table:  <code>Views</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> article_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> author_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> viewer_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> view_date     <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>注意这里没有主键，说明可能会含有重复的行，每一行表示某个观看者在某个日期观看了某个作者写的某篇文章。</p>
<p><strong>我们要找出所有的观看了至少一篇自己的文章的作者，并且按照他们的id的升序排序。</strong></p>
<pre class=" language-sql"><code class="prism  language-sql">Views <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">------------+-----------+-----------+------------+</span>
<span class="token operator">|</span> article_id <span class="token operator">|</span> author_id <span class="token operator">|</span> viewer_id <span class="token operator">|</span> view_date  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-----------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">5</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">6</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">6</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">22</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+----+----+---------------+</span>

Result <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span> <span class="token number">4</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> author_id <span class="token keyword">as</span> <span class="token string">'id'</span>
<span class="token keyword">from</span> views
<span class="token keyword">where</span> author_id <span class="token operator">=</span> viewer_id
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>

<span class="token comment"># 注意</span>
<span class="token comment"># 1. distinct 函数筛选出了唯一的auther_id，因为可能有重复的行存在</span>
<span class="token comment"># 2. order by 1 = order by author_id</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql3.png?raw=true">
</p>
<h3 id="span-id44.-average-selling-pricespan"><span id="4">4. Average Selling Price</span></h3>
<p>Table: <code>Prices</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> product_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> start_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> end_date      <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> price         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>这里的 <code>product_id</code>、<code>start_date</code>和 <code>end_date</code> 都是主键，<br>
每一行表示了在开始日期到结束日期内的每个 <code>product_id</code> 的价格，<br>
并且对于一个 <code>product_id</code>，不会有两个相交的时间区间存在。</p>
<p>Table:  <code>UnitsSold</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> product_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> purchase_date <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> units         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>这里没有主键，所以有重复的行，每一行表示对于每个卖出的产品的 <code>product_id</code>、<code>purchase_date</code> 和 <code>units</code>。</p>
<p><strong>我们需要找到每个产品的平均售卖价格。</strong></p>
<p>例如：</p>
<pre class=" language-sql"><code class="prism  language-sql">Prices <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">------------+------------+------------+--------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> start_date <span class="token operator">|</span> end_date   <span class="token operator">|</span> price  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">17</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">28</span> <span class="token operator">|</span> <span class="token number">5</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">22</span> <span class="token operator">|</span> <span class="token number">20</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">20</span> <span class="token operator">|</span> <span class="token number">15</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span> <span class="token operator">|</span> <span class="token number">30</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+--------+</span>
 
UnitsSold <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">------------+---------------+-------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> purchase_date <span class="token operator">|</span> units <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------------+-------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">25</span>    <span class="token operator">|</span> <span class="token number">100</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span> <span class="token number">15</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">10</span>    <span class="token operator">|</span> <span class="token number">200</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">22</span>    <span class="token operator">|</span> <span class="token number">30</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------------+-------+</span>

Result <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">------------+---------------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> average_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">6.96</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">16.96</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------------+</span>
Average selling price <span class="token operator">=</span> Total Price <span class="token keyword">of</span> Product <span class="token operator">/</span> Number <span class="token keyword">of</span> products sold<span class="token punctuation">.</span>
Average selling price <span class="token keyword">for</span> product <span class="token punctuation">`</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">115</span> <span class="token operator">=</span> <span class="token number">6.96</span><span class="token punctuation">`</span>
Average selling price <span class="token keyword">for</span> product <span class="token punctuation">`</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">230</span> <span class="token operator">=</span> <span class="token number">16.96</span><span class="token punctuation">`</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> p<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token operator">*</span>units<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span>units<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> average_price
<span class="token keyword">from</span> prices <span class="token keyword">as</span> p
<span class="token keyword">join</span> unitssold <span class="token keyword">as</span> u
<span class="token keyword">using</span> <span class="token punctuation">(</span>product_id<span class="token punctuation">)</span>
<span class="token keyword">where</span> u<span class="token punctuation">.</span>purchase_date <span class="token operator">between</span> p<span class="token punctuation">.</span>start_date <span class="token operator">and</span> p<span class="token punctuation">.</span>end_date
<span class="token keyword">group</span> <span class="token keyword">by</span> p<span class="token punctuation">.</span>product_id

<span class="token comment"># 注意</span>
<span class="token comment"># 1. 对于table要加上alias，并且对于公共的product_id要加上对应的table名</span>
<span class="token comment"># 2. using (product_id) 等价于 on p.product_id = u.product_id</span>
<span class="token comment"># 3. 要保证purchase_date在start_date和end_date中间，可能会被忽略，并且这个条件要在group by之前，因为在aggregate之前我们要筛选出满足时间范围的行，在进行计算！</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql4.png?raw=true">
</p>
<h3 id="span-id55.-biggest-single-numberspan"><span id="5">5. Biggest Single Number</span></h3>
<p>Table  <code>my_numbers</code>  contains many numbers in column  <strong>num</strong>  including duplicated ones.<br>
Can you write a SQL query to find the biggest number, which only appears once.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---+</span>
<span class="token operator">|</span>num<span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+</span>
<span class="token operator">|</span> <span class="token number">8</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span> <span class="token operator">|</span>
</code></pre>
<p>For the sample data above, your query should return the following result:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---+</span>
<span class="token operator">|</span>num<span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+</span>
<span class="token operator">|</span> <span class="token number">6</span> <span class="token operator">|</span>
</code></pre>
<p><strong>Note:</strong><br>
If there is no such number, just output <strong>null</strong>.</p>
<p>那么我们要找的就是num里面只出现一次的最大的数</p>
<p>可能你会这么写</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'num'</span>
<span class="token keyword">from</span> my_number
<span class="token keyword">group</span> <span class="token keyword">by</span> num
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p>但这样会返回错误的值，如下：</p>
<p><code>{"headers": ["num"], "values": [[1], [4], [5], [6]]}</code></p>
<p>我们是找出了出现次数为1的数字但是max函数貌似不起作用，因为这里的<code>max(num)</code>针对的是num，相当于对每一个group by的数字都取了最大值，也就是本身，所以无效</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">as</span> num
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span>
    num
<span class="token keyword">from</span>
    my_numbers
<span class="token keyword">group</span> <span class="token keyword">by</span> num
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmp
<span class="token comment"># 使用subquery对所有出现次数为1的数字取最大值</span>
</code></pre>
<p>或者</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">as</span> num
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span>
    num<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span>
    my_numbers
<span class="token keyword">group</span> <span class="token keyword">by</span> num<span class="token punctuation">)</span> <span class="token keyword">as</span> tmp
<span class="token keyword">where</span> counts <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql5.png?raw=true">
</p>
<h3 id="span-id66.-combine-two-tablesspan"><span id="6">6. Combine Two Tables</span></h3>
<p>Table:  <code>Person</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> PersonId    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> FirstName   <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> LastName    <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p>PersonId is the primary key column for this table.</p>
<p>Table:  <code>Address</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> AddressId   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> PersonId    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> City        <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> State       <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p>AddressId is the primary key column for this table.</p>
<p>Write a SQL query for a report that provides the following information for each person in the Person table, regardless if there is an address for each of those people:</p>
<p><code>FirstName, LastName, City, State</code></p>
<p>这个题看似很简单，只需要把他们合并起来就可以了，但是要注意<code>inner join</code>和<code>left join</code>的区别（<code>right join</code>其实和<code>left join</code>是一回事）。</p>
<p>一图流！</p>
<p align="center">
	  <img src="https://i.stack.imgur.com/fzwkg.png">
</p>
<p>这里题目要求我们找出每个人的各种信息，无论这个人是不是有地址，也就是哪怕没有地址，也要用<code>null</code>表示，那自然要用<code>left join</code>。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> FirstName<span class="token punctuation">,</span> LastName<span class="token punctuation">,</span> City<span class="token punctuation">,</span> State
<span class="token keyword">from</span> Person <span class="token keyword">left</span> <span class="token keyword">join</span> Address
<span class="token keyword">on</span> Person<span class="token punctuation">.</span>PersonId <span class="token operator">=</span> Address<span class="token punctuation">.</span>PersonId
<span class="token comment"># using (PersonId)</span>
</code></pre>
<p>结果如下：</p>
<p><code>{"headers": ["FirstName", "LastName", "City", "State"], "values": [["Allen", "Wang", null, null]]}</code></p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql6.png?raw=true">
</p>
<h3 id="span-id77.-consecutive-available-seatsspan"><span id="7">7. Consecutive Available Seats</span></h3>
<p>Several friends at a cinema ticket office would like to reserve consecutive available seats.<br>
Can you help to query all the consecutive available seats order by the seat_id using the following <code>cinema</code> table?</p>

<table>
<thead>
<tr>
<th>seat_id</th>
<th>free</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
</tr>
</tbody>
</table><p>Your query should return the following result for the sample case above.</p>

<table>
<thead>
<tr>
<th>seat_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
</tr>
<tr>
<td>4</td>
</tr>
<tr>
<td>5</td>
</tr>
</tbody>
</table><p><strong>Note</strong>:</p>
<ul>
<li>The seat_id is an auto increment int, and free is bool (‘1’ means free, and ‘0’ means occupied.).</li>
<li>Consecutive available seats are more than 2(inclusive) seats consecutively available.</li>
</ul>
<p>我们要找到连续挨着的并且是可以坐的（available）的<code>seat_id</code>，并按照其升序排序。</p>
<p>感觉不是那么简单对吧，这里要用到<code>cross join</code>。</p>
<p>一图流！</p>
<p align="center">
	  <img src="https://cdn.sqlservertutorial.net/wp-content/uploads/SQL-Server-CROSS-JOIN-example.png">
</p>
<p>所谓<code>cross join</code>也就是两个表格的<a href="https://zh.wikipedia.org/wiki/%E7%AC%9B%E5%8D%A1%E5%84%BF%E7%A7%AF">笛卡尔积</a>，是我们很常用的手段之一。那么如果这个table有5行，那么在经过跟自己本身<code>cross join</code>之后，就会变成一个<code>5 x 5</code>的table，我们要找的就是 table A 和 table B（<strong>当然，他们其实是同一个table，只不过名称不同</strong>）的满足下列两个条件的<code>seat_id</code>：</p>
<ul>
<li>在 A 和 B 中都满足<code>free = 1</code>，因为我们要满足 available。</li>
<li><code>seat_id</code>是连续的，也就是他们差的绝对值是等于1的</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> <span class="token number">a</span><span class="token punctuation">.</span>seat_id
<span class="token keyword">from</span> cinema <span class="token number">a</span><span class="token punctuation">,</span> cinema <span class="token number">b</span>
<span class="token keyword">where</span> abs<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>seat_id <span class="token operator">-</span> <span class="token number">b</span><span class="token punctuation">.</span>seat_id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>free <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>free <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token comment"># 直接使用 select from table A, table B 这种语法其实就是cross join，不要以为你没有用join，其实这就是和cross join等价的！</span>
</code></pre>
<p>或者</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> <span class="token number">a</span><span class="token punctuation">.</span>seat_id
<span class="token keyword">from</span> cinema <span class="token number">a</span>
<span class="token keyword">join</span> cinema <span class="token number">b</span>
	<span class="token keyword">on</span> abs<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>seat_id <span class="token operator">-</span> <span class="token number">b</span><span class="token punctuation">.</span>seat_id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>free <span class="token operator">=</span> <span class="token number">1</span> 
	<span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>free <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token comment"># 这个就是self join的一般写法！</span>
</code></pre>
<p>我估计你可能还是没太明白<code>self join</code>的含义，这个题是属于<code>cross join</code>的题，但也属于<code>self join</code>，因为table是和自己本身<code>cross join</code>的，但是<code>cross join</code>不局限于自己和自己本身去 join，下面这个链接会帮你更好的理解<code>self join</code>!</p>
<p>补充资料：</p>
<ul>
<li><a href="https://stackoverflow.com/questions/3362038/what-is-self-join-and-when-would-you-use-it#:~:text=You%20use%20a%20self%20join,boss%20of%20the%20current%20employee.&amp;text=It's%20basically%20used%20where%20there,stored%20in%20the%20same%20table.">什么是 self join 以及什么时候使用它？</a></li>
<li><a href="https://towardsdatascience.com/take-your-sql-skills-to-the-next-level-by-understanding-the-self-join-75f1d52f2322">self join 详细讲解</a></li>
</ul>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql7.png?raw=true">
</p>
<h3 id="span-id88.-customer-order-frequencyspan"><span id="8">8. Customer Order Frequency</span></h3>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql8-2.png?raw=true">
</p>
<p>这个题目算是比较复杂的了，我会一步一步拆开讲解！</p>
<p>首先这里有三个 table，分别是 <code>customers</code>、<code>product</code> 和 <code>orders</code>，我们需要从中找出 <code>customer_id</code> 和 <code>name</code> 满足下面两个条件：</p>
<ul>
<li>在2020年6月和7月都有消费</li>
<li>并且消费的金额都不小于$100</li>
</ul>
<p>首先，我们从例子中可以看到，<code>product_id</code> 和 <code>customer_id</code> 可以作为连接表的媒介，并且是不存在其中一个媒介的元素一个表格里有，而另一个表格没有，这就说明我们可以放心使用 <code>inner join</code> 而不用担心 <code>null</code> 会存在的问题！</p>
<p>那么自然我们要把 <code>product</code> 和 <code>orders</code> 连接在一起，因为他们包含了产品的价格和数量，我们需要计算他们的乘积，得出某个人在某个时间在某个产品上花费的总钱数。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 先空着
<span class="token keyword">from</span> product p
<span class="token keyword">join</span> orders o
<span class="token keyword">on</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> o<span class="token punctuation">.</span>product_id
<span class="token comment"># using (product_id)</span>
</code></pre>
<p>那么这样我们就把两个 table 连接起来了，我们要选取这个新表格的哪些列呢？</p>
<p>根据我们所需要满足的条件，肯定需要 <code>customer_id</code>，因为我们需要知道是谁买的；也需要 <code>order_date</code>，因为我们只要找在6月和7月有消费的人；最后还有 <code>price * quantity</code>，因为我们要找到消费总额超过$100的人。</p>
<p>所以我们有</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_id<span class="token punctuation">,</span> order_date price<span class="token operator">*</span>quantity
<span class="token keyword">from</span> product p
<span class="token keyword">join</span> orders o
<span class="token keyword">on</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> o<span class="token punctuation">.</span>product_id
</code></pre>
<p>然后，我们发现 <code>order_date</code> 是以年月日的形式出现的，但我们需要把他转换成以月为单位，因为我们只要找6或7月的消费的人，不关心具体是哪一天，这里使用了 <a href="https://www.w3schools.com/sql/func_mysql_date_format.asp"><code>date_format</code> </a>，可以对日期进行转换。并且，我们需要针对每个消费者，计算出他们在6月和7月的总消费，所以用 <code>sum</code> 函数和 <code>group by</code> 函数；在这个基础上，我们要限定 <code>order_date</code> 在6到7月内，使用 <code>between and</code>，最后，要保证每人月均总消费不小于$100。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_id<span class="token punctuation">,</span> 
	   date_format<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span> <span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'order_date'</span><span class="token punctuation">,</span> 
	   <span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token operator">*</span>quantity<span class="token punctuation">)</span> <span class="token keyword">as</span> total
<span class="token keyword">from</span> product p
<span class="token keyword">join</span> orders o
<span class="token keyword">on</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> o<span class="token punctuation">.</span>product_id
<span class="token keyword">where</span> order_date <span class="token operator">between</span> <span class="token string">'2020-06-01'</span> <span class="token operator">and</span> <span class="token string">'2020-07-31'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token comment"># 也就是group by order_date和customer_id</span>
<span class="token keyword">having</span> total <span class="token operator">&gt;=</span> <span class="token number">100</span>
</code></pre>
<p>结果如下：</p>
<p><code>{"headers": ["customer_id", "order_date", "total"], "values": [[2, "2020-06", 600], [1, "2020-06", 300], [3, "2020-06", 110], [1, "2020-07", 100]]}</code></p>
<p>那么到这里，这道题的雏形已经出来了！我们已经成功找到了6和7月的月均总消费不小于$100的所有人，但是我们要找的人一定要在6和7月都有消费，也就是对于每个消费者，他们在其中出现的次数要等于2！</p>
<p>所以上面的结果成为了我们即将要去搜索的新表格，接下来使用subquery，对其进行进一步搜索。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_id<span class="token punctuation">,</span> name
<span class="token keyword">from</span> customers 
<span class="token keyword">where</span> customer_id <span class="token operator">in</span> <span class="token comment"># 从customer表里面找到满足下面括号内容的customer_id</span>
<span class="token punctuation">(</span>
	<span class="token keyword">select</span> customer_id 
	<span class="token keyword">from</span>
		<span class="token punctuation">(</span><span class="token keyword">select</span> customer_id<span class="token punctuation">,</span> 
				date_format<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span> <span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'order_date'</span><span class="token punctuation">,</span> 
				<span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token operator">*</span>quantity<span class="token punctuation">)</span> <span class="token keyword">as</span> total
		<span class="token keyword">from</span> product p
		<span class="token keyword">join</span> orders o
		<span class="token keyword">on</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> o<span class="token punctuation">.</span>product_id
		<span class="token keyword">where</span> order_date <span class="token operator">between</span> <span class="token string">'2020-06-01'</span> <span class="token operator">and</span> <span class="token string">'2020-07-31'</span>
		<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span>
		<span class="token keyword">having</span> total <span class="token operator">&gt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> tmp <span class="token comment"># tmp就是我们之前建立的新表格</span>
	<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id
	<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> 
	<span class="token comment"># 从新表格里面选出在其中出现次数等于2的消费者</span>
<span class="token punctuation">)</span>
</code></pre>
<p>看着是不是很复杂，其实并没有，真正工作当中，应用当中比这个复杂的要多的多。所以也不要感觉SQL特别简单，一学就会，其实也不尽然（<strong>这道题被归在简单的题集里</strong>）。还有我要建议你要把代码写的稍微“好看”一点，方便别人读懂，如果像下面这么写，估计别人很难看懂你要干什么吧，哪怕这仅仅是20行不到的代码。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_id <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> customer_id<span class="token punctuation">,</span> date_format<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span> <span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'order_date'</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token operator">*</span>quantity<span class="token punctuation">)</span> <span class="token keyword">as</span> total
<span class="token keyword">from</span> product p <span class="token keyword">join</span> orders o <span class="token keyword">on</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> o<span class="token punctuation">.</span>product_id
<span class="token keyword">where</span> order_date <span class="token operator">between</span> <span class="token string">'2020-06-01'</span> <span class="token operator">and</span> <span class="token string">'2020-07-31'</span> <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token keyword">having</span> total <span class="token operator">&gt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> tmp <span class="token keyword">group</span> <span class="token keyword">by</span> customer_id <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>看了这个，别人可能会想说。。。</p>
<p align="center">
	  <img src="https://img.gmz88.com/uploadimg/ico/2019/0912/1568251652240815.gif">
</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql8-3.png?raw=true">
</p>
<h3 id="span-id99.-customer-placing-the-largest-number-of-ordersspan"><span id="9">9. Customer Placing the Largest Number of Orders</span></h3>
<p>Query the  <strong>customer_number</strong>  from the  <strong><em>orders</em></strong>  table for the customer who has placed the largest number of orders.</p>
<p>It is guaranteed that exactly one customer will have placed more orders than any other customer.</p>
<p>The  <strong><em>orders</em></strong>  table is defined as follows:</p>

<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>order_number (PK)</td>
<td>int</td>
</tr>
<tr>
<td>customer_number</td>
<td>int</td>
</tr>
<tr>
<td>order_date</td>
<td>date</td>
</tr>
<tr>
<td>required_date</td>
<td>date</td>
</tr>
<tr>
<td>shipped_date</td>
<td>date</td>
</tr>
<tr>
<td>status</td>
<td>char(15)</td>
</tr>
<tr>
<td>comment</td>
<td>char(200)</td>
</tr>
</tbody>
</table><p><strong>Sample Input</strong></p>

<table>
<thead>
<tr>
<th>order_number</th>
<th>customer_number</th>
<th>order_date</th>
<th>required_date</th>
<th>shipped_date</th>
<th>status</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>2017-04-09</td>
<td>2017-04-13</td>
<td>2017-04-12</td>
<td>Closed</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>2017-04-15</td>
<td>2017-04-20</td>
<td>2017-04-18</td>
<td>Closed</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>2017-04-16</td>
<td>2017-04-25</td>
<td>2017-04-20</td>
<td>Closed</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>2017-04-18</td>
<td>2017-04-28</td>
<td>2017-04-25</td>
<td>Closed</td>
<td></td>
</tr>
</tbody>
</table><p><strong>Sample Output</strong></p>

<table>
<thead>
<tr>
<th>customer_number</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
</tr>
</tbody>
</table><p><strong>Explanation</strong></p>
<p>The customer with number ‘3’ has two orders, which is greater than either customer ‘1’ or ‘2’ because each of them  only has one order.<br>
So the result is customer_number ‘3’.</p>
<p>要注意，我们保证了只有一个消费者会比其他消费者下更多的单，也就是说我们不必担心会有多个消费者下了同样多的单，并且是最多的。</p>
<p>所以我们可以使用<code>limit</code>函数和<code>order by</code>函数对每个客户下单次数进行降序排序，并且取第一个，也就是最大的那个。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_number
<span class="token keyword">from</span> orders
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>  
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>order_number<span class="token punctuation">)</span> <span class="token keyword">desc</span>
<span class="token comment"># 针对每个消费者查找其下单次数，并降序排列</span>
<span class="token keyword">limit</span> <span class="token number">1</span> <span class="token comment"># 取第一个</span>
</code></pre>
<p><strong>Follow up:</strong>  What if more than one customer have the largest number of orders, can you find all the customer_number in this case?</p>
<p>如果面试官抛给了你这样的问题，你还会吗？</p>
<p>首先，降序排列找第一个这种策略已经不适用了，因为有可能出现好几个消费者都下了一样多的单，并且都是最多的，我们也不知道取前几个，这时会用到我们很常用的<strong>window function</strong>来辅助我们进行排序。</p>
<p>先来说一下window function的种类，我想下面这个图可以让你理解这三种排序函数的区别。</p>
<ul>
<li><code>row_number</code>返回从1开始的序列</li>
<li><code>rank</code>返回当前结果中每一个记录的排名</li>
<li><code>dense_rank</code>和<code>rank</code>很像，但是没有gap</li>
</ul>
<p align="center">
	  <img src="https://sqlversity.files.wordpress.com/2013/06/ranking-functions.png
">
</p>
<p>那么我们先对每个消费者的下单数进行降序排序</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_number<span class="token punctuation">,</span> 
	   rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
	   <span class="token comment"># 这里我们使用rank()函数，其实在查找排名第一的情况时，</span>
	   <span class="token comment"># dense_rank()和rank()其实没区别的</span>
<span class="token keyword">from</span> orders
</code></pre>
<p>先重新定义一下我们的输入：</p>
<p><code>{"headers":{"orders":["order_number","customer_number"]},"rows":{"orders":[[1,1],[2,2],[3,3],[4,3],[5,4],[6,4]]}}</code></p>
<p>可以看出，编号为3和4的消费者都下单了两次，并且是最多的。</p>
<p>根据上面的代码，我们得到结果如下：</p>
<p><code>{"headers": ["customer_number", "rnk"], "values": [[3, 1], [4, 1], [1, 3], [2, 3]]}</code></p>
<p>意思是<code>customer_id</code>为3和4的消费者下单量排名第一，那么其他的我们就不考虑了，因为我们只考虑排名第一的。</p>
<p>那么在这个基础上，我们要再从这个新表格里面筛选<code>customer_id</code>满足<code>rnk = 1</code>即可，使用subquery结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_number 
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
	<span class="token keyword">select</span> customer_number<span class="token punctuation">,</span> 
		   rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
	<span class="token keyword">from</span> orders
	<span class="token keyword">group</span> <span class="token keyword">by</span> customer_number
<span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># 这里要记得用alias哦!</span>
</code></pre>
<p>那么，我现在有一个很欠揍的问题，如果我不想找排名第一的了，我想找排名第二的，而且我也不保证会出现排名第二的消费者下单数都相同的情况哦！</p>
<p align="center">
	  <img src="http://wx4.sinaimg.cn/mw690/6a04b428ly1g19aktss1jg208w050b24.gif
">
</p>
<p align="center">
	  <img src="http://wx4.sinaimg.cn/mw690/6a04b428ly1g19aksio2hg208w050kgp.gif
">
</p>
<p>那么，拯救世界的任务就拜托你了！</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql9.png?raw=true">
</p>
<h3 id="span-id1010.-customers-who-never-orderspan"><span id="10">10. Customers Who Never Order</span></h3>
<p>咳咳，那么来点简单的划划水吧！</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql10-1.png?raw=true">
</p>
<p>这个题非常的straightforward，就是让我们找所有一毛不拔的顾客，什么都不买的人。</p>
<p>有人说：“见到两个table我就手痒，就想join怎么办？”</p>
<p>join归join，您先想清楚怎么join好伐，之前说过了 <code>inner join</code> 和 <code>left join</code> 的区别。那么既然我们要找没买东西的人，那就是要找两个table连到一起后，orders表格中的<code>Id</code>为<code>null</code>的人嘛！</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> Name <span class="token keyword">as</span> <span class="token string">'Customers'</span>
<span class="token keyword">from</span> customers <span class="token keyword">as</span> <span class="token string">'c'</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> orders <span class="token keyword">as</span> <span class="token string">'o'</span>
<span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span>Id <span class="token operator">=</span> o<span class="token punctuation">.</span>CustomerId
<span class="token keyword">where</span> o<span class="token punctuation">.</span>Id <span class="token operator">is</span> <span class="token boolean">null</span>
</code></pre>
<p>但是毕竟我们用了join，在跑大型数据集时时间还是会有些长，那么我又变成了坏人，能不能不用join呢？</p>
<p align="center">
	  <img src="http://wx2.sinaimg.cn/mw690/6a04b428ly1g19akufoa6g209q08amy7.gif
">
</p>
<p>那么便是筛选<code>Customers</code>表格中的不在<code>Orders</code>表格中的<code>CustomerId</code>中的<code>Id</code>呗。</p>
<p>Emmmmm我想你应该明白我的意思…</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> name <span class="token keyword">as</span> <span class="token string">'Customers'</span>
<span class="token keyword">from</span> customers
<span class="token keyword">where</span> id <span class="token operator">not</span> <span class="token operator">in</span> <span class="token comment"># not in 作为筛选条件也真的很常见了！</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> customerid <span class="token keyword">from</span> orders
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql10-2.png?raw=true">
</p>
<p>可以看到在不用join的情况下，速度还是快很多的！</p>
<h3 id="span-id1111.-delete-duplicate-emailsspan"><span id="11">11. Delete Duplicate Emails</span></h3>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql11-1.png?raw=true">
</p>
<p>我们要删除所有重复的邮件，并按照只保留<code>Id</code>的结果（如果重复的话）</p>
<p>首先，我们使用self join来满足下列两个条件：</p>
<ul>
<li><code>Email</code>相同</li>
<li>找到重复并且<code>Id</code>大的</li>
</ul>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> p1<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Person p1<span class="token punctuation">,</span>
     Person p2
<span class="token keyword">WHERE</span>
    p1<span class="token punctuation">.</span>Email <span class="token operator">=</span> p2<span class="token punctuation">.</span>Email 
    <span class="token comment"># Email相同</span>
    <span class="token operator">AND</span> 
    p1<span class="token punctuation">.</span>Id <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>Id
    <span class="token comment"># 这样保证我们找到了所有重复的email并且找出所有大于最小Id的结果</span>
<span class="token punctuation">;</span>
</code></pre>
<p>上面的结果就是我们要删除的，所以最终答案如下：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">delete</span> p1<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Person p1<span class="token punctuation">,</span>
     Person p2
<span class="token keyword">WHERE</span>
    p1<span class="token punctuation">.</span>Email <span class="token operator">=</span> p2<span class="token punctuation">.</span>Email 
    <span class="token operator">AND</span> 
    p1<span class="token punctuation">.</span>Id <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>Id
<span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql11-2.png?raw=true">
</p>
<h3 id="span-id1212.-duplicate-emailsspan"><span id="12">12. Duplicate Emails</span></h3>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql12-1.png?raw=true">
</p>
<p>这个题是不是很简单，就是要删除重复的邮件，直接上答案了，不会做的要加油啦！</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> Email 
<span class="token keyword">from</span> Person 
<span class="token keyword">group</span> <span class="token keyword">by</span> Email  
<span class="token comment"># 这个Email是Person表的Email这一列</span>
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>Email<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql12-2.png?raw=true">
</p>
<h3 id="span-id1313.-customers-who-never-orderspan"><span id="13">13. Customers Who Never Order</span></h3>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql13-1.png?raw=true">
</p>
<p>这个题比较简单，依旧考察大家对 join 和缺失值的运用，首先使用<code>left join</code>连接两表，在使用<code>where</code>设定题中所给的条件即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> name<span class="token punctuation">,</span> bonus
<span class="token keyword">from</span> Employee 
<span class="token keyword">left</span> <span class="token keyword">join</span> Bonus
<span class="token keyword">using</span> <span class="token punctuation">(</span>empId<span class="token punctuation">)</span>
<span class="token keyword">where</span> bonus <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token operator">or</span> bonus <span class="token operator">is</span> <span class="token boolean">null</span> 
<span class="token comment"># 要注意缺失值也要体现出来，如果没有写</span>
<span class="token comment"># bonus is null的话，是不会显示null的行的</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql13-2.png?raw=true">
</p>
<h3 id="span-id1414.-employees-earning-more-than-their-managersspan"><span id="14">14. Employees Earning More Than Their Managers</span></h3>
<p>The <code>Employee</code> table holds all employees including their managers. Every employee has an Id, and there is also a column for the manager Id.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----+-------+--------+-----------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> Name  <span class="token operator">|</span> Salary <span class="token operator">|</span> ManagerId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+--------+-----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Joe   <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Henry <span class="token operator">|</span> <span class="token number">80000</span>  <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Sam   <span class="token operator">|</span> <span class="token number">60000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> Max   <span class="token operator">|</span> <span class="token number">90000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+--------+-----------+</span>
</code></pre>
<p>Given the <code>Employee</code> table, write a SQL query that finds out employees who earn more than their managers. For the above table, Joe is the only employee who earns more than his manager.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> Employee <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> Joe      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
</code></pre>
<p>这个题算是比较经典的<code>self join</code>面试题了，目的是要找所有比自己经理工资更多的雇员。</p>
<p>我们看到了不是每个雇员都对应着经理，要注意这一点！</p>
<p>接下来我们用<code>self join</code>把表格自连接</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># cross join相当于求两个table的笛卡尔积</span>
<span class="token keyword">select</span> 
    <span class="token number">a</span><span class="token punctuation">.</span>Name <span class="token keyword">as</span> Employee
<span class="token keyword">from</span> 
    Employee <span class="token number">a</span><span class="token punctuation">,</span> Employee <span class="token number">b</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql14-1.png?raw=true">
</p>
<p>前四列来自表格a，后四列来自表格b。</p>
<p>那么接下来就要筛选满足下面两个条件的行：</p>
<ul>
<li><code>a.ManagerId = b.Id</code></li>
<li><code>a.Salary &gt; b.Salary</code></li>
</ul>
<p>你可能有疑问了，为啥不是<code>a.Id = b.ManagerId</code>呢？那不差不多么，其实差的十万八千里了，self join 是有顺序的就跟<code>left join</code>和<code>right join</code>一样，本质是一回事，但是哪么表格在前哪个表格在后，决定了连接方式。</p>
<p>首先，我们要取的<code>Name</code>这一列是来自于表格 a 的，那么这种情况下，表格 a <code>self join</code> 表格 b 说白了就是先取出表格 a 的第一行，然后跟表格 b 的每一行做比对，对这个<code>Employee</code>表格来说就有了四行，再取出表格 a 的第二行，再跟表格 b 的每一行做比对，又有四行，依次类推，总共就是 <code>4 x 4 = 16</code> 行。</p>
<p>所以，以这种比对方式，我们自然要筛选的是<code>a.ManagerId = b.Id</code>，<code>ManagerId</code>的缺失值可以因此被排除掉，我们只筛选<code>a.ManagerId = b.Id</code>且<code>a.ManagerId</code>存在的情况，反之，则没排除<code>a.ManagerId is null</code>的情况。</p>
<p>其实，如果我们要取的<code>Name</code>这一列是来自于表格 b 的，那么一切就都反过来了，条件自然是<code>a.Id = b.ManagerId</code>。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    <span class="token number">a</span><span class="token punctuation">.</span>Name <span class="token keyword">as</span> Employee
<span class="token keyword">from</span> 
    Employee <span class="token number">a</span><span class="token punctuation">,</span> Employee <span class="token number">b</span>
<span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>ManagerId <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>Id
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>Salary <span class="token operator">&gt;</span> <span class="token number">b</span><span class="token punctuation">.</span>Salary
</code></pre>
<p>或者</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
    <span class="token number">a</span><span class="token punctuation">.</span>Name <span class="token keyword">as</span> Employee
<span class="token keyword">from</span>
    Employee <span class="token keyword">as</span> <span class="token number">a</span>
<span class="token keyword">JOIN</span> 
	Employee <span class="token keyword">as</span> <span class="token number">b</span>
<span class="token keyword">ON</span> <span class="token number">a</span><span class="token punctuation">.</span>ManagerId <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>Id
<span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>Salary <span class="token operator">&gt;</span> <span class="token number">b</span><span class="token punctuation">.</span>Salary
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql14-2.png?raw=true">
</p>
<h3 id="span-id1515.-find-customer-refereespan"><span id="15">15. Find Customer Referee</span></h3>
<p>Given a table <code>customer</code> holding customers information and the referee.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------+------+-----------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> name <span class="token operator">|</span> referee_id<span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+-----------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> Will <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span> Jane <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span> Alex <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span> Bill <span class="token operator">|</span>      <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span> Zack <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">6</span> <span class="token operator">|</span> Mark <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+-----------+</span>
</code></pre>
<p>Write a query to return the list of customers  <strong>NOT</strong>  referred by the person with id ‘2’.</p>
<p>For the sample data above, the result is:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span> name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span> Will <span class="token operator">|</span>
<span class="token operator">|</span> Jane <span class="token operator">|</span>
<span class="token operator">|</span> Bill <span class="token operator">|</span>
<span class="token operator">|</span> Zack <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
</code></pre>
<p>我们要找到所有没有被<code>id = 2</code> refer的消费者。</p>
<p>那么所筛选的消费者要满足下列两个条件<strong>其中之一</strong>：</p>
<ul>
<li><code>referee_id != 2</code></li>
<li><code>referee_id is null</code></li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> name
	<span class="token keyword">from</span> customer
<span class="token keyword">where</span> 
	referee_id <span class="token operator">!=</span> <span class="token number">2</span> 
	<span class="token operator">or</span> 
	referee_id <span class="token operator">is</span> <span class="token boolean">NULL</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql15-1.png?raw=true">
</p>
<h3 id="span-id1616.-find-users-with-valid-e-mailsspan"><span id="16">16. Find Users With Valid E-Mails</span></h3>
<p>Table: <code>Users</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> user_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> mail          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>user_id is the primary key for this table.<br>
This table contains information of the users signed up in a website. Some e-mails are invalid.</p>
<p>Write an SQL query to find the users who have  <strong>valid emails</strong>.</p>
<p>A valid e-mail has a prefix name and a domain where:</p>
<ul>
<li><strong>The prefix name</strong>  is a string that may contain letters (upper or lower case), digits, underscore  <code>'_'</code>, period  <code>'.'</code>  and/or dash  <code>'-'</code>. The prefix name  <strong>must</strong>  start with a letter.</li>
<li><strong>The domain</strong>  is  <code>'@leetcode.com'</code>.</li>
</ul>
<p>Return the result table in any order.</p>
<p>The query result format is in the following example.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Users</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+-------------------------+</span>
<span class="token operator">|</span> user_id <span class="token operator">|</span> name      <span class="token operator">|</span> mail                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+-------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> Winston   <span class="token operator">|</span> winston<span class="token variable">@leetcode.com</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> Jonathan  <span class="token operator">|</span> jonathanisgreat         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> Annabelle <span class="token operator">|</span> bella<span class="token operator">-</span><span class="token variable">@leetcode.com</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> Sally     <span class="token operator">|</span> sally<span class="token punctuation">.</span>come<span class="token variable">@leetcode.com</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> Marwan    <span class="token operator">|</span> quarz<span class="token comment">#2020@leetcode.com |</span>
<span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span> David     <span class="token operator">|</span> david69<span class="token variable">@gmail.com</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>       <span class="token operator">|</span> Shapiro   <span class="token operator">|</span> <span class="token punctuation">.</span>shapo<span class="token variable">@leetcode.com</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+-------------------------+</span>

<span class="token comment"># Result table</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+-------------------------+</span>
<span class="token operator">|</span> user_id <span class="token operator">|</span> name      <span class="token operator">|</span> mail                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+-------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> Winston   <span class="token operator">|</span> winston<span class="token variable">@leetcode.com</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> Annabelle <span class="token operator">|</span> bella<span class="token operator">-</span><span class="token variable">@leetcode.com</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> Sally     <span class="token operator">|</span> sally<span class="token punctuation">.</span>come<span class="token variable">@leetcode.com</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+-------------------------+</span>

<span class="token comment"># The mail of user 2 doesn't have a domain.</span>
<span class="token comment"># The mail of user 5 has # sign which is not allowed.</span>
<span class="token comment"># The mail of user 6 doesn't have leetcode domain.</span>
<span class="token comment"># The mail of user 7 starts with a period.</span>
</code></pre>
<p>这里我们使用正则表达式来寻找特殊字符和结构来进行字符串匹配</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
	<span class="token keyword">FROM</span> Users
<span class="token keyword">WHERE</span> 
	mail <span class="token operator">REGEXP</span> <span class="token string">'^[A-Za-z][A-Za-z0-9_.-]*@leetcode.com$'</span>
</code></pre>
<ul>
<li><code>^[A-Za-z]</code>代表以 A 到 Z 或者 a 到 z 的字母开头的字符串</li>
<li><code>*</code>表示其前面必须有内容</li>
<li><code>$</code>表示以某字符串结尾</li>
</ul>
<p>所以最后 <code>'^[A-Za-z][A-Za-z0-9_.-]*@leetcode.com$'</code> 表示</p>
<ul>
<li>@leetcode.com作为结尾</li>
<li>@leetcode.com前面必须有内容</li>
<li>@leetcode.com前面的内容可以以任意大小写字母开头，里面可以包含任意大小写字母、0-9任何数字以及 <code>_</code>、<code>.</code> 、<code>-</code>。</li>
</ul>
<p>关于正则表达式在sql的使用，请看</p>
<ul>
<li><a href="https://www.geeksforgeeks.org/mysql-regular-expressions-regexp/">MySQL | Regular expressions (Regexp)</a></li>
<li><a href="https://www.guru99.com/regular-expressions.html">MYSQL Regular Expressions (REGEXP) with Syntax &amp; Examples</a></li>
<li><a href="https://blog.csdn.net/holandstone/article/details/77600272">SQL中LIKE模糊查询与REGEXP用法说明</a></li>
</ul>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql16.png?raw=true">
</p>
<h3 id="span-id1717.-find-the-team-sizespan"><span id="17">17. Find the Team Size</span></h3>
<p>Table:  <code>Employee</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> employee_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> team_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>employee_id is the primary key for this table.<br>
Each row of this table contains the ID of each employee and their respective team.</p>
<p>Write an SQL query to find the team size of each of the employees.</p>
<p>Return result table in any order.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Employee Table:</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> team_id    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+</span>
<span class="token operator">|</span>     <span class="token number">1</span>       <span class="token operator">|</span>     <span class="token number">8</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span>       <span class="token operator">|</span>     <span class="token number">8</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">3</span>       <span class="token operator">|</span>     <span class="token number">8</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">4</span>       <span class="token operator">|</span>     <span class="token number">7</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">5</span>       <span class="token operator">|</span>     <span class="token number">9</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">6</span>       <span class="token operator">|</span>     <span class="token number">9</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+</span>
<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> team_size  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+</span>
<span class="token operator">|</span>     <span class="token number">1</span>       <span class="token operator">|</span>     <span class="token number">3</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">2</span>       <span class="token operator">|</span>     <span class="token number">3</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">3</span>       <span class="token operator">|</span>     <span class="token number">3</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">4</span>       <span class="token operator">|</span>     <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">5</span>       <span class="token operator">|</span>     <span class="token number">2</span>      <span class="token operator">|</span>
<span class="token operator">|</span>     <span class="token number">6</span>       <span class="token operator">|</span>     <span class="token number">2</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+</span>
<span class="token comment"># Employees with Id 1,2,3 are part of a team with team_id = 8.</span>
<span class="token comment"># Employees with Id 4 is part of a team with team_id = 7.</span>
<span class="token comment"># Employees with Id 5,6 are part of a team with team_id = 9.</span>
</code></pre>
<p>我们要找到每个人对应的队伍里含有的总人数是多少，那么首先要根据每个<code>team_id</code>计算出各自队伍的人数是多少</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> team_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span>
<span class="token keyword">from</span> Employee
<span class="token keyword">group</span> <span class="token keyword">by</span> team_id
</code></pre>
<p>结果如下：</p>
<p><code>{"headers": ["team_id", "c"], "values": [[8, 3], [7, 1], [9, 2]]}</code></p>
<p>意味着我们得到了每个<code>team_id</code>对应的人数，那么我们只需要把这个结果和<code>Employee</code>表格再连接一下即可，就可以把<code>employee_id</code>和<code>c</code>（<code>c</code>作为<code>count(*)</code>的别名）联系起来。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	employee_id<span class="token punctuation">,</span> <span class="token number">c</span> <span class="token keyword">as</span> team_size
<span class="token keyword">from</span> 
	Employee
<span class="token keyword">join</span>
<span class="token punctuation">(</span>
	<span class="token keyword">select</span> 
		team_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span>
	<span class="token keyword">from</span> 
		Employee
	<span class="token keyword">group</span> <span class="token keyword">by</span> 
		team_id
<span class="token punctuation">)</span> tmp
<span class="token keyword">using</span> <span class="token punctuation">(</span>team_id<span class="token punctuation">)</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql17.png?raw=true">
</p>
<h3 id="span-id1818.-fix-product-name-formatspan"><span id="18">18. Fix Product Name Format</span></h3>
<p>Table: <code>Sales</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> sale_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> sale_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>sale_id</code> is the primary key for this table.</p>
<p>Each row of this table contains the product name and the date it was sold.</p>
<p>Since table Sales was filled manually in the year 2000, <code>product_name</code> may contain leading and/or trailing white spaces, also they are case-insensitive.</p>
<p>Write an SQL query to report</p>
<ul>
<li><code>product_name</code> in lowercase without leading or trailing white spaces.</li>
<li><code>sale_date</code> in the format <code>('YYYY-MM')</code></li>
<li><code>total</code> the number of times the product was sold in this month.</li>
</ul>
<p>Return the result table ordered by <code>product_name</code> in <strong>ascending order</strong>, in case of a tie order it by <code>sale_date</code> in <strong>ascending order</strong>.</p>
<p>The query result format is in the following example.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Sales</span>
<span class="token operator">+</span><span class="token comment">------------+------------------+--------------+</span>
<span class="token operator">|</span> sale_id    <span class="token operator">|</span> product_name     <span class="token operator">|</span> sale_date    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>      LCPHONE     <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span>    LCPhone       <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>     LcPhOnE      <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">18</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span>      LCKeyCHAiN  <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">19</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>          <span class="token operator">|</span>   LCKeyChain     <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">28</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>          <span class="token operator">|</span> Matryoshka       <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span>   <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">------------+------------------+--------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------+</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> sale_date    <span class="token operator">|</span> total    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------+</span>
<span class="token operator">|</span> lcphone      <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">01</span>      <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span>
<span class="token operator">|</span> lckeychain   <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">02</span>      <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> 
<span class="token operator">|</span> lcphone      <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">02</span>      <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> 
<span class="token operator">|</span> matryoshka   <span class="token operator">|</span> <span class="token number">2000</span><span class="token operator">-</span><span class="token number">03</span>      <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------+</span>
</code></pre>
<p>In January, 2 LcPhones were sold, please note that the product names are not case sensitive and may contain spaces.<br>
In Februery, 2 LCKeychains and 1 LCPhone were sold.<br>
In March, 1 matryoshka was sold.</p>
<p>这个题看似很复杂，其实我们只需要对基本的列进行转化再使用简单的<code>group by</code>就能得到答案。</p>
<p>我们筛选的结果要满足：</p>
<ul>
<li><code>product_name</code>是小写的，并且前面后面都没有空格</li>
<li><code>sale_date</code>以<code>('YYYY-MM')</code>出现</li>
<li><code>total</code>表示每个产品在这个月的销量</li>
</ul>
<p>这里我们用了<code>lower</code>函数使<code>product_name</code>小写，并用<a href="https://www.w3schools.com/sql/func_sqlserver_trim.asp"><code>trim</code></a>函数去掉字符串前面后面的空格；并且使用<a href="https://www.w3schools.com/sql/func_mysql_date_format.asp"><code>date_format</code></a>函数对日期进行转化，之前讲过了不再赘述。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	lower<span class="token punctuation">(</span>trim<span class="token punctuation">(</span>product_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'product_name'</span><span class="token punctuation">,</span>
	date_format<span class="token punctuation">(</span>sale_date<span class="token punctuation">,</span> <span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'sale_date'</span><span class="token punctuation">,</span>
	<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'total'</span>
<span class="token keyword">from</span>
	sales
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span> 
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment"># 这里的1和2指的是select里的第一列第二列 </span>
<span class="token comment"># 不能用alias代替</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql18.png?raw=true">
</p>
<h3 id="span-id1919.-friend-requests-i-overall-acceptance-ratespan"><span id="19">19. Friend Requests I: Overall Acceptance Rate</span></h3>
<p>In social network like Facebook or Twitter, people send friend requests and accept others’ requests as well. Now given two tables as below:</p>
<p>Table: <code>friend_request</code></p>

<table>
<thead>
<tr>
<th>sender_id</th>
<th>send_to_id</th>
<th>request_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2</td>
<td>2016-06-01</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2016-06-01</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>2016-06-01</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>2016-06-02</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-09</td>
</tr>
</tbody>
</table><p>Table: <code>request_accepted</code></p>

<table>
<thead>
<tr>
<th>requester_id</th>
<th>accepter_id</th>
<th>accept_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2</td>
<td>2016-06-03</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2016-06-08</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>2016-06-08</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-09</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-10</td>
</tr>
</tbody>
</table><p>Write a query to find the overall acceptance rate of requests rounded to 2 decimals, which is the number of acceptance divide the number of requests.</p>
<p>For the sample data above, your query should return the following result.</p>

<table>
<thead>
<tr>
<th>accept_rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.80</td>
</tr>
</tbody>
</table><p><strong>Note:</strong></p>
<ul>
<li>The accepted requests are not necessarily from the table  <code>friend_request</code>. In this case, you just need to simply count the total accepted requests (no matter whether they are in the original requests), and divide it by the number of requests to get the acceptance rate.</li>
<li>It is possible that a sender sends multiple requests to the same receiver, and a request could be accepted more than once. In this case, the ‘duplicated’ requests or acceptances are only counted once.</li>
<li>If there is no requests at all, you should return 0.00 as the accept_rate.</li>
</ul>
<p><strong>Explanation:</strong> There are 4 unique accepted requests, and there are 5 requests in total. So the rate is 0.80.</p>
<p><strong>Follow-up:</strong></p>
<ul>
<li><a href="#f1">Can you write a query to return the accept rate but for every month?</a></li>
<li><a href="#f2">How about the cumulative accept rate for every day?</a></li>
</ul>
<p>这个题很有意思，我会细讲这一题，这题考察我们以下几个点：</p>
<ul>
<li>对于一个人 A 发送给了另一个人 B 好多条好友申请，但是 B 只能接受一次，我们该咋办？</li>
<li>如果压根没有好友申请，我们要返回 0 而不是 null。</li>
<li>接受率保留两位小数。</li>
</ul>
<p>题中这种情况，我们发现有4条唯一被接受的申请，而总共5条申请，所以接受率为<code>0.80</code>。</p>
<p>所以，我们要用<code>count</code>和<code>distinct</code>函数分别数两个表中唯一存在的<code>(sender_id,send_to_id)</code>和<code>(requester_id,accepter_id)</code>的出现次数，并用后者除以前者即可，并且使用<code>ifnull</code>函数处理缺失值，<code>round</code>函数保留小数点后两位。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	ifnull<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">.</span><span class="token number">c</span> <span class="token operator">/</span> <span class="token number">a</span><span class="token punctuation">.</span><span class="token number">c</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> accept_rate
<span class="token keyword">from</span> 
    <span class="token punctuation">(</span><span class="token keyword">select</span> 
	    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> sender_id<span class="token punctuation">,</span> send_to_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span> 
	 <span class="token keyword">from</span> 
		 friend_request<span class="token punctuation">)</span> <span class="token number">a</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> 
	    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> requester_id<span class="token punctuation">,</span> accepter_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span> 
	 <span class="token keyword">from</span> 
		 request_accepted<span class="token punctuation">)</span> <span class="token number">b</span><span class="token punctuation">;</span>
<span class="token comment"># a和b作为两个table存在，分别数两个表中唯一存在的(sender_id,send_to_id)和(requester_id,accepter_id)的出现次数</span>
</code></pre>
<p>这种写法能清晰的体现出表格 a 和表格 b 都分别代表什么，比较推荐！</p>
<p>也有以下的写法：</p>
<ul>
<li>CTE</li>
</ul>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> 
<span class="token number">a</span> <span class="token keyword">as</span> 
    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> requester_id<span class="token punctuation">,</span> accepter_id<span class="token punctuation">)</span> <span class="token keyword">as</span> accepts
    <span class="token keyword">from</span> request_accepted<span class="token punctuation">)</span><span class="token punctuation">,</span>	
<span class="token number">b</span> <span class="token keyword">as</span> 
	<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> sender_id<span class="token punctuation">,</span> send_to_id<span class="token punctuation">)</span> <span class="token keyword">as</span> total 
	<span class="token keyword">from</span> friend_request<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span>ifnull<span class="token punctuation">(</span>accepts<span class="token operator">/</span>total<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> accept_rate <span class="token keyword">from</span> <span class="token number">a</span><span class="token punctuation">,</span> <span class="token number">b</span><span class="token punctuation">;</span>
<span class="token comment"># a和b作为两个table存在，分别数两个表中唯一存在的(sender_id,send_to_id)和(requester_id,accepter_id)的出现次数</span>
</code></pre>
<ul>
<li>标准答案</li>
</ul>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
<span class="token function">round</span><span class="token punctuation">(</span>
    ifnull<span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> requester_id<span class="token punctuation">,</span> accepter_id <span class="token keyword">from</span> request_accepted<span class="token punctuation">)</span> <span class="token keyword">as</span> A<span class="token punctuation">)</span>
    <span class="token operator">/</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> sender_id<span class="token punctuation">,</span> send_to_id <span class="token keyword">from</span> friend_request<span class="token punctuation">)</span> <span class="token keyword">as</span> B<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> accept_rate<span class="token punctuation">;</span>
</code></pre>
<p>那么面试官看你做到这里微微一笑，你此时意识到事情并没这么简单，第一个  follow up 来了！</p>
<p align="center">
	  <img src="http://wx2.sinaimg.cn/bmiddle/ceeb653ely1ghdt2fj8kbg208c08c4oe.gif
">
</p>
<p><strong><font color="#F39C12"><span id="f1">Follow up Question 1</span></font></strong></p>
<p>你能找出每个月对应的<code>accept_rate</code>吗？</p>
<p>你想了一想那不就<code>group by</code>一下就完事了吗？</p>
<p>在刚刚的代码基础上：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	ifnull<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">.</span><span class="token number">c</span> <span class="token operator">/</span> <span class="token number">a</span><span class="token punctuation">.</span><span class="token number">c</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> accept_rate<span class="token punctuation">,</span> <span class="token number">a</span><span class="token punctuation">.</span>month
<span class="token keyword">from</span> 
    <span class="token punctuation">(</span><span class="token keyword">select</span> 
	    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> sender_id<span class="token punctuation">,</span> send_to_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span><span class="token punctuation">,</span> 
	    month<span class="token punctuation">(</span>accept_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'month'</span>  <span class="token comment"># month函数可以将日期转换成月份</span>
	 <span class="token keyword">from</span> 
		 friend_request
	 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">a</span><span class="token punctuation">,</span>   <span class="token comment"># 这里group by是按每个月来数次数</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> 
	    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> requester_id<span class="token punctuation">,</span> accepter_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span><span class="token punctuation">,</span> month<span class="token punctuation">(</span>accept_date<span class="token punctuation">)</span>
	 <span class="token keyword">from</span> 
		 request_accepted
	 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">b</span><span class="token punctuation">;</span>
<span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>month <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>month <span class="token comment"># 这里默认了send和request在同一个月发生，否则分母为0</span>
</code></pre>
<p>但是可能出现假如只有一个人 A 给 B 在5月份发了邀请，但是 B 在 6 月份接受了邀请，那么这两个月的接受率都应该为 0；前者因为在5月没有人接受，后者因为6月没人发邀请。</p>
<p>那么我们改进后：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> date_table 
<span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> month<span class="token punctuation">(</span>request_date<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'month'</span> <span class="token keyword">FROM</span> friend_request
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> month<span class="token punctuation">(</span>accept_date<span class="token punctuation">)</span> <span class="token keyword">FROM</span> request_accepted
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> month<span class="token punctuation">)</span> <span class="token comment"># union 函数去除了重复值，return两列合并成一列的所有不重复月份</span>

<span class="token keyword">select</span> ifnull<span class="token punctuation">(</span>accept_rate<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> month <span class="token keyword">from</span>
date_table 
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token comment"># left join为了找到上述accept_rate可能为0的情况</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 
	ifnull<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">.</span><span class="token number">c</span> <span class="token operator">/</span> <span class="token number">a</span><span class="token punctuation">.</span><span class="token number">c</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> accept_rate<span class="token punctuation">,</span> <span class="token number">a</span><span class="token punctuation">.</span>month
<span class="token keyword">from</span> 
    <span class="token punctuation">(</span><span class="token keyword">select</span> 
	    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> sender_id<span class="token punctuation">,</span> send_to_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span><span class="token punctuation">,</span> 
	    month<span class="token punctuation">(</span>accept_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'month'</span>  <span class="token comment"># month函数可以将日期转换成月份</span>
	 <span class="token keyword">from</span> 
		 friend_request
	 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">a</span><span class="token punctuation">,</span>   <span class="token comment"># 这里group by是按每个月来数次数</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> 
	    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> requester_id<span class="token punctuation">,</span> accepter_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span><span class="token punctuation">,</span> month<span class="token punctuation">(</span>accept_date<span class="token punctuation">)</span>
	 <span class="token keyword">from</span> 
		 request_accepted
	 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">b</span><span class="token punctuation">;</span>
<span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>month <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>month<span class="token punctuation">)</span> tmp <span class="token comment"># 这里默认了send和request在同一个月发生，否则分母为0</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span>month<span class="token punctuation">)</span>
</code></pre>
<p>我们用以下数据实验一下：</p>
<p><code>{"headers":{"friend_request":["sender_id","send_to_id","request_date"],"request_accepted":["requester_id","accepter_id","accept_date"]},"rows":{"friend_request":[[1,2,"2016/05/01"],[1,3,"2016/06/01"],[1,4,"2016/06/01"],[2,3,"2016/07/02"],[3,4,"2016/06/09"]],"request_accepted":[[1,2,"2016/08/03"],[1,3,"2016/06/08"],[2,3,"2016/07/08"],[3,4,"2016/06/09"],[3,4,"2016/06/10"]]}}</code></p>
<p>Table: <code>friend_request</code></p>

<table>
<thead>
<tr>
<th>sender_id</th>
<th>send_to_id</th>
<th>request_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2</td>
<td><font color="red"><strong>2016-05-01</strong></font></td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2016-06-01</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>2016-06-01</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td><font color="red"><strong>2016-07-02</strong></font></td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-09</td>
</tr>
</tbody>
</table><p>Table: <code>request_accepted</code></p>

<table>
<thead>
<tr>
<th>requester_id</th>
<th>accepter_id</th>
<th>accept_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2</td>
<td><font color="red"><strong>2016-08-03</strong></font></td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2016-06-08</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td><font color="red"><strong>2016-07-08</strong></font></td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-09</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-10</td>
</tr>
</tbody>
</table><p>红色部分是跟原测试数据不一样，做了改动的，那么我们期待的是：</p>
<ul>
<li>五月：<code>accept_rate = 0.00</code>，因为5月只有人发送邀请但没人接受</li>
<li>六月：<code>accept_rate = 0.67</code>，因为有3个人发邀请，2个人接受</li>
<li>七月：<code>accept_rate = 1.00</code>，因为有1个人发邀请，1个人接受</li>
<li>八月：<code>accept_rate = 0.00</code>，因为8月虽然有1个人接受，但是没有人发邀请</li>
</ul>
<p><code>{"headers": ["ifnull(accept_rate,0)", "month"], "values": [[0.00, 5], [0.67, 6], [1.00, 7], [0.00, 8]]}</code></p>
<p>奈斯，结果正是我们预想的！</p>
<p>你以为结束了，这时面试官又微微一笑，又问了第二个问题。</p>
<p align="center">
	  <img src="http://wx1.sinaimg.cn/bmiddle/006I1bcHgy1gel55wttq0j30u00gw75v.jpg">
</p>
<p><strong><font color="#F39C12"><span id="f2">Follow up Question 2</span></font></strong></p>
<p>那么你能算出每一天的累计<code>accept_rate</code>吗？</p>
<p>区别在于我们要计算的是累计值</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> date_table <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> request_date <span class="token keyword">AS</span> dates <span class="token keyword">FROM</span> friend_request
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> accept_date <span class="token keyword">FROM</span> request_accepted
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> dates<span class="token punctuation">)</span><span class="token punctuation">,</span>

tmp <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> 
	<span class="token keyword">coalesce</span><span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> requester_id<span class="token punctuation">,</span> accepter_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> sender_id<span class="token punctuation">,</span> send_to_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rate<span class="token punctuation">,</span> 
	date_table<span class="token punctuation">.</span>dates
<span class="token keyword">FROM</span> 
	request_accepted <span class="token number">b</span><span class="token punctuation">,</span> friend_request <span class="token number">a</span><span class="token punctuation">,</span> date_table
<span class="token keyword">where</span> <span class="token number">b</span><span class="token punctuation">.</span>accept_date <span class="token operator">&lt;=</span> date_table<span class="token punctuation">.</span>dates
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>request_date <span class="token operator">&lt;=</span> date_table<span class="token punctuation">.</span>dates
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">2</span><span class="token punctuation">)</span> 

<span class="token keyword">select</span> ifnull<span class="token punctuation">(</span>rate<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'rates'</span><span class="token punctuation">,</span> dates
<span class="token keyword">from</span> date_table
<span class="token keyword">left</span> <span class="token keyword">join</span> tmp
<span class="token keyword">using</span> <span class="token punctuation">(</span>dates<span class="token punctuation">)</span>
</code></pre>
<p>这里要注意不能直接把两个表格直接<code>group by</code>数次数，因为我们要考虑当前时间下，我们的累计接受率，所以要加上条件</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">where</span> <span class="token number">b</span><span class="token punctuation">.</span>accept_date <span class="token operator">&lt;=</span> date_table<span class="token punctuation">.</span>dates
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>request_date <span class="token operator">&lt;=</span> date_table<span class="token punctuation">.</span>dates
</code></pre>
<p>在这样筛选所需的信息之后再根据<code>dates</code>来<code>group by</code>。</p>
<p>最后改过后的数据试验一下：</p>
<p>Table: <code>friend_request</code></p>

<table>
<thead>
<tr>
<th>sender_id</th>
<th>send_to_id</th>
<th>request_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2</td>
<td><font color="red"><strong>2016-05-01</strong></font></td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2016-06-01</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>2016-06-01</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td><font color="red"><strong>2016-07-02</strong></font></td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-09</td>
</tr>
</tbody>
</table><p>Table: <code>request_accepted</code></p>

<table>
<thead>
<tr>
<th>requester_id</th>
<th>accepter_id</th>
<th>accept_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2</td>
<td><font color="red"><strong>2016-08-03</strong></font></td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2016-06-08</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td><font color="red"><strong>2016-07-08</strong></font></td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-09</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>2016-06-10</td>
</tr>
</tbody>
</table><ul>
<li><code>2016-05-01</code>：<code>accept_rate = 0.00</code>，因为<code>2016-05-01</code>只有1人发送邀请但没人接受</li>
<li><code>2016-06-01</code>：<code>accept_rate = 0.00</code>，虽然累计有3个人发邀请，但没人接受</li>
<li><code>2016-06-08</code>：<code>accept_rate = 0.33</code>，因为有3个人发邀请，1个人接受</li>
<li><code>2016-06-09</code>：<code>accept_rate = 0.50</code>，因为有4个人发邀请，2个人接受</li>
<li><code>2016-06-10</code>：<code>accept_rate = 0.50</code>，因为有4个人发邀请，2个人接受（<code>2016-06-09</code>和<code>2016-06-10</code>重复接受了）</li>
<li><code>2016-07-02</code>：<code>accept_rate = 0.40</code>，因为有5个人发邀请，2个人接受</li>
<li><code>2016-07-08</code>：<code>accept_rate = 0.60</code>，因为有5个人发邀请，3个人接受</li>
<li><code>2016-08-03</code>：<code>accept_rate = 0.80</code>，因为有5个人发邀请，4个人接受</li>
</ul>
<p><code>{"headers": ["rates", "dates"], "values": [[0.00, "2016-05-01"], [0.00, "2016-06-01"], [0.33, "2016-06-08"], [0.50, "2016-06-09"], [0.50, "2016-06-10"], [0.40, "2016-07-02"], [0.60, "2016-07-08"], [0.80, "2016-08-03"]]}</code></p>
<p>完美！</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql19.png?raw=true">
</p>
<h3 id="span-id2020.-unique-orders-and-customers-per-monthspan"><span id="20">20. Unique Orders and Customers Per Month</span></h3>
<p>Table: <code>Orders</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> order_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> order_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> customer_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> invoice       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token comment"># order_id is the primary key for this table.</span>
<span class="token comment"># This table contains information about the orders made by customer_id.</span>
</code></pre>
<p>Write an SQL query to find the number of  <strong>unique orders</strong>  and the number of  <strong>unique customers</strong>  with invoices  <strong>&gt; $20</strong>  for each  <strong>different month</strong>.</p>
<p>Return the result table sorted in  <strong>any order</strong>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># orders</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------+------------+</span>
<span class="token operator">|</span> order_id <span class="token operator">|</span> order_date <span class="token operator">|</span> customer_id <span class="token operator">|</span> invoice    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">15</span> <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">30</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">17</span> <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">90</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">06</span> <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">20</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">20</span> <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">21</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">10</span> <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">10</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">15</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">55</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span>        <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">77</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>        <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">31</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span>       <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">15</span> <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">20</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+-------------+------------+</span>
<span class="token comment"># result</span>
<span class="token operator">+</span><span class="token comment">---------+-------------+----------------+</span>
<span class="token operator">|</span> month   <span class="token operator">|</span> order_count <span class="token operator">|</span> customer_count <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-------------+----------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span> <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">10</span> <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span> <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-------------+----------------+</span>
</code></pre>
<p><strong>Explanation:</strong></p>
<p>In September 2020 we have two orders from 2 different customers with invoices &gt; $20.</p>
<p>In October 2020 we have two orders from 1 customer, and only one of the two orders has invoice &gt; $20.</p>
<p>In November 2020 we have two orders from 2 different customers but invoices &lt; $20, so we don’t include that month.</p>
<p>In December 2020 we have two orders from 1 customer both with invoices &gt; $20.</p>
<p>In January 2021 we have two orders from 2 different customers, but only one of them with invoice &gt; $20.</p>
<p>这个题是个新题，虽然难度不高，但是对基本的语法和函数都起到了很好的练习作用，在简单类型题里面算是比较全面啦！</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    date_format<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span> <span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'month'</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> order_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'order_count'</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> customer_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'customer_count'</span>
<span class="token keyword">from</span> orders
<span class="token keyword">where</span> invoice <span class="token operator">&gt;</span> <span class="token number">20</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql20.png?raw=true">
</p>
<h3 id="span-id2121.-friendly-movies-streamed-last-monthspan"><span id="21">21. Friendly Movies Streamed Last Month</span></h3>
<p>Table: <code>TVProgram</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> program_date  <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> content_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> channel       <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(program_date, content_id)</code> is the primary key for this table.</p>
<p>This table contains information of the programs on the TV.</p>
<p><code>content_id</code> is the id of the program in some channel on the TV.</p>
<p>Table: <code>Content</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name      <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> content_id       <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> title            <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> Kids_content     <span class="token operator">|</span> <span class="token keyword">enum</span>    <span class="token operator">|</span>
<span class="token operator">|</span> content_type     <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
</code></pre>
<p><code>content_id</code> is the primary key for this table.</p>
<p><code>Kids_content</code> is an enum that takes one of the values (‘Y’, ‘N’) where:</p>
<ul>
<li>‘Y’ means is content for kids</li>
<li>‘N’ is not content for kids.</li>
</ul>
<p><code>content_type</code> is the category of the content as movies, series, etc.</p>
<p>Write an SQL query to report the distinct titles of the kid-friendly movies streamed in June 2020.</p>
<p>Return the result table in any order.</p>
<p>The query result format is in the following example.</p>
<pre class=" language-sql"><code class="prism  language-sql">TVProgram
<span class="token operator">+</span><span class="token comment">--------------------+--------------+-------------+</span>
<span class="token operator">|</span> program_date       <span class="token operator">|</span> content_id   <span class="token operator">|</span> channel     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+--------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">08</span>:<span class="token number">00</span>   <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> LC<span class="token operator">-</span>Channel  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">11</span> <span class="token number">12</span>:<span class="token number">00</span>   <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> LC<span class="token operator">-</span>Channel  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span>:<span class="token number">00</span>   <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> LC<span class="token operator">-</span>Channel  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">14</span>:<span class="token number">00</span>   <span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> Disney Ch   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">18</span> <span class="token number">14</span>:<span class="token number">00</span>   <span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> Disney Ch   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">16</span>:<span class="token number">00</span>   <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span> Disney Ch   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+--------------+-------------+</span>
Content
<span class="token operator">+</span><span class="token comment">------------+----------------+---------------+---------------+</span>
<span class="token operator">|</span> content_id <span class="token operator">|</span> title          <span class="token operator">|</span> Kids_content  <span class="token operator">|</span> content_type  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+----------------+---------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> Leetcode Movie <span class="token operator">|</span> N             <span class="token operator">|</span> Movies        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> Alg<span class="token punctuation">.</span> <span class="token keyword">for</span> Kids  <span class="token operator">|</span> Y             <span class="token operator">|</span> Series        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token keyword">Database</span> Sols  <span class="token operator">|</span> N             <span class="token operator">|</span> Series        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span> Aladdin        <span class="token operator">|</span> Y             <span class="token operator">|</span> Movies        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>          <span class="token operator">|</span> Cinderella     <span class="token operator">|</span> Y             <span class="token operator">|</span> Movies        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+----------------+---------------+---------------+</span>
Result
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> title        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> Aladdin      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
</code></pre>
<p><strong>Explaination：</strong></p>
<p>“Leetcode Movie” is not a content for kids.</p>
<p>“Alg. for Kids” is not a movie.</p>
<p>“Database Sols” is not a movie.</p>
<p>“Alladin” is a movie, content for kids and was streamed in June 2020.</p>
<p>“Cinderella” was not streamed in June 2020.</p>
<p>这个题比较常规，考察的是对表格连接以及筛选条件的使用，需要注意的是，我们可以在不<code>select</code>某一列的情况下，把其用在<code>where</code>里面作为筛选条件。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> title
<span class="token keyword">from</span> TVProgram <span class="token number">a</span>
<span class="token keyword">join</span> Content <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>content_id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>content_id
<span class="token operator">and</span> content_type <span class="token operator">=</span> <span class="token string">'Movies'</span>
<span class="token operator">and</span> Kids_content <span class="token operator">=</span> <span class="token string">'Y'</span>
<span class="token operator">and</span> program_date <span class="token operator">like</span> <span class="token string">'2020-06%'</span><span class="token punctuation">;</span> <span class="token comment"># like函数在字符串查找有很多的应用</span>
<span class="token comment"># and program_date between '2020-06-01' and '2020-06-30'</span>
<span class="token comment"># and date_format(program_date, '%Y-%m') = '2020-06'</span>
</code></pre>
<p>当然，写法不唯一，我们还有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> title
<span class="token keyword">from</span> TVProgram 
<span class="token keyword">join</span> Content 
<span class="token keyword">using</span> <span class="token punctuation">(</span>content_id<span class="token punctuation">)</span>
<span class="token keyword">where</span> content_type <span class="token operator">=</span> <span class="token string">'Movies'</span>
<span class="token operator">and</span> Kids_content <span class="token operator">=</span> <span class="token string">'Y'</span>
<span class="token operator">and</span> program_date <span class="token operator">like</span> <span class="token string">'2020-06%'</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql21.png?raw=true">
</p>
<h3 id="span-id2222.-game-play-analysis-ispan"><span id="22">22. Game Play Analysis I</span></h3>
<p>Table: <code>Activity</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> player_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> device_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> event_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> games_played <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>(player_id, event_date)</code>is the primary key of this table.</p>
<p>This table shows the activity of players of some game.</p>
<p>Each row is a record of a player who logged in and played a number of games (possibly 0) before logging out on some day using some device.</p>
<p>Write an SQL query that reports the <strong>first login date</strong>  for each player.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Activity table</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> player_id <span class="token operator">|</span> device_id <span class="token operator">|</span> event_date <span class="token operator">|</span> games_played <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">6</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>

<span class="token comment"># Result table</span>
<span class="token operator">+</span><span class="token comment">-----------+-------------+</span>
<span class="token operator">|</span> player_id <span class="token operator">|</span> first_login <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">25</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-------------+</span>
</code></pre>
<p>我们要找每个人的第一次登录日期，那么自然而然我们想到用 <code>window function</code>，<code>rank</code>或者<code>dense_rank</code>函数都是可以的，我们使用<code>rank</code>函数，这里注意我们用了<code>partition by</code>这一语句（有点像<code>group by</code>），之前我们仅仅用了<code>order by</code>这一语句，稍微说一下他们的作用：</p>
<ul>
<li>First, the  <code>PARTITION BY</code>  clause divides the rows of the result set partitions to which the function is applied.</li>
<li>Second, the  <code>ORDER BY</code>  clause specifies the logical sort order of the rows in each a partition to which the function is applied.</li>
</ul>
<p>强调一点，<code>window function</code>不能作为筛选条件直接使用到<code>where</code>等环境中，例如下面这种：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	player_id<span class="token punctuation">,</span> 
	event_date <span class="token keyword">as</span> first_login 
<span class="token keyword">from</span>
	activity
<span class="token keyword">where</span> rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id <span class="token keyword">order</span> <span class="token keyword">by</span> event_date <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p>这种写法会返回：</p>
<blockquote>
<p>You cannot use the window function ‘rank’ in this context.</p>
</blockquote>
<p>所以我们可以用 subquery 对把 <code>rank</code> 函数所形成的这一列所对应的别名（alias）进行筛选。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	player_id<span class="token punctuation">,</span> 
	event_date <span class="token keyword">as</span> first_login 
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 
	player_id<span class="token punctuation">,</span> 
	event_date<span class="token punctuation">,</span> 
	rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id <span class="token keyword">order</span> <span class="token keyword">by</span> event_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> activity<span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql22.png?raw=true">
</p>
<h3 id="span-id2323.-game-play-analysis--iispan"><span id="23">23. Game Play Analysis  II</span></h3>
<p>Table: <code>Activity</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> player_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> device_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> event_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> games_played <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>(player_id, event_date)</code> is the primary key of this table.</p>
<p>This table shows the activity of players of some game.</p>
<p>Each row is a record of a player who logged in and played a number of games (possibly 0) before logging out on some day using some device.</p>
<p>Write a SQL query that reports the  <strong>device</strong> that is first logged in for each player.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Activity table:</span>

<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> player_id <span class="token operator">|</span> device_id <span class="token operator">|</span> event_date <span class="token operator">|</span> games_played <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">6</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>

<span class="token comment"># Result table:</span>

<span class="token operator">+</span><span class="token comment">-----------+-----------+</span>
<span class="token operator">|</span> player_id <span class="token operator">|</span> device_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+</span>
</code></pre>
<p>这个题和上一题基本是一样的思路，都是使用了 window function，所以直接上答案了！</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	player_id<span class="token punctuation">,</span> device_id 
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> 
	player_id<span class="token punctuation">,</span> 
	device_id<span class="token punctuation">,</span> 
	rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id <span class="token keyword">order</span> <span class="token keyword">by</span> event_date <span class="token keyword">asc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> activity<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql23.png?raw=true">
</p>
<h3 id="span-id2424.-group-sold-products-by-the-datespan"><span id="24">24. Group Sold Products By The Date</span></h3>
<p>Table <code>Activities</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> sell_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> product     <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p>There is no primary key for this table, it may contains duplicates.</p>
<p>Each row of this table contains the product name and the date it was sold in a market.</p>
<p>Write an SQL query to find for each date, the number of distinct products sold and their names.</p>
<p>The sold-products names for each date should be sorted lexicographically.</p>
<p>Return the result table ordered by  <code>sell_date</code>.</p>
<p>The query result format is in the following example.</p>
<pre class=" language-sql"><code class="prism  language-sql">Activities <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">------------+-------------+</span>
<span class="token operator">|</span> sell_date  <span class="token operator">|</span> product     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> Headphone   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> Pencil      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> Mask        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> Basketball  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> Bible       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> Mask        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> T<span class="token operator">-</span>Shirt     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+</span>

Result <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">------------+----------+------------------------------+</span>
<span class="token operator">|</span> sell_date  <span class="token operator">|</span> num_sold <span class="token operator">|</span> products                     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+----------+------------------------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> Basketball<span class="token punctuation">,</span>Headphone<span class="token punctuation">,</span>T<span class="token operator">-</span>shirt <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> Bible<span class="token punctuation">,</span>Pencil                 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> Mask                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+----------+------------------------------+</span>
</code></pre>
<p>For 2020-05-30, Sold items were (Headphone, Basketball, T-shirt), we sort them lexicographically and separate them by comma.</p>
<p>For 2020-06-01, Sold items were (Pencil, Bible), we sort them lexicographically and separate them by comma.</p>
<p>For 2020-06-02, Sold item is (Mask), we just return it.</p>
<p>这里我要向大家介绍一个新的函数，就是 <a href="https://www.mysqltutorial.org/mysql-group_concat/"><code>group_concat</code></a>。这个函数是一个 <code>aggregation</code> 函数（聚合函数），是可以配合 <code>group by</code> 一起使用的，我们在这道题里不光要使用 <code>count</code> 函数，也要使用 <code>group_concat</code> 来将组中的字符串连接成单个字符串。</p>
<p>语法如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">GROUP_CONCAT<span class="token punctuation">(</span> 
	<span class="token keyword">DISTINCT</span> expression 
	<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> expression 
	SEPARATOR sep <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="
https://sp.mysqltutorial.org/wp-content/uploads/2013/05/MSQL-group_concat.png">
</p>
<p><strong>Explanation:</strong></p>
<p>The  <code>DISTINCT</code> clause allows you to eliminate duplicate values in the group before concatenating them.</p>
<p>The  <code>ORDER BY</code> clause allows you to sort the values in ascending or descending order before concatenating. By default, it sorts the values in ascending order. If you want to sort the values in the descending order, you need to specify explicitly the  <code>DESC</code>  option.</p>
<p>The  <code>SEPARATOR</code>  specifies a literal value inserted between values in the group. If you do not specify a separator, the  <code>GROUP_CONCAT</code>  function uses a comma (,) as the default separator.</p>
<p>The  <code>GROUP_CONCAT</code>  function ignores  <code>NULL</code>  values. It returns  <code>NULL</code>  if there was no matching row found or all arguments are  <code>NULL</code>  values.</p>
<p>The  <code>GROUP_CONCAT</code>  function returns a binary or non-binary string, which depends on the arguments. by default, the maximum length of the return string is 1024. In case you need more than this, you can extend the maximum length by setting the  <code>group_concat_max_len</code>  system variable at  <code>SESSION</code>  or  <code>GLOBAL</code>  level.</p>
<p>那么这道题我们只需要使用 <code>count</code> 和 <code>group_concat</code> 在加上 <code>group by</code>就可以解决了！</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	sell_date<span class="token punctuation">,</span> 
	<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> product<span class="token punctuation">)</span> <span class="token keyword">as</span> num_sold<span class="token punctuation">,</span>
    group_concat<span class="token punctuation">(</span><span class="token keyword">distinct</span> product <span class="token keyword">order</span> <span class="token keyword">by</span> product<span class="token punctuation">)</span> <span class="token keyword">as</span> products
    <span class="token comment"># group_concat取唯一的product，并且按product排序</span>
<span class="token keyword">from</span> activities 
<span class="token keyword">group</span> <span class="token keyword">by</span> sell_date
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql24.png?raw=true">
</p>
<h3 id="span-id2525.-immediate-food-delivery-ispan"><span id="25">25. Immediate Food Delivery I</span></h3>
<p>Table: <code>Delivery</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------------------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name                 <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+---------+</span>
<span class="token operator">|</span> delivery_id                 <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> customer_id                 <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> order_date                  <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> customer_pref_delivery_date <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+---------+</span>
</code></pre>
<p><code>delivery_id</code> is the primary key of this table.</p>
<p>The table holds information about food delivery to customers that make orders at some date and specify a preferred delivery date (on the same order date or after it).</p>
<p>If the preferred delivery date of the customer is the same as the order date then the order is called  <em>immediate</em> otherwise it’s called  <em>scheduled</em>.</p>
<p>Write an SQL query to find the percentage of immediate orders in the table, <strong>rounded to 2 decimal places</strong>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Delivery table:</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+------------+-----------------------------+</span>
<span class="token operator">|</span> delivery_id <span class="token operator">|</span> customer_id <span class="token operator">|</span> order_date <span class="token operator">|</span> customer_pref_delivery_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+------------+-----------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">11</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">11</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">24</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">26</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">22</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">11</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">13</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+------------+-----------------------------+</span>


<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">----------------------+</span>
<span class="token operator">|</span> immediate_percentage <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+</span>
<span class="token operator">|</span> <span class="token number">33.33</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+</span>
</code></pre>
<p>The orders with delivery id <code>2</code> and <code>3</code>are immediate while the others are scheduled.</p>
<p>这个题和第二题很相似，回顾一下<a href="#2">第二题</a>，我们通过遵循某个限定条件来计算某个值，这一类的题都很类似，在这里，我们要计算 <em>immediate</em> order 占所有 order 的比例，那么 <em>immediate</em> 的定义是什么呢？很简单，就是当 <code>order_date</code> 和 <code>customer_pref_delivery_date</code> 相等的时候对应的行。</p>
<p>那么思路就是把这些行数出来一共多少行，再除以总的行数，所以我们需要一种 <code>if</code> 函数来筛选并计数。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    <span class="token function">round</span><span class="token punctuation">(</span>  <span class="token comment"># round函数取小数点后两位</span>
    <span class="token number">100</span><span class="token operator">*</span> <span class="token comment"># 100*转化成百分数</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> order_date <span class="token operator">=</span> customer_pref_delivery_date <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>  
    <span class="token comment"># case when函数当条件成立时候，对目标进行操作（赋值、转换），注意end结尾！</span>
    <span class="token comment"># 这里我们一旦满足条件，次数就加1，sum起来就查出了一共满足条件有多少个</span>
	<span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
	<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> immediate_percentage
<span class="token keyword">from</span> delivery
</code></pre>
<p>也可写成：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    <span class="token function">round</span><span class="token punctuation">(</span>  <span class="token comment"># round函数取小数点后两位</span>
    <span class="token number">100</span><span class="token operator">*</span> <span class="token comment"># 100*转化成百分数</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_date <span class="token operator">=</span> customer_pref_delivery_date<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token comment"># if 和 case when 差不多，看个人喜好</span>
    <span class="token comment"># 我喜欢用if，因为不用担心最后没加end</span>
	<span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
	<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> immediate_percentage
<span class="token keyword">from</span> delivery
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql25.png?raw=true">
</p>
<h3 id="span-id2626.-list-the-products-ordered-in-a-periodspan"><span id="26">26. List the Products Ordered in a Period</span></h3>
<p>Table: <code>Products</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name      <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> product_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_name     <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> product_category <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
</code></pre>
<p><code>product_id</code> is the primary key for this table.</p>
<p>This table contains data about the company’s products.</p>
<p>Table: <code>Orders</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> product_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> order_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> unit          <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>There is no primary key for this table. It may have duplicate rows.</p>
<p><code>product_id</code> is a foreign key to Products table.</p>
<p><code>unit</code> is the number of products ordered in <code>order_date</code>.</p>
<p>Write an SQL query to get the names of products with greater than or equal to 100 units ordered in February 2020 and their amount.</p>
<p>Return result table in any order.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Products table:</span>
<span class="token operator">+</span><span class="token comment">-------------+-----------------------+------------------+</span>
<span class="token operator">|</span> product_id  <span class="token operator">|</span> product_name          <span class="token operator">|</span> product_category <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-----------------------+------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Leetcode Solutions    <span class="token operator">|</span> Book             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Jewels <span class="token keyword">of</span> Stringology <span class="token operator">|</span> Book             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> HP                    <span class="token operator">|</span> Laptop           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> Lenovo                <span class="token operator">|</span> Laptop           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span> Leetcode Kit          <span class="token operator">|</span> T<span class="token operator">-</span>shirt          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-----------------------+------------------+</span>

<span class="token comment"># Orders table:</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------+</span>
<span class="token operator">|</span> product_id   <span class="token operator">|</span> order_date   <span class="token operator">|</span> unit     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span>   <span class="token operator">|</span> <span class="token number">60</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">10</span>   <span class="token operator">|</span> <span class="token number">70</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">18</span>   <span class="token operator">|</span> <span class="token number">30</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">11</span>   <span class="token operator">|</span> <span class="token number">80</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">17</span>   <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">24</span>   <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span>   <span class="token operator">|</span> <span class="token number">20</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">04</span>   <span class="token operator">|</span> <span class="token number">30</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">04</span>   <span class="token operator">|</span> <span class="token number">60</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">25</span>   <span class="token operator">|</span> <span class="token number">50</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">27</span>   <span class="token operator">|</span> <span class="token number">50</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span>   <span class="token operator">|</span> <span class="token number">50</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">--------------------+---------+</span>
<span class="token operator">|</span> product_name       <span class="token operator">|</span> unit    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+---------+</span>
<span class="token operator">|</span> Leetcode Solutions <span class="token operator">|</span> <span class="token number">130</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Leetcode Kit       <span class="token operator">|</span> <span class="token number">100</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+---------+</span>
</code></pre>
<p><strong>Explanation:</strong></p>
<p>Products with <code>product_id = 1</code> is ordered in February a total of <code>(60 + 70) = 130</code>.</p>
<p>Products with <code>product_id = 2</code> is ordered in February a total of <code>80</code>.</p>
<p>Products with <code>product_id = 3</code> is ordered in February a total of <code>(2 + 3) = 5</code>.</p>
<p>Products with <code>product_id = 4</code> was not ordered in February 2020.</p>
<p>Products with <code>product_id = 5</code>is ordered in February a total of <code>(50 + 50) = 100</code>.</p>
<p>这道题不难，但是需要慢慢一步步的拆解，稍微复杂一点，细心一点肯定可以做出来，刷 sql 其实并不是要刷多难的题，而是在你拿到题的那一刻，你能快速的反应，找到解题思路，并有逻辑的表述出来。</p>
<p>我们要找到所有同时满足下列条件的产品名称和其数量</p>
<ul>
<li>在2020年2月下单的</li>
<li>下单数量大于等于100</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> product_name<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'unit'</span>
<span class="token keyword">from</span> products p
<span class="token keyword">join</span> orders o
<span class="token keyword">using</span> <span class="token punctuation">(</span>product_id<span class="token punctuation">)</span>
<span class="token keyword">where</span> order_date <span class="token operator">like</span> <span class="token string">'2020-02%'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">100</span>
</code></pre>
<p>其实顺着思路走，还是比较简单的，先连接表格，在筛选时间，最后 <code>group by</code> 加 <code>having</code> 筛选 <code>sum(unit) &gt;= 100</code> 的信息，结束！</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql26.png?raw=true">
</p>
<h3 id="span-id2727.-not-boring-moviesspan"><span id="27">27. Not Boring Movies</span></h3>
<p>X city opened a new cinema, many people would like to go to this cinema. The cinema also gives out a poster indicating the movies’ ratings and descriptions.</p>
<p>Please write a SQL query to output movies with an odd numbered ID and a description that is not ‘boring’. Order the result by rating.</p>
<p>For example, table <code>cinema</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+-----------+--------------+-----------+</span>
<span class="token operator">|</span>   id    <span class="token operator">|</span> movie     <span class="token operator">|</span>  description <span class="token operator">|</span>  rating   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+--------------+-----------+</span>
<span class="token operator">|</span>   <span class="token number">1</span>     <span class="token operator">|</span> War       <span class="token operator">|</span>   great 3D   <span class="token operator">|</span>   <span class="token number">8.9</span>     <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">2</span>     <span class="token operator">|</span> Science   <span class="token operator">|</span>   fiction    <span class="token operator">|</span>   <span class="token number">8.5</span>     <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">3</span>     <span class="token operator">|</span> irish     <span class="token operator">|</span>   boring     <span class="token operator">|</span>   <span class="token number">6.2</span>     <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4</span>     <span class="token operator">|</span> Ice song  <span class="token operator">|</span>   Fantacy    <span class="token operator">|</span>   <span class="token number">8.6</span>     <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">5</span>     <span class="token operator">|</span> House card<span class="token operator">|</span>   Interesting<span class="token operator">|</span>   <span class="token number">9.1</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+--------------+-----------+</span>
</code></pre>
<p>For the example above, the output should be:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+-----------+--------------+-----------+</span>
<span class="token operator">|</span>   id    <span class="token operator">|</span> movie     <span class="token operator">|</span>  description <span class="token operator">|</span>  rating   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+--------------+-----------+</span>
<span class="token operator">|</span>   <span class="token number">5</span>     <span class="token operator">|</span> House card<span class="token operator">|</span>   Interesting<span class="token operator">|</span>   <span class="token number">9.1</span>     <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span>     <span class="token operator">|</span> War       <span class="token operator">|</span>   great 3D   <span class="token operator">|</span>   <span class="token number">8.9</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+-----------+--------------+-----------+</span>
</code></pre>
<p>这个题比较简单，用的都是基本的语法，其中筛选奇数的<code>id</code>我们使用了<a href="https://www.w3schools.com/sql/func_mysql_mod.asp"><code>mod</code></a>函数。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> cinema
<span class="token keyword">where</span> description <span class="token operator">!=</span> <span class="token string">'boring'</span>
<span class="token operator">and</span> mod<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> rating <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql27.png?raw=true">
</p>
<h3 id="span-id2828.-project-employees-iispan"><span id="28">28. Project Employees II</span></h3>
<p>Table: <code>Project</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> project_id  <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p><code>(project_id, employee_id)</code> is the primary key of this table.</p>
<p><code>employee_id</code> is a foreign key to <code>Employee</code> table.</p>
<p>Table: <code>Employee</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name      <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> employee_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name             <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> experience_years <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
</code></pre>
<p><code>employee_id</code> is the primary key of this table.</p>
<p>Write an SQL query that reports all the  <strong>projects</strong> that have the most employees.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Project table</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
<span class="token operator">|</span> project_id  <span class="token operator">|</span> employee_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+</span>

<span class="token comment"># Employee table</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+------------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> name   <span class="token operator">|</span> experience_years <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Khaled <span class="token operator">|</span> <span class="token number">3</span>                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Ali    <span class="token operator">|</span> <span class="token number">2</span>                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> John   <span class="token operator">|</span> <span class="token number">1</span>                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> Doe    <span class="token operator">|</span> <span class="token number">2</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+------------------+</span>

<span class="token comment"># result table</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> project_id  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token comment"># The first project has 3 employees while the second one has 2.</span>
</code></pre>
<p>这种类型的题已经做过很多次了，还是使用 window function 来解决，注意使用 subquery 加上 where 条件来解。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	project_id 
<span class="token keyword">from</span>
	<span class="token punctuation">(</span><span class="token keyword">select</span> 
		project_id<span class="token punctuation">,</span> 
		dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk 
		<span class="token comment"># 一定要记住 rank / dense_rank 的语法！</span>
	<span class="token keyword">from</span> project
	<span class="token keyword">group</span> <span class="token keyword">by</span> project_id<span class="token punctuation">)</span> <span class="token keyword">as</span> t
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql28.png?raw=true">
</p>
<h3 id="span-id2929.-customer-who-visited-but-did-not-make-any-transactionsspan"><span id="29">29. Customer Who Visited but Did Not Make Any Transactions</span></h3>
<p>Table: <code>Visits</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> visit_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p><code>visit_id</code> is the primary key for this table.</p>
<p>This table contains information about the customers who visited the mall.</p>
<p>Table: <code>Transactions</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name    <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> transaction_id <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> visit_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> amount         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
</code></pre>
<p><code>transaction_id</code> is the primary key for this table.</p>
<p>This table contains information about the customers who visited the mall.</p>
<p>Write an SQL query to find the IDs of the users who visited without making any transactions and the number of times they made these types of visits.</p>
<p>Return the result table sorted in  <strong>any order</strong>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Visits</span>
<span class="token operator">+</span><span class="token comment">----------+-------------+</span>
<span class="token operator">|</span> visit_id <span class="token operator">|</span> customer_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">23</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">9</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span> <span class="token number">30</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span> <span class="token number">54</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>        <span class="token operator">|</span> <span class="token number">96</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>        <span class="token operator">|</span> <span class="token number">54</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span>        <span class="token operator">|</span> <span class="token number">54</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------------+</span>

<span class="token comment"># Transactions</span>
<span class="token operator">+</span><span class="token comment">----------------+----------+--------+</span>
<span class="token operator">|</span> transaction_id <span class="token operator">|</span> visit_id <span class="token operator">|</span> amount <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+----------+--------+</span>
<span class="token operator">|</span> <span class="token number">2</span>              <span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span> <span class="token number">310</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>              <span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span> <span class="token number">300</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>              <span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span> <span class="token number">200</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">12</span>             <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">910</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">13</span>             <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">970</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+----------+--------+</span>

<span class="token comment"># Result table</span>
<span class="token operator">+</span><span class="token comment">-------------+----------------+</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span> count_no_trans <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+----------------+</span>
<span class="token operator">|</span> <span class="token number">54</span>          <span class="token operator">|</span> <span class="token number">2</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">30</span>          <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">96</span>          <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+----------------+</span>
</code></pre>
<p><strong>Explainantion:</strong></p>
<p>Customer with id = 23 visited the mall once and made one transaction during the visit with id = 12.</p>
<p>Customer with id = 9 visited the mall once and made one transaction during the visit with id = 13.</p>
<p>Customer with id = 30 visited the mall once and did not make any transactions.</p>
<p>Customer with id = 54 visited the mall three times. During 2 visits they did not make any transactions, and during one visit they made 3 transactions.</p>
<p>Customer with id = 96 visited the mall once and did not make any transactions.</p>
<p>As we can see, users with IDs 30 and 96 visited the mall one time without making any transactions. Also user 54 visited the mall twice and did not make any transactions.</p>
<p>本题是新题，但是比较简单，不过多讲解了，不过要注意一下几点：</p>
<ul>
<li>注意表格连接方法的使用</li>
<li>对缺失值的处理</li>
<li>group by 的使用</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	customer_id<span class="token punctuation">,</span> 
	<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> count_no_trans
<span class="token keyword">from</span> visits v
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token keyword">transactions</span> t
<span class="token keyword">using</span> <span class="token punctuation">(</span>visit_id<span class="token punctuation">)</span>
<span class="token keyword">where</span> t<span class="token punctuation">.</span>visit_id <span class="token operator">is</span> <span class="token boolean">null</span> 
<span class="token comment"># 这里要注意是筛选哪一个表中的visit_id为null</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql29.png?raw=true">
</p>
<h3 id="span-id3030.-queries-quality-and-percentagespan"><span id="30">30. Queries Quality and Percentage</span></h3>
<p>Table: <code>Queries</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> query_name  <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> result      <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> position    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> rating      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p>There is no primary key for this table, it may have duplicate rows.<br>
This table contains information collected from some queries on a database.</p>
<p>The <code>position</code> column has a value from <strong>1</strong> to <strong>500</strong>.</p>
<p>The <code>rating</code> column has a value from <strong>1</strong> to <strong>5</strong>. Query with <code>rating</code> less than 3 is a poor query.</p>
<p>We define query  <code>quality</code>  as:</p>
<blockquote>
<p>The average of the ratio between query rating and its position.</p>
</blockquote>
<p>We also define  <code>poor query percentage</code>  as:</p>
<blockquote>
<p>The percentage of all queries with rating less than 3.</p>
</blockquote>
<p>Write an SQL query to find each <code>query_name</code>, the  <code>quality</code>  and  <code>poor_query_percentage</code>.</p>
<p>Both  <code>quality</code>  and  <code>poor_query_percentage</code>  should be  <strong>rounded to 2 decimal places</strong>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># queries table</span>
<span class="token operator">+</span><span class="token comment">------------+-------------------+----------+--------+</span>
<span class="token operator">|</span> query_name <span class="token operator">|</span> result            <span class="token operator">|</span> position <span class="token operator">|</span> rating <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------------+----------+--------+</span>
<span class="token operator">|</span> Dog        <span class="token operator">|</span> Golden Retriever  <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">5</span>      <span class="token operator">|</span>
<span class="token operator">|</span> Dog        <span class="token operator">|</span> German Shepherd   <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">5</span>      <span class="token operator">|</span>
<span class="token operator">|</span> Dog        <span class="token operator">|</span> Mule              <span class="token operator">|</span> <span class="token number">200</span>      <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">|</span> Cat        <span class="token operator">|</span> Shirazi           <span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span>
<span class="token operator">|</span> Cat        <span class="token operator">|</span> Siamese           <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">3</span>      <span class="token operator">|</span>
<span class="token operator">|</span> Cat        <span class="token operator">|</span> Sphynx            <span class="token operator">|</span> <span class="token number">7</span>        <span class="token operator">|</span> <span class="token number">4</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------------+----------+--------+</span>

<span class="token comment"># Result table</span>
<span class="token operator">+</span><span class="token comment">------------+---------+-----------------------+</span>
<span class="token operator">|</span> query_name <span class="token operator">|</span> quality <span class="token operator">|</span> poor_query_percentage <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------+-----------------------+</span>
<span class="token operator">|</span> Dog        <span class="token operator">|</span> <span class="token number">2.50</span>    <span class="token operator">|</span> <span class="token number">33.33</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Cat        <span class="token operator">|</span> <span class="token number">0.66</span>    <span class="token operator">|</span> <span class="token number">33.33</span>                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------+-----------------------+</span>
</code></pre>
<p><strong>Explaination:</strong></p>
<p>Dog queries quality is ((5 / 1) + (5 / 2) + (1 / 200)) / 3 = 2.50<br>
Dog queries poor_ query_percentage is (1 / 3) * 100 = 33.33</p>
<p>Cat queries quality equals ((2 / 5) + (3 / 3) + (4 / 7)) / 3 = 0.66<br>
Cat queries poor_ query_percentage is (1 / 3) * 100 = 33.33</p>
<p>根据描述，我们知道要去求出每个<code>query_name</code>对应的<code>rating/position</code>的平均值，并命名为<code>quality</code>，再求出每个<code>query_name</code>对应的<code>rating &lt; 3</code>的比率。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    query_name<span class="token punctuation">,</span>
    <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">AVG</span><span class="token punctuation">(</span>rating<span class="token operator">/</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> quality<span class="token punctuation">,</span>
    <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">AVG</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>rating <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> poor_query_percentage
    <span class="token comment"># if 也可以用 case when</span>
<span class="token keyword">from</span> 
    queries
<span class="token keyword">group</span> <span class="token keyword">by</span> query_name
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql30.png?raw=true">
</p>
<h3 id="span-id3131.-reformat-department-tablespan"><span id="31">31. Reformat Department Table</span></h3>
<p>Table: <code>Department</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> revenue       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> month         <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(id, month)</code> is the primary key of this table.</p>
<p>The table has information about the revenue of each department per month.</p>
<p>The month has values in <code>["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]</code>.</p>
<p>Write an SQL query to reformat the table such that there is a department id column and a revenue column  <strong>for each month</strong>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Department table:</span>
<span class="token operator">+</span><span class="token comment">------+---------+-------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> revenue <span class="token operator">|</span> month <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+-------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> <span class="token number">8000</span>    <span class="token operator">|</span> Jan   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> <span class="token number">9000</span>    <span class="token operator">|</span> Jan   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> <span class="token number">10000</span>   <span class="token operator">|</span> Feb   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> <span class="token number">7000</span>    <span class="token operator">|</span> Feb   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> <span class="token number">6000</span>    <span class="token operator">|</span> Mar   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+-------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">------+-------------+-------------+-------------+-----+-------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> Jan_Revenue <span class="token operator">|</span> Feb_Revenue <span class="token operator">|</span> Mar_Revenue <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span> Dec_Revenue <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-------------+-------------+-------------+-----+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> <span class="token number">8000</span>        <span class="token operator">|</span> <span class="token number">7000</span>        <span class="token operator">|</span> <span class="token number">6000</span>        <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span> <span class="token boolean">null</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> <span class="token number">9000</span>        <span class="token operator">|</span> <span class="token boolean">null</span>        <span class="token operator">|</span> <span class="token boolean">null</span>        <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span> <span class="token boolean">null</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> <span class="token boolean">null</span>        <span class="token operator">|</span> <span class="token number">10000</span>       <span class="token operator">|</span> <span class="token boolean">null</span>        <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span> <span class="token boolean">null</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-------------+-------------+-------------+-----+-------------+</span>
</code></pre>
<p>Note that the result table has 13 columns (1 for the department id + 12 for the months).</p>
<p>这个题比较新颖，并不是简单的筛选条件，而是对表格做转换，类似于 pivot table。</p>
<p>那么我们要做的就是针对每个 id，对应某个月份，找到对应的 revenue。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Jan'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Jan_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Feb'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Feb_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Mar'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Mar_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Apr'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Apr_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'May'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> May_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Jun'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Jun_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Jul'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Jul_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Aug'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Aug_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Sep'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Sep_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Oct'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Oct_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Nov'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Nov_Revenue <span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> month <span class="token operator">=</span> <span class="token string">'Dec'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">NULL</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Dec_Revenue 
<span class="token keyword">from</span> Department 
<span class="token keyword">group</span> <span class="token keyword">by</span> id
</code></pre>
<p>注意这里的 sum 其实可以换成其他的 aggregation 函数，因为此时我们只是为了使用 group by 函数。</p>
<p>此时，每个月每个 id 对应的 revenue 是唯一的，所以加上任何的 aggregation 函数都不会影响结果，当然这里的 case when 可以换成 if 函数。</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql31.png?raw=true">
</p>
<h3 id="span-id3232.-rising-temperaturespan"><span id="32">32. Rising Temperature</span></h3>
<p>Table: <code>Weather</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> recordDate    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> temperature   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>id</code> is the primary key for this table.</p>
<p>This table contains information about the temperature in a certain day.</p>
<p>Write an SQL query to find all dates’  <code>id</code> with higher temperature compared to its previous dates (yesterday).</p>
<p>Return the result table in  <strong>any order</strong>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Weather</span>
<span class="token operator">+</span><span class="token comment">----+------------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> recordDate <span class="token operator">|</span> Temperature <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">2015</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">10</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> <span class="token number">2015</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">25</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> <span class="token number">2015</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">20</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> <span class="token number">2015</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">04</span> <span class="token operator">|</span> <span class="token number">30</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+-------------+</span>
<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span> id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span>
</code></pre>
<p>In 2015-01-02, temperature was higher than the previous day (10 -&gt; 25).<br>
In 2015-01-04, temperature was higher than the previous day (30 -&gt; 20).</p>
<p>这个题目有点难度，在于以下两点：</p>
<ul>
<li>如何将表格里的内容进行行内比对？</li>
<li>如何找到所有跟前一天相比，温度更高的 id？</li>
</ul>
<p>其实我们已经接触并熟悉了 self join 的使用了，作用就是自己跟自己进行比对，再根据一定的条件进行筛选。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	tb2<span class="token punctuation">.</span>Id <span class="token comment"># 在使用self join时，我们一定要注意取的是哪个表里的数据</span>
<span class="token keyword">from</span> 
	Weather tb1
<span class="token keyword">join</span> 
	Weather tb2 
<span class="token keyword">on</span> datediff<span class="token punctuation">(</span>tb2<span class="token punctuation">.</span>RecordDate<span class="token punctuation">,</span> tb1<span class="token punctuation">.</span>RecordDate<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> 
<span class="token comment"># The DATEDIFF() function returns the difference between two dates.</span>
<span class="token comment"># 请参考：https://www.w3schools.com/sql/func_sqlserver_datediff.asp</span>
<span class="token operator">and</span> tb2<span class="token punctuation">.</span>Temperature <span class="token operator">&gt;</span> tb1<span class="token punctuation">.</span>Temperature
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql32.png?raw=true">
</p>
<h3 id="span-id3333.-sales-analysis-ispan"><span id="33">33. Sales Analysis I</span></h3>
<p>Table: <code>Product</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> product_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> unit_price   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>product_id</code> is the primary key of this table.</p>
<p>Table: <code>Sales</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> seller_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_id  <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> buyer_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> sale_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> quantity    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> price       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------ ------+---------+</span>
</code></pre>
<p>This table has no primary key, it can have repeated rows.</p>
<p><code>product_id</code> is a foreign key to Product table.</p>
<p>Write an SQL query that reports the best <strong>seller</strong> by total sales price, If there is a tie, report them all.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Product table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> product_name <span class="token operator">|</span> unit_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> S8           <span class="token operator">|</span> <span class="token number">1000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> G4           <span class="token operator">|</span> <span class="token number">800</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> iPhone       <span class="token operator">|</span> <span class="token number">1400</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>

<span class="token comment"># Sales table:</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>
<span class="token operator">|</span> seller_id <span class="token operator">|</span> product_id <span class="token operator">|</span> buyer_id <span class="token operator">|</span> sale_date  <span class="token operator">|</span> quantity <span class="token operator">|</span> price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">17</span> <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">800</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">800</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">13</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2800</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> seller_id   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p>Both sellers with id 1 and 3 sold products with the most total price of 2800.</p>
<p>通过解释，我们知道要找每个 <code>seller_id</code> 对应的总销售额，并筛选出总销售额最大的 <code>seller_id</code>，如果有一样的，就都筛选出来。</p>
<p>所以我们需要使用：</p>
<ul>
<li>group by</li>
<li>rank</li>
<li>subquery</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> seller_id <span class="token keyword">from</span>
<span class="token punctuation">(</span>
<span class="token keyword">select</span> 
	seller_id<span class="token punctuation">,</span>
	rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
	<span class="token comment"># 注意 rank 函数语法，以及在subquery中的使用</span>
<span class="token keyword">from</span>
	product
<span class="token keyword">join</span> 
	sales
<span class="token keyword">using</span> <span class="token punctuation">(</span>product_id<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span> 
<span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql33.png?raw=true">
</p>
<h3 id="span-id3434.-sales-analysis-iispan"><span id="34">34. Sales Analysis II</span></h3>
<p>Table: <code>Product</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> product_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> unit_price   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>product_id</code> is the primary key of this table.</p>
<p>Table: <code>Sales</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> seller_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_id  <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> buyer_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> sale_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> quantity    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> price       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------ ------+---------+</span>
</code></pre>
<p>This table has no primary key, it can have repeated rows.</p>
<p><code>product_id</code> is a foreign key to Product table.</p>
<p>Write an SQL query that reports the  <strong>buyers</strong>  who have bought  <em>S8</em>  but not  <em>iPhone</em>. Note that  <em>S8</em>  and  <em>iPhone</em>  are products present in the  <code>Product</code>  table.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Product table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> product_name <span class="token operator">|</span> unit_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> S8           <span class="token operator">|</span> <span class="token number">1000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> G4           <span class="token operator">|</span> <span class="token number">800</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> iPhone       <span class="token operator">|</span> <span class="token number">1400</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>

<span class="token comment"># Sales table:</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>
<span class="token operator">|</span> seller_id <span class="token operator">|</span> product_id <span class="token operator">|</span> buyer_id <span class="token operator">|</span> sale_date  <span class="token operator">|</span> quantity <span class="token operator">|</span> price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">17</span> <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">800</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">800</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">13</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2800</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> buyer_id    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p>The buyer with id 1 bought an S8 but didn’t buy an iPhone. The buyer with id 3 bought both.</p>
<p>通过解释，我们要找到所有的 <code>buyer_id</code> <strong>同时满足</strong>：</p>
<ul>
<li>购买 S8</li>
<li>没买 iPhone</li>
</ul>
<p>那么我们可以找出每个 <code>buyer_id</code> 对应的 S8 和 iPhone 的购买量分别是多少，并满足购买 S8 的数量大于 0，并且购买 iPhone 的数量等于 0。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> buyer_id <span class="token keyword">from</span>
<span class="token punctuation">(</span>
<span class="token keyword">select</span> 
    buyer_id<span class="token punctuation">,</span> 
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'S8'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'s8'</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'iPhone'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'iPhone'</span>
    <span class="token comment"># 以上两个sum if语句计算出每个buyer_id对应购买两种产品的数量</span>
<span class="token keyword">from</span> product
<span class="token keyword">join</span> sales
<span class="token keyword">using</span> <span class="token punctuation">(</span>product_id<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> s8 <span class="token operator">&gt;</span> <span class="token number">0</span> 
<span class="token operator">and</span> iPhone <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql34.png?raw=true">
</p>
<h3 id="span-id3535.-sales-analysis-iiispan"><span id="35">35. Sales Analysis III</span></h3>
<p>Table: <code>Product</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> product_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> unit_price   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>product_id</code> is the primary key of this table.</p>
<p>Table: <code>Sales</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> seller_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_id  <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> buyer_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> sale_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> quantity    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> price       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------ ------+---------+</span>
</code></pre>
<p>This table has no primary key, it can have repeated rows.</p>
<p><code>product_id</code> is a foreign key to Product table.</p>
<p>Write an SQL query that reports the  <strong>products</strong> that were  <strong>only</strong> sold in spring 2019. That is, between <strong>2019-01-01</strong>  and  <strong>2019-03-31</strong>  inclusive.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Product table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> product_name <span class="token operator">|</span> unit_price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> S8           <span class="token operator">|</span> <span class="token number">1000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> G4           <span class="token operator">|</span> <span class="token number">800</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> iPhone       <span class="token operator">|</span> <span class="token number">1400</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+------------+</span>

<span class="token comment"># Sales table:</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>
<span class="token operator">|</span> seller_id <span class="token operator">|</span> product_id <span class="token operator">|</span> buyer_id <span class="token operator">|</span> sale_date  <span class="token operator">|</span> quantity <span class="token operator">|</span> price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">17</span> <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">800</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">800</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">13</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2800</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------+------------+----------+-------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
<span class="token operator">|</span> product_id  <span class="token operator">|</span> product_name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> S8           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
</code></pre>
<p>The product with id 1 was only sold in spring 2019 while the other two were sold after.</p>
<p>通过解释，我们要找到只在某一时间段卖出的商品信息，很简单，直接上答案！</p>
<p><font color="red">TOTALLY WRONG!!!</font></p>
<p align="center">
	  <img src="http://wx4.sinaimg.cn/mw690/006HJgYYgy1fzkihdo6iog30g40hidky.gif">
</p>
<p>我们要找的是<strong>仅在某一段时间出售的产品</strong>，会存在一个产品确实在此时间段出售，但也在别的时间段出售，我们要排除掉！</p>
<p>所以，我们用排除法，使得 <code>product_id</code> 不在 2019 年的夏秋冬所对应的的 <code>product_id</code>，也就是不在 <code>2019-04-01</code> 到 <code>2019-12-31</code>。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	product_id<span class="token punctuation">,</span>
	product_name 
<span class="token keyword">from</span>
	product
<span class="token keyword">where</span> product_id <span class="token operator">not</span> <span class="token operator">in</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> product_id
<span class="token keyword">from</span> sales
<span class="token keyword">where</span> sale_date <span class="token operator">not</span> <span class="token operator">between</span> <span class="token string">'2019-01-01'</span> <span class="token operator">and</span> <span class="token string">'2019-03-31'</span><span class="token punctuation">)</span> 
<span class="token comment"># 注意不能只单纯限制时间范围</span>
<span class="token comment"># 通过subquery来限制product_id不在</span>
<span class="token comment"># 2019-04-01 - 2019-12-31对应的product_id</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sql35.png?raw=true">
</p>
</div>
</body>

</html>
