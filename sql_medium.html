<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sql_medium</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p align="center">
	  <img src="https://thumbs.gfycat.com/InsistentSardonicAppaloosa-small.gif">
</p>
<h1 id="sql刷题（中等）">SQL刷题（中等）</h1>
<h2 id="题目">题目</h2>
<h3 id="medium">Medium</h3>
<blockquote>
<p>加粗的题目里面含有follow up question!<br>
斜体的题目是系列套题，可以一起做！<br>
代码整理全部在附件里（文章最后）</p>
</blockquote>
<ul>
<li><a href="#1">Active Businesses</a></li>
<li><a href="#2"><strong>Active Users</strong></a></li>
<li><a href="#3">Activity Participants</a></li>
<li><a href="#4">All People Report to the Given Manager</a></li>
</ul>
<h2 id="前言">前言</h2>
<p>这篇文章主要帮助大家开启对 SQL 的深入学习，总结了 LeetCode 中的 Database 中 SQL（中等）里面代表性较高且值得去反复做的  道题，希望能对大家深入SQL 有所帮助！</p>
<p><strong><font color="red">Now, Let’s get started!</font></strong></p>
<hr>
<h3 id="span-id11.-active-businessesspan"><span id="1">1. Active Businesses</span></h3>
<p>Table: <code>Events</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> business_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> event_type    <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> occurences    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(business_id, event_type)</code> is the primary key of this table.</p>
<p>Each row in the table logs the info that an event of some type occured at some business for a number of times.</p>
<p>Write an SQL query to find all  <em>active businesses</em>.</p>
<p>An active business is a business that has more than one event type with occurences greater than the average occurences of that event type among all businesses.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Event table:</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+</span>
<span class="token operator">|</span> business_id <span class="token operator">|</span> event_type <span class="token operator">|</span> occurences <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> reviews    <span class="token operator">|</span> <span class="token number">7</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> reviews    <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> ads        <span class="token operator">|</span> <span class="token number">11</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> ads        <span class="token operator">|</span> <span class="token number">7</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> ads        <span class="token operator">|</span> <span class="token number">6</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> page views <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> page views <span class="token operator">|</span> <span class="token number">12</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> business_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p><strong>Explaination:</strong></p>
<p>Average for <code>'reviews', 'ads' and 'page views'</code> are (7+3)/2=5, (11+7+6)/3=8, (3+12)/2=7.5 respectively.</p>
<p>Business with id 1 has 7 ‘reviews’ events (more than 5) and 11 ‘ads’ events (more than 8) so it is an active business.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题作为中单难度的第一题，在复杂程度上比简单难度的题有明显提高！</p>
<p>本题目的去找所有 active business，那么对于其定义是</p>
<p><strong>所有 occurance 大于其 event_type 对应的 occurance 平均值并且对应的 event_type 个数大于 1 的 business_id</strong></p>
<p>需要注意以下几点：</p>
<ul>
<li>计算出每个 event_type 对应的 occurance 均值</li>
<li>如何把 occurance 和 均值来比较大小作为筛选条件</li>
<li>如何找到对应的 event_type 个数大于 1 的 business_id</li>
</ul>
<p>首先我们要找到 event_type 对应的 occurance 的均值</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	event_type<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>occurences<span class="token punctuation">)</span> <span class="token keyword">as</span> avg_occ
<span class="token keyword">from</span> events
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p>很简单，这是很基础的，那么接下来我们需要把 events 表格中的 occurance 与均值来比较，那么我们采取表格连接的办法，使其合并到一起</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    <span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> event_type<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>occurences<span class="token punctuation">)</span> <span class="token keyword">as</span> avg_occ
    <span class="token keyword">from</span> events
    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">)</span> tmp
<span class="token keyword">join</span> events
<span class="token keyword">using</span> <span class="token punctuation">(</span>event_type<span class="token punctuation">)</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: 
<span class="token punctuation">[</span><span class="token string">"event_type"</span><span class="token punctuation">,</span> <span class="token string">"avg_occ"</span><span class="token punctuation">,</span> <span class="token string">"business_id"</span><span class="token punctuation">,</span> <span class="token string">"occurences"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"reviews"</span><span class="token punctuation">,</span> <span class="token number">5.0000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token string">"reviews"</span><span class="token punctuation">,</span> <span class="token number">5.0000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"ads"</span><span class="token punctuation">,</span> <span class="token number">8.0000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"ads"</span><span class="token punctuation">,</span> <span class="token number">8.0000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"ads"</span><span class="token punctuation">,</span> <span class="token number">8.0000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"page views"</span><span class="token punctuation">,</span> <span class="token number">7.5000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"page views"</span><span class="token punctuation">,</span> <span class="token number">7.5000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>那么我们要做到同时满足：对于每个 business_id，有超过一个 event_type 对应的 <code>occurance</code> 大于 <code>avg_occ</code>。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    business_id
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> event_type<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>occurences<span class="token punctuation">)</span> <span class="token keyword">as</span> avg_occ
    <span class="token keyword">from</span> events
    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">)</span> tmp
<span class="token keyword">join</span> events
<span class="token keyword">using</span> <span class="token punctuation">(</span>event_type<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>occurences <span class="token operator">&gt;</span> avg_occ<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span>
<span class="token comment"># sum(if(occurences &gt; avg_occ,1,0)) 是为了数满足条件的有几个</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm1.png?raw=true">
</p>
<h3 id="span-id22.-active-usersspan"><span id="2">2. Active Users</span></h3>
<p>Table  <code>Accounts</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>the id is the primary key for this table.</p>
<p>This table contains the account id and the user name of each account.</p>
<p>Table  <code>Logins</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> login_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>There is no primary key for this table, it may contain duplicates.</p>
<p>This table contains the account id of the user who logged in and the login date. A user may log in multiple times in the day.</p>
<p>Write an SQL query to find the id and the name of active users.</p>
<p>Active users are those who logged in to their accounts for 5 or more consecutive days.</p>
<p>Return the result table  <strong>ordered</strong>  by the id.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Accounts table:</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Winston  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> Jonathan <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>

<span class="token comment"># Logins table:</span>
<span class="token operator">+</span><span class="token comment">----+------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> login_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> Jonathan <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
</code></pre>
<p>User Winston with id = 1 logged in 2 times only in 2 different days, so, Winston is not an active user.</p>
<p>User Jonathan with id = 7 logged in 7 times in 6 different days, five of them were consecutive days, so, Jonathan is an active user.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找登录账户连续五天或以上的用户，也就是活跃用户</p>
<p>需要注意：</p>
<ul>
<li>连续五天如何定义</li>
<li>超过五天又怎么办</li>
</ul>
<p>日期上的连续五天，其实需要满足两个条件：</p>
<ul>
<li><strong>把这五天进行排序</strong>，那么从小到大排列必然对应序列为 1 2 3 4 5 … ，所以要满足 <code>最大的日期对应的序 - 最小的日期对应的序 = 4</code>，因为不管怎么样，连续的五天不论怎么排序，最大最小之间的序差一定是 4</li>
<li>但是排序只能说明他们的大小关系，连续的话需要再满足一个条件就是 <code>最大日期 - 最小日期 = 4（天）</code></li>
</ul>
<p>我们先看第一个：排序</p>
<p>利用 window function，我们有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># 这个是CTE</span>
<span class="token keyword">WITH</span> t <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> 
	    <span class="token keyword">DISTINCT</span> id<span class="token punctuation">,</span> 
		login_date<span class="token punctuation">,</span> 
		DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> login_date<span class="token punctuation">)</span> rank_date
<span class="token keyword">FROM</span> Logins
<span class="token punctuation">)</span>

<span class="token comment"># select * from t</span>
</code></pre>
<p>我们看一下结果</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"login_date"</span><span class="token punctuation">,</span> <span class="token string">"rank_date"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2020-05-30"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2020-06-07"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-05-30"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-05-31"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-01"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-02"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-03"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-10"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么再来看第二个条件：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span> name 
<span class="token keyword">from</span> Accounts 
<span class="token keyword">where</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> t1<span class="token punctuation">.</span>id 
    <span class="token keyword">from</span> t t1
    <span class="token keyword">join</span> t t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>login_date <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>login_date<span class="token punctuation">,</span> INTERVAL <span class="token number">4</span> DAY<span class="token punctuation">)</span> 
    <span class="token comment"># 存在 日期A - 日期B = 4（天）</span>
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>rank_date <span class="token operator">-</span> t2<span class="token punctuation">.</span>rank_date <span class="token operator">=</span> <span class="token number">4</span>
    <span class="token comment"># 最大的日期对应的序 - 最小的日期对应的序 = 4</span>
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token comment"># 那么同时满足这两个条件的 id 和 name 一定保证连续5天登陆</span>
<span class="token comment"># 既然连续5天满足了，那么连续超过五天也必然满足，是属于包含关系的！</span>
<span class="token comment"># 因为假如有七天是连续的，那么有三种连续五天的情况，也都是满足上述两个条件</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> 
	    <span class="token keyword">distinct</span> id<span class="token punctuation">,</span> 
	    login_date<span class="token punctuation">,</span> 
	    DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rank_date
	<span class="token keyword">from</span> Logins
<span class="token punctuation">)</span>

<span class="token keyword">select</span> id<span class="token punctuation">,</span> name 
<span class="token keyword">from</span> Accounts 
<span class="token keyword">where</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> t1<span class="token punctuation">.</span>id 
    <span class="token keyword">from</span> t t1
    <span class="token keyword">join</span> t t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>login_date <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>login_date<span class="token punctuation">,</span> INTERVAL <span class="token number">4</span> DAY<span class="token punctuation">)</span> 
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>rank_date <span class="token operator">-</span> t2<span class="token punctuation">.</span>rank_date <span class="token operator">=</span> <span class="token number">4</span>
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p><strong>Follow-up:</strong><br>
Can you write a general solution if the active users are those who logged in to their accounts for <code>n</code> or more consecutive days?</p>
<p>这就很简单了，我们只需要在原来的基础上做些改动即可。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> N_consecutive_days<span class="token punctuation">(</span>N <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">RETURN</span> <span class="token punctuation">(</span>
      <span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> 
	    <span class="token keyword">distinct</span> id<span class="token punctuation">,</span> 
	    login_date<span class="token punctuation">,</span> 
	    DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rank_date
	<span class="token keyword">from</span> Logins
	<span class="token punctuation">)</span>

	<span class="token keyword">select</span> id<span class="token punctuation">,</span> name 
	<span class="token keyword">from</span> Accounts 
	<span class="token keyword">where</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span>
	    <span class="token keyword">select</span> t1<span class="token punctuation">.</span>id 
	    <span class="token keyword">from</span> t t1
	    <span class="token keyword">join</span> t t2
	    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>login_date <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>login_date<span class="token punctuation">,</span> INTERVAL N<span class="token number">-1</span> DAY<span class="token punctuation">)</span> 
	    <span class="token operator">and</span> t1<span class="token punctuation">.</span>rank_date <span class="token operator">-</span> t2<span class="token punctuation">.</span>rank_date <span class="token operator">=</span> N<span class="token number">-1</span>
	    <span class="token operator">and</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
	<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm2.png?raw=true">
</p>
<h3 id="span-id33.-activity-participantsspan"><span id="3">3. Activity Participants</span></h3>
<p>Table:  <code>Friends</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> activity      <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>id</code> is the id of the friend and primary key for this table.</p>
<p><code>name</code> is the name of the friend.</p>
<p><code>activity</code> is the name of the activity which the friend takes part in.</p>
<p>Table: <code>Activities</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>id</code> is the primary key for this table.</p>
<p><code>name</code> is the name of the activity.</p>
<p>Write an SQL query to find the names of all the activities with neither maximum, nor minimum number of participants.</p>
<p>Return the result table in any order. Each activity in table Activities is performed by any person in the table Friends.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Friends table:</span>
<span class="token operator">+</span><span class="token comment">------+--------------+---------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> name         <span class="token operator">|</span> activity      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> Jonathan D<span class="token punctuation">.</span>  <span class="token operator">|</span> Eating        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> Jade W<span class="token punctuation">.</span>      <span class="token operator">|</span> Singing       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> Victor J<span class="token punctuation">.</span>    <span class="token operator">|</span> Singing       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>    <span class="token operator">|</span> Elvis Q<span class="token punctuation">.</span>     <span class="token operator">|</span> Eating        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span> Daniel A<span class="token punctuation">.</span>    <span class="token operator">|</span> Eating        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>    <span class="token operator">|</span> Bob B<span class="token punctuation">.</span>       <span class="token operator">|</span> Horse Riding  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+---------------+</span>

<span class="token comment"># Activities table:</span>
<span class="token operator">+</span><span class="token comment">------+--------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> name         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> Eating       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> Singing      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> Horse Riding <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> activity     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> Singing      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
</code></pre>
<p>Eating activity is performed by 3 friends, maximum number of participants, (Jonathan D. , Elvis Q. and Daniel A.)</p>
<p>Horse Riding activity is performed by 1 friend, minimum number of participants, (Bob B.)</p>
<p>Singing is performed by 2 friends (Victor J. and Jade W.)</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题比较直接明了，我们要找既不是最多人选也不是最少人选的 activity。</p>
<p>首先，肯定要计算每个 activity 出现的次数</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># 使用CTE方便我们接下来的操作</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> activity<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span>
<span class="token keyword">from</span> friends
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># select * from t</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"activity"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"Eating"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Singing"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Horse Riding"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>自然我们要选这里的 singing，所以我们要保证 <code>c</code> 要小于这一列的最大值，并且大于这里的最小值。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> activity
<span class="token keyword">from</span> t
<span class="token keyword">where</span> <span class="token number">c</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token number">c</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>注意：下面这种写法是不行的！</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> activity
<span class="token keyword">from</span> t
<span class="token keyword">where</span> <span class="token number">c</span> <span class="token operator">&lt;</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token number">c</span> <span class="token operator">&gt;</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> activity<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span>
<span class="token keyword">from</span> friends
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">select</span> activity
<span class="token keyword">from</span> t
<span class="token keyword">where</span> <span class="token number">c</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token number">c</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm3.png?raw=true">
</p>
<h3 id="span-id44.-all-people-report-to-the-given-managerspan"><span id="4">4. All People Report to the Given Manager</span></h3>
<p>Table:  <code>Employees</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> employee_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> employee_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> manager_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>employee_id</code> is the primary key for this table.</p>
<p>Each row of this table indicates that the employee with ID <code>employee_id</code> and name <code>employee_name</code> reports his work to his/her direct manager with <code>manager_id</code></p>
<p>The head of the company is the employee with <code>employee_id</code> = 1.</p>
<p>Write an SQL query to find <code>employee_id</code> of all employees that directly or indirectly report their work to the head of the company.</p>
<p>The indirect relation between managers will not exceed 3 managers as the company is small.</p>
<p>Return result table in any order without duplicates.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Employees table:</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> employee_name <span class="token operator">|</span> manager_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Boss          <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Alice         <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Bob           <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> Daniel        <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> Luis          <span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span>           <span class="token operator">|</span> Jhon          <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>           <span class="token operator">|</span> Angela        <span class="token operator">|</span> <span class="token number">8</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">77</span>          <span class="token operator">|</span> Robert        <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">77</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p>The head of the company is the employee with employee_id 1.</p>
<p>The employees with employee_id 2 and 77 report their work directly to the head of the company.</p>
<p>The employee with employee_id 4 report his work indirectly to the head of the company 4 --&gt; 2 --&gt; 1.</p>
<p>The employee with employee_id 7 report his work indirectly to the head of the company 7 --&gt; 4 --&gt; 2 --&gt; 1.</p>
<p>The employees with employee_id 3, 8 and 9 don’t report their work to head of company directly or indirectly.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>这个题目有点绕来绕去的，简单来说就是员工向上级汇报，有两种情况：</p>
<ul>
<li>直接向 boss 汇报</li>
<li>先向上级汇报，上级在汇报给上级，直到最后上级汇报给 boss</li>
</ul>
<p>那么这里就需要不断的连接表格，然后根据条件来筛选满足条件的 <code>employee_id</code></p>
<p>那么根据本题，我们有 7 --&gt; 4 --&gt; 2 --&gt; 1 的情况出现，那么自然在我们得知 7 汇报给 4 后，4 汇报给谁呢？这是我们要 self join 一次，得知 4 汇报给 2，那么 2 汇报给了谁？需要再 self join 一次，得知 2 汇报给了 1。</p>
<p>那么我们先把表格连接起来</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> Employees <span class="token number">e1</span>
<span class="token keyword">join</span> Employees <span class="token number">e2</span>
<span class="token keyword">on</span> <span class="token number">e1</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e2</span><span class="token punctuation">.</span>employee_id
<span class="token keyword">join</span> Employees <span class="token number">e3</span>
<span class="token keyword">on</span> <span class="token number">e2</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e3</span><span class="token punctuation">.</span>employee_id
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"employee_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_name"</span><span class="token punctuation">,</span> <span class="token string">"manager_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_name"</span><span class="token punctuation">,</span> <span class="token string">"manager_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_name"</span><span class="token punctuation">,</span> <span class="token string">"manager_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">77</span><span class="token punctuation">,</span> <span class="token string">"Robert"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"Angela"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"Luis"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>从上面的数据来看，我们要满足下面的条件：</p>
<ul>
<li><code>e1.employee_id != 1</code> 因为 boss 不需要汇报给别人</li>
<li><code>e1.manager_id = 1 or e2.m1r_id = 1 or e3.manager_id = 1</code> 因为要么直接汇报给 boss 要么汇报给上司再由上司向上汇报，直到会汇报给 boss。</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span><span class="token punctuation">(</span><span class="token number">e1</span><span class="token punctuation">.</span>employee_id<span class="token punctuation">)</span>
<span class="token keyword">from</span> Employees <span class="token number">e1</span>
<span class="token keyword">join</span> Employees <span class="token number">e2</span>
<span class="token keyword">on</span> <span class="token number">e1</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e2</span><span class="token punctuation">.</span>employee_id
<span class="token keyword">join</span> Employees <span class="token number">e3</span>
<span class="token keyword">on</span> <span class="token number">e2</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e3</span><span class="token punctuation">.</span>employee_id
<span class="token keyword">where</span>
<span class="token punctuation">(</span><span class="token number">e1</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">1</span>
<span class="token operator">or</span> <span class="token number">e2</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">1</span>
<span class="token operator">or</span> <span class="token number">e3</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">e1</span><span class="token punctuation">.</span>employee_id<span class="token operator">!=</span><span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>那么要是存在一个非常长的递归序列，例如：100 --&gt; 99 --&gt; … --&gt; 1，那么难道我们要 self join 98 次么？显然这种写法不理想，那么我们可以采用递归的写法。</p>
<p><font color="red">递归写法如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> recursive cte <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> employee_id <span class="token keyword">from</span> Employees <span class="token keyword">where</span> employee_id <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token operator">and</span> manager_id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">union</span>
<span class="token keyword">select</span> <span class="token number">e</span><span class="token punctuation">.</span>employee_id <span class="token keyword">from</span> Employees <span class="token number">e</span> <span class="token keyword">join</span> cte <span class="token number">c</span> <span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span>employee_id <span class="token operator">=</span> <span class="token number">e</span><span class="token punctuation">.</span>manager_id<span class="token punctuation">)</span>

<span class="token keyword">select</span> employee_id <span class="token keyword">from</span> cte<span class="token punctuation">;</span>
</code></pre>
<p>解释一下：</p>
<ul>
<li><code>with recursive cte</code> 是一种<a href="https://www.mysqltutorial.org/mysql-recursive-cte/">递归 CTE 写法</a></li>
<li>一种情况是直接就汇报给 boss：<code>select employee_id from Employees where employee_id &lt;&gt; 1 and manager_id = 1</code></li>
<li>另一种是递归 <code>select e.employee_id from Employees e join cte c on c.employee_id = e.manager_id</code></li>
<li>最后把他们 union 到一起</li>
</ul>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm4.png?raw=true">
</p>
</div>
</body>

</html>
