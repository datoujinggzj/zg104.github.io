<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sql_medium</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p align="center">
	  <img src="https://thumbs.gfycat.com/InsistentSardonicAppaloosa-small.gif">
</p>
<h1 id="sql刷题（中等）">SQL刷题（中等）</h1>
<h2 id="题目">题目</h2>
<h3 id="medium">Medium</h3>
<blockquote>
<p>加粗的题目里面含有follow up question!<br>
斜体的题目是系列套题，可以一起做！<br>
代码整理全部在附件里（文章最后）</p>
</blockquote>
<ul>
<li><a href="#1">Active Businesses</a></li>
<li><a href="#2"><strong>Active Users</strong></a></li>
<li><a href="#3">Activity Participants</a></li>
<li><a href="#4">All People Report to the Given Manager</a></li>
<li><a href="#5">Apples &amp; Oranges</a></li>
<li><a href="#6"><em>Article Views II</em></a></li>
<li><a href="#7">Bank Account Summary</a></li>
<li><a href="#8">Calculate Salaries</a></li>
<li><a href="#9">Capital Gain/Loss</a></li>
<li><a href="#10">Consecutive Numbers</a></li>
<li><a href="#11">Count Student Number in Departments</a></li>
<li><a href="#12">Countries You Can Safely Invest In</a></li>
<li><a href="#13">Customers Who Bought All Products</a></li>
<li><a href="#14">Customers Who Bought Products A and B but Not C</a></li>
<li><a href="#15">Department Highest Salary</a></li>
<li><a href="#16">Evaluate Boolean Expression</a></li>
<li><a href="#17">Exchange Seats</a></li>
<li><a href="#18">Find the Start and End Number of Continuous Ranges</a></li>
<li><a href="#19"><em><strong>Friend Requests II: Who Has the Most Friends</strong></em></a></li>
<li><a href="#20"><em>Game Play Analysis III</em></a></li>
<li><a href="#21"><em>Game Play Analysis IV</em></a></li>
<li><a href="#22">Get Highest Answer Rate Question</a></li>
<li><a href="#23">Highest Grade For Each Student</a></li>
<li><a href="#24"><em>Immediate Food Delivery II</em></a></li>
<li><a href="#25">Investments in 2016</a></li>
<li><a href="#26">Last Person to Fit in the Elevator</a></li>
<li><a href="#27">Managers with at Least 5 Direct Reports</a></li>
<li><a href="#28"><em>Market Analysis I</em></a></li>
<li><a href="#29"><em>Monthly Transactions I</em></a></li>
<li><a href="#30"><em>Monthly Transactions II</em></a></li>
<li><a href="#31">Movie Rating</a></li>
<li><a href="#32">New Users Daily Count</a></li>
<li><a href="#33">Nth Highest Salary</a></li>
<li><a href="#34">Number of Trusted Contacts of a Customer</a></li>
<li><a href="#35">Page Recommendations</a></li>
<li><a href="#36">Product Price at a Given Date</a></li>
<li><a href="#37"><em>Project Employees III</em></a></li>
<li><a href="#38">Rank Scores</a>  <font color="red">Hot!!!</font></li>
<li><a href="#39">Rectangles Area</a></li>
<li><a href="#40">Restaurant Growth</a></li>
<li><a href="#41">Running Total for Different Genders</a></li>
<li><a href="#42">Shortest Distance in a Plane</a></li>
<li><a href="#43">Team Scores in Football Tournament</a></li>
</ul>
<h2 id="前言">前言</h2>
<p>这篇文章主要帮助大家开启对 SQL 的深入学习，总结了 LeetCode 中的 Database 中 SQL（中等）里面代表性较高且值得去反复做的  道题，希望能对大家深入SQL 有所帮助！</p>
<p><strong><font color="red">Now, Let’s get started!</font></strong></p>
<hr>
<h3 id="span-id11.-active-businessesspan"><span id="1">1. Active Businesses</span></h3>
<p>Table: <code>Events</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> business_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> event_type    <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> occurences    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(business_id, event_type)</code> is the primary key of this table.</p>
<p>Each row in the table logs the info that an event of some type occured at some business for a number of times.</p>
<p>Write an SQL query to find all  <em>active businesses</em>.</p>
<p>An active business is a business that has more than one event type with occurences greater than the average occurences of that event type among all businesses.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Event table:</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+</span>
<span class="token operator">|</span> business_id <span class="token operator">|</span> event_type <span class="token operator">|</span> occurences <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> reviews    <span class="token operator">|</span> <span class="token number">7</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> reviews    <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> ads        <span class="token operator">|</span> <span class="token number">11</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> ads        <span class="token operator">|</span> <span class="token number">7</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> ads        <span class="token operator">|</span> <span class="token number">6</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> page views <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> page views <span class="token operator">|</span> <span class="token number">12</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> business_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p><strong>Explaination:</strong></p>
<p>Average for <code>'reviews', 'ads' and 'page views'</code> are (7+3)/2=5, (11+7+6)/3=8, (3+12)/2=7.5 respectively.</p>
<p>Business with id 1 has 7 ‘reviews’ events (more than 5) and 11 ‘ads’ events (more than 8) so it is an active business.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题作为中单难度的第一题，在复杂程度上比简单难度的题有明显提高！</p>
<p>本题目的去找所有 active business，那么对于其定义是</p>
<p><strong>所有 occurance 大于其 event_type 对应的 occurance 平均值并且对应的 event_type 个数大于 1 的 business_id</strong></p>
<p>需要注意以下几点：</p>
<ul>
<li>计算出每个 event_type 对应的 occurance 均值</li>
<li>如何把 occurance 和 均值来比较大小作为筛选条件</li>
<li>如何找到对应的 event_type 个数大于 1 的 business_id</li>
</ul>
<p>首先我们要找到 event_type 对应的 occurance 的均值</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	event_type<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>occurences<span class="token punctuation">)</span> <span class="token keyword">as</span> avg_occ
<span class="token keyword">from</span> events
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p>很简单，这是很基础的，那么接下来我们需要把 events 表格中的 occurance 与均值来比较，那么我们采取表格连接的办法，使其合并到一起</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    <span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> event_type<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>occurences<span class="token punctuation">)</span> <span class="token keyword">as</span> avg_occ
    <span class="token keyword">from</span> events
    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">)</span> tmp
<span class="token keyword">join</span> events
<span class="token keyword">using</span> <span class="token punctuation">(</span>event_type<span class="token punctuation">)</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: 
<span class="token punctuation">[</span><span class="token string">"event_type"</span><span class="token punctuation">,</span> <span class="token string">"avg_occ"</span><span class="token punctuation">,</span> <span class="token string">"business_id"</span><span class="token punctuation">,</span> <span class="token string">"occurences"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"reviews"</span><span class="token punctuation">,</span> <span class="token number">5.0000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token string">"reviews"</span><span class="token punctuation">,</span> <span class="token number">5.0000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"ads"</span><span class="token punctuation">,</span> <span class="token number">8.0000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"ads"</span><span class="token punctuation">,</span> <span class="token number">8.0000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"ads"</span><span class="token punctuation">,</span> <span class="token number">8.0000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"page views"</span><span class="token punctuation">,</span> <span class="token number">7.5000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"page views"</span><span class="token punctuation">,</span> <span class="token number">7.5000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>那么我们要做到同时满足：对于每个 business_id，有超过一个 event_type 对应的 <code>occurance</code> 大于 <code>avg_occ</code>。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    business_id
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> event_type<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>occurences<span class="token punctuation">)</span> <span class="token keyword">as</span> avg_occ
    <span class="token keyword">from</span> events
    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">)</span> tmp
<span class="token keyword">join</span> events
<span class="token keyword">using</span> <span class="token punctuation">(</span>event_type<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>occurences <span class="token operator">&gt;</span> avg_occ<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span>
<span class="token comment"># sum(if(occurences &gt; avg_occ,1,0)) 是为了数满足条件的有几个</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm1.png?raw=true">
</p>
<h3 id="span-id22.-active-usersspan"><span id="2">2. Active Users</span></h3>
<p>Table  <code>Accounts</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>the id is the primary key for this table.</p>
<p>This table contains the account id and the user name of each account.</p>
<p>Table  <code>Logins</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> login_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>There is no primary key for this table, it may contain duplicates.</p>
<p>This table contains the account id of the user who logged in and the login date. A user may log in multiple times in the day.</p>
<p>Write an SQL query to find the id and the name of active users.</p>
<p>Active users are those who logged in to their accounts for 5 or more consecutive days.</p>
<p>Return the result table  <strong>ordered</strong>  by the id.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Accounts table:</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Winston  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> Jonathan <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>

<span class="token comment"># Logins table:</span>
<span class="token operator">+</span><span class="token comment">----+------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> login_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">31</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> Jonathan <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
</code></pre>
<p>User Winston with id = 1 logged in 2 times only in 2 different days, so, Winston is not an active user.</p>
<p>User Jonathan with id = 7 logged in 7 times in 6 different days, five of them were consecutive days, so, Jonathan is an active user.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找登录账户连续五天或以上的用户，也就是活跃用户</p>
<p>需要注意：</p>
<ul>
<li>连续五天如何定义</li>
<li>超过五天又怎么办</li>
</ul>
<p>日期上的连续五天，其实需要满足两个条件：</p>
<ul>
<li><strong>把这五天进行排序</strong>，那么从小到大排列必然对应序列为 1 2 3 4 5 … ，所以要满足 <code>最大的日期对应的序 - 最小的日期对应的序 = 4</code>，因为不管怎么样，连续的五天不论怎么排序，最大最小之间的序差一定是 4</li>
<li>但是排序只能说明他们的大小关系，连续的话需要再满足一个条件就是 <code>最大日期 - 最小日期 = 4（天）</code></li>
</ul>
<p>我们先看第一个：排序</p>
<p>利用 window function，我们有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># 这个是CTE</span>
<span class="token keyword">WITH</span> t <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> 
	    <span class="token keyword">DISTINCT</span> id<span class="token punctuation">,</span> 
		login_date<span class="token punctuation">,</span> 
		DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> login_date<span class="token punctuation">)</span> rank_date
<span class="token keyword">FROM</span> Logins
<span class="token punctuation">)</span>

<span class="token comment"># select * from t</span>
</code></pre>
<p>我们看一下结果</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"login_date"</span><span class="token punctuation">,</span> <span class="token string">"rank_date"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2020-05-30"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2020-06-07"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-05-30"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-05-31"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-01"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-02"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-03"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"2020-06-10"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么再来看第二个条件：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span> name 
<span class="token keyword">from</span> Accounts 
<span class="token keyword">where</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> t1<span class="token punctuation">.</span>id 
    <span class="token keyword">from</span> t t1
    <span class="token keyword">join</span> t t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>login_date <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>login_date<span class="token punctuation">,</span> INTERVAL <span class="token number">4</span> DAY<span class="token punctuation">)</span> 
    <span class="token comment"># 存在 日期A - 日期B = 4（天）</span>
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>rank_date <span class="token operator">-</span> t2<span class="token punctuation">.</span>rank_date <span class="token operator">=</span> <span class="token number">4</span>
    <span class="token comment"># 最大的日期对应的序 - 最小的日期对应的序 = 4</span>
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token comment"># 那么同时满足这两个条件的 id 和 name 一定保证连续5天登陆</span>
<span class="token comment"># 既然连续5天满足了，那么连续超过五天也必然满足，是属于包含关系的！</span>
<span class="token comment"># 因为假如有七天是连续的，那么有三种连续五天的情况，也都是满足上述两个条件</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> 
	    <span class="token keyword">distinct</span> id<span class="token punctuation">,</span> 
	    login_date<span class="token punctuation">,</span> 
	    DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rank_date
	<span class="token keyword">from</span> Logins
<span class="token punctuation">)</span>

<span class="token keyword">select</span> id<span class="token punctuation">,</span> name 
<span class="token keyword">from</span> Accounts 
<span class="token keyword">where</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> t1<span class="token punctuation">.</span>id 
    <span class="token keyword">from</span> t t1
    <span class="token keyword">join</span> t t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>login_date <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>login_date<span class="token punctuation">,</span> INTERVAL <span class="token number">4</span> DAY<span class="token punctuation">)</span> 
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>rank_date <span class="token operator">-</span> t2<span class="token punctuation">.</span>rank_date <span class="token operator">=</span> <span class="token number">4</span>
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p><strong>Follow-up:</strong><br>
Can you write a general solution if the active users are those who logged in to their accounts for <code>n</code> or more consecutive days?</p>
<p>这就很简单了，我们只需要在原来的基础上做些改动即可。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> N_consecutive_days<span class="token punctuation">(</span>N <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">RETURN</span> <span class="token punctuation">(</span>
      <span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> 
	    <span class="token keyword">distinct</span> id<span class="token punctuation">,</span> 
	    login_date<span class="token punctuation">,</span> 
	    DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rank_date
	<span class="token keyword">from</span> Logins
	<span class="token punctuation">)</span>

	<span class="token keyword">select</span> id<span class="token punctuation">,</span> name 
	<span class="token keyword">from</span> Accounts 
	<span class="token keyword">where</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span>
	    <span class="token keyword">select</span> t1<span class="token punctuation">.</span>id 
	    <span class="token keyword">from</span> t t1
	    <span class="token keyword">join</span> t t2
	    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>login_date <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>login_date<span class="token punctuation">,</span> INTERVAL N<span class="token number">-1</span> DAY<span class="token punctuation">)</span> 
	    <span class="token operator">and</span> t1<span class="token punctuation">.</span>rank_date <span class="token operator">-</span> t2<span class="token punctuation">.</span>rank_date <span class="token operator">=</span> N<span class="token number">-1</span>
	    <span class="token operator">and</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
	<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm2.png?raw=true">
</p>
<h3 id="span-id33.-activity-participantsspan"><span id="3">3. Activity Participants</span></h3>
<p>Table:  <code>Friends</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> activity      <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>id</code> is the id of the friend and primary key for this table.</p>
<p><code>name</code> is the name of the friend.</p>
<p><code>activity</code> is the name of the activity which the friend takes part in.</p>
<p>Table: <code>Activities</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>id</code> is the primary key for this table.</p>
<p><code>name</code> is the name of the activity.</p>
<p>Write an SQL query to find the names of all the activities with neither maximum, nor minimum number of participants.</p>
<p>Return the result table in any order. Each activity in table Activities is performed by any person in the table Friends.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Friends table:</span>
<span class="token operator">+</span><span class="token comment">------+--------------+---------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> name         <span class="token operator">|</span> activity      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> Jonathan D<span class="token punctuation">.</span>  <span class="token operator">|</span> Eating        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> Jade W<span class="token punctuation">.</span>      <span class="token operator">|</span> Singing       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> Victor J<span class="token punctuation">.</span>    <span class="token operator">|</span> Singing       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>    <span class="token operator">|</span> Elvis Q<span class="token punctuation">.</span>     <span class="token operator">|</span> Eating        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span> Daniel A<span class="token punctuation">.</span>    <span class="token operator">|</span> Eating        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>    <span class="token operator">|</span> Bob B<span class="token punctuation">.</span>       <span class="token operator">|</span> Horse Riding  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+---------------+</span>

<span class="token comment"># Activities table:</span>
<span class="token operator">+</span><span class="token comment">------+--------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> name         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> Eating       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> Singing      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> Horse Riding <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> activity     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> Singing      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
</code></pre>
<p>Eating activity is performed by 3 friends, maximum number of participants, (Jonathan D. , Elvis Q. and Daniel A.)</p>
<p>Horse Riding activity is performed by 1 friend, minimum number of participants, (Bob B.)</p>
<p>Singing is performed by 2 friends (Victor J. and Jade W.)</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题比较直接明了，我们要找既不是最多人选也不是最少人选的 activity。</p>
<p>首先，肯定要计算每个 activity 出现的次数</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># 使用CTE方便我们接下来的操作</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> activity<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span>
<span class="token keyword">from</span> friends
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># select * from t</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"activity"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"Eating"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Singing"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Horse Riding"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>自然我们要选这里的 singing，所以我们要保证 <code>c</code> 要小于这一列的最大值，并且大于这里的最小值。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> activity
<span class="token keyword">from</span> t
<span class="token keyword">where</span> <span class="token number">c</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token number">c</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>注意：下面这种写法是不行的！</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> activity
<span class="token keyword">from</span> t
<span class="token keyword">where</span> <span class="token number">c</span> <span class="token operator">&lt;</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token number">c</span> <span class="token operator">&gt;</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> activity<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">c</span>
<span class="token keyword">from</span> friends
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">select</span> activity
<span class="token keyword">from</span> t
<span class="token keyword">where</span> <span class="token number">c</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token number">c</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm3.png?raw=true">
</p>
<h3 id="span-id44.-all-people-report-to-the-given-managerspan"><span id="4">4. All People Report to the Given Manager</span></h3>
<p>Table:  <code>Employees</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> employee_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> employee_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> manager_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>employee_id</code> is the primary key for this table.</p>
<p>Each row of this table indicates that the employee with ID <code>employee_id</code> and name <code>employee_name</code> reports his work to his/her direct manager with <code>manager_id</code></p>
<p>The head of the company is the employee with <code>employee_id</code> = 1.</p>
<p>Write an SQL query to find <code>employee_id</code> of all employees that directly or indirectly report their work to the head of the company.</p>
<p>The indirect relation between managers will not exceed 3 managers as the company is small.</p>
<p>Return result table in any order without duplicates.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Employees table:</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> employee_name <span class="token operator">|</span> manager_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Boss          <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Alice         <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Bob           <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> Daniel        <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> Luis          <span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span>           <span class="token operator">|</span> Jhon          <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>           <span class="token operator">|</span> Angela        <span class="token operator">|</span> <span class="token number">8</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">77</span>          <span class="token operator">|</span> Robert        <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">77</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p>The head of the company is the employee with employee_id 1.</p>
<p>The employees with employee_id 2 and 77 report their work directly to the head of the company.</p>
<p>The employee with employee_id 4 report his work indirectly to the head of the company 4 --&gt; 2 --&gt; 1.</p>
<p>The employee with employee_id 7 report his work indirectly to the head of the company 7 --&gt; 4 --&gt; 2 --&gt; 1.</p>
<p>The employees with employee_id 3, 8 and 9 don’t report their work to head of company directly or indirectly.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>这个题目有点绕来绕去的，简单来说就是员工向上级汇报，有两种情况：</p>
<ul>
<li>直接向 boss 汇报</li>
<li>先向上级汇报，上级在汇报给上级，直到最后上级汇报给 boss</li>
</ul>
<p>那么这里就需要不断的连接表格，然后根据条件来筛选满足条件的 <code>employee_id</code></p>
<p>那么根据本题，我们有 7 --&gt; 4 --&gt; 2 --&gt; 1 的情况出现，那么自然在我们得知 7 汇报给 4 后，4 汇报给谁呢？这是我们要 self join 一次，得知 4 汇报给 2，那么 2 汇报给了谁？需要再 self join 一次，得知 2 汇报给了 1。</p>
<p>那么我们先把表格连接起来</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> Employees <span class="token number">e1</span>
<span class="token keyword">join</span> Employees <span class="token number">e2</span>
<span class="token keyword">on</span> <span class="token number">e1</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e2</span><span class="token punctuation">.</span>employee_id
<span class="token keyword">join</span> Employees <span class="token number">e3</span>
<span class="token keyword">on</span> <span class="token number">e2</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e3</span><span class="token punctuation">.</span>employee_id
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"employee_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_name"</span><span class="token punctuation">,</span> <span class="token string">"manager_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_name"</span><span class="token punctuation">,</span> <span class="token string">"manager_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_name"</span><span class="token punctuation">,</span> <span class="token string">"manager_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">77</span><span class="token punctuation">,</span> <span class="token string">"Robert"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Boss"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"Angela"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"Luis"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>从上面的数据来看，我们要满足下面的条件：</p>
<ul>
<li><code>e1.employee_id != 1</code> 因为 boss 不需要汇报给别人</li>
<li><code>e1.manager_id = 1 or e2.m1r_id = 1 or e3.manager_id = 1</code> 因为要么直接汇报给 boss 要么汇报给上司再由上司向上汇报，直到会汇报给 boss。</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span><span class="token punctuation">(</span><span class="token number">e1</span><span class="token punctuation">.</span>employee_id<span class="token punctuation">)</span>
<span class="token keyword">from</span> Employees <span class="token number">e1</span>
<span class="token keyword">join</span> Employees <span class="token number">e2</span>
<span class="token keyword">on</span> <span class="token number">e1</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e2</span><span class="token punctuation">.</span>employee_id
<span class="token keyword">join</span> Employees <span class="token number">e3</span>
<span class="token keyword">on</span> <span class="token number">e2</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">e3</span><span class="token punctuation">.</span>employee_id
<span class="token keyword">where</span>
<span class="token punctuation">(</span><span class="token number">e1</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">1</span>
<span class="token operator">or</span> <span class="token number">e2</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">1</span>
<span class="token operator">or</span> <span class="token number">e3</span><span class="token punctuation">.</span>manager_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token number">e1</span><span class="token punctuation">.</span>employee_id<span class="token operator">!=</span><span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>那么要是存在一个非常长的递归序列，例如：100 --&gt; 99 --&gt; … --&gt; 1，那么难道我们要 self join 98 次么？显然这种写法不理想，那么我们可以采用递归的写法。</p>
<p><font color="red">递归写法如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> recursive cte <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> employee_id <span class="token keyword">from</span> Employees <span class="token keyword">where</span> employee_id <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token operator">and</span> manager_id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">union</span>
<span class="token keyword">select</span> <span class="token number">e</span><span class="token punctuation">.</span>employee_id <span class="token keyword">from</span> Employees <span class="token number">e</span> <span class="token keyword">join</span> cte <span class="token number">c</span> <span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span>employee_id <span class="token operator">=</span> <span class="token number">e</span><span class="token punctuation">.</span>manager_id<span class="token punctuation">)</span>

<span class="token keyword">select</span> employee_id <span class="token keyword">from</span> cte<span class="token punctuation">;</span>
</code></pre>
<p>解释一下：</p>
<ul>
<li><code>with recursive cte</code> 是一种<a href="https://www.mysqltutorial.org/mysql-recursive-cte/">递归 CTE 写法</a></li>
<li>一种情况是直接就汇报给 boss：<code>select employee_id from Employees where employee_id &lt;&gt; 1 and manager_id = 1</code></li>
<li>另一种是递归 <code>select e.employee_id from Employees e join cte c on c.employee_id = e.manager_id</code></li>
<li>最后把他们 union 到一起</li>
</ul>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm4.png?raw=true">
</p>
<h3 id="span-id55.-apples--orangesspan"><span id="5">5. Apples &amp; Oranges</span></h3>
<p>Table: <code>Sales</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> sale_date     <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> fruit         <span class="token operator">|</span> <span class="token keyword">enum</span>    <span class="token operator">|</span> 
<span class="token operator">|</span> sold_num      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(sale_date,fruit)</code> is the primary key for this table.</p>
<p>This table contains the sales of “apples” and “oranges” sold each day.</p>
<p>Write an SQL query to report the difference between number of  <strong>apples</strong>  and  <strong>oranges</strong>  sold each day.</p>
<p>Return the result table  <strong>ordered</strong>  by sale_date in format (‘YYYY-MM-DD’).</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Sales table:</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-------------+</span>
<span class="token operator">|</span> sale_date  <span class="token operator">|</span> fruit      <span class="token operator">|</span> sold_num    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> apples     <span class="token operator">|</span> <span class="token number">10</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> oranges    <span class="token operator">|</span> <span class="token number">8</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> apples     <span class="token operator">|</span> <span class="token number">15</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> oranges    <span class="token operator">|</span> <span class="token number">15</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> apples     <span class="token operator">|</span> <span class="token number">20</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> oranges    <span class="token operator">|</span> <span class="token number">0</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">04</span> <span class="token operator">|</span> apples     <span class="token operator">|</span> <span class="token number">15</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">04</span> <span class="token operator">|</span> oranges    <span class="token operator">|</span> <span class="token number">16</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+</span>
<span class="token operator">|</span> sale_date  <span class="token operator">|</span> diff         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">20</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">04</span> <span class="token operator">|</span> <span class="token operator">-</span><span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+</span>
</code></pre>
<p>Day 2020-05-01, 10 apples and 8 oranges were sold (Difference  10 - 8 = 2).</p>
<p>Day 2020-05-02, 15 apples and 15 oranges were sold (Difference 15 - 15 = 0).</p>
<p>Day 2020-05-03, 20 apples and 0 oranges were sold (Difference 20 - 0 = 20).</p>
<p>Day 2020-05-04, 15 apples and 16 oranges were sold (Difference 15 - 16 = -1).</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要计算每一天里的苹果和橘子销量的差值，那么我们要做的就是拆开表格中的结构，去寻找苹果和橘子各自在每一天的销量，变成两列，在把列相减即可。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    sale_date<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>fruit <span class="token operator">=</span> <span class="token string">'apples'</span><span class="token punctuation">,</span>sold_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> apple<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>fruit <span class="token operator">=</span> <span class="token string">'oranges'</span><span class="token punctuation">,</span> sold_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> orange
<span class="token keyword">from</span> sales
<span class="token keyword">group</span> <span class="token keyword">by</span> sale_date
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"sale_date"</span><span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">,</span> <span class="token string">"orange"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"2020-05-01"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2020-05-02"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2020-05-03"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2020-05-04"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    sale_date<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>fruit <span class="token operator">=</span> <span class="token string">'apples'</span><span class="token punctuation">,</span>sold_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>fruit <span class="token operator">=</span> <span class="token string">'oranges'</span><span class="token punctuation">,</span> sold_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">as</span> <span class="token string">'diff'</span>
<span class="token keyword">from</span> sales
<span class="token keyword">group</span> <span class="token keyword">by</span> sale_date
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm5.png?raw=true">
</p>
<h3 id="span-id66.-article-views-iispan"><span id="6">6. Article Views II</span></h3>
<p>如果想回顾一下 Article Views I，请点击<a href="https://zg104.github.io/sql#3">这里</a>。</p>
<p>Table: <code>Views</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> article_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> author_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> viewer_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> view_date     <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>There is no primary key for this table, it may have duplicate rows.</p>
<p>Each row of this table indicates that some viewer viewed an article (written by some author) on some date.</p>
<p>Note that equal <code>author_id</code> and <code>viewer_id</code> indicate the same person.</p>
<p>Write an SQL query to find all the people who viewed more than one article on the same date, sorted in ascending order by their id.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Views table:</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-----------+------------+</span>
<span class="token operator">|</span> article_id <span class="token operator">|</span> author_id <span class="token operator">|</span> viewer_id <span class="token operator">|</span> view_date  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-----------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">5</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">5</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">6</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">6</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">22</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-----------+------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到所有的再同一天查看超过一篇不同文章的人，那么我们应该：</p>
<ol>
<li>找到在每一天，每一个人看不同文章的次数</li>
<li>这个次数大于 1</li>
<li>按照 id 升序排序</li>
</ol>
<p>那么，对于第一个条件，我们有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	view_date<span class="token punctuation">,</span> 
	viewer_id<span class="token punctuation">,</span> 
	<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> article_id<span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> views
<span class="token keyword">group</span> <span class="token keyword">by</span> view_date<span class="token punctuation">,</span> viewer_id
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"view_date"</span><span class="token punctuation">,</span> <span class="token string">"viewer_id"</span><span class="token punctuation">,</span> <span class="token string">"counts"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"2019-07-21"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-07-22"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-08-01"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-08-01"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-08-02"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>自然，我们要选 viewer_id 是 5 和 6的，因为 counts 大于 1。</p>
<p>那么我们更改原代码，把 <code>count(distinct article_id)</code> 修改成 having 的条件筛选形式，并且筛选所有的 distinct id。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> viewer_id <span class="token keyword">as</span> <span class="token string">'id'</span>
<span class="token keyword">from</span> views
<span class="token keyword">group</span> <span class="token keyword">by</span> view_date<span class="token punctuation">,</span> viewer_id
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> article_id<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> 
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm6.png?raw=true">
</p>
<h3 id="span-id77.-bank-account-summaryspan"><span id="7">7. Bank Account Summary</span></h3>
<p>Table: <code>Users</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> user_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> user_name    <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> credit       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>user_id</code> is the primary key for this table.</p>
<p>Each row of this table contains the current credit information for each user.</p>
<p>Table: <code>Transactions</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> trans_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> paid_by       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> paid_to       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> amount        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> transacted_on <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>trans_id</code> is the primary key for this table.</p>
<p>Each row of this table contains the information about the transaction in the bank.</p>
<p>User with id (paid_by) transfer money to user with id (paid_to).</p>
<p>Leetcode Bank (LCB) helps its coders in making virtual payments. Our bank records all transactions in the table  <em>Transaction</em>, we want to find out the current balance of all users and check wheter they have breached their credit limit (If their current credit is less than 0).</p>
<p>Write an SQL query to report.</p>
<ul>
<li><code>user_id</code></li>
<li><code>user_name</code></li>
<li><code>credit</code>, current balance after performing transactions.</li>
<li><code>credit_limit_breached</code>, check credit_limit (“Yes” or “No”)</li>
</ul>
<p>Return the result table in  <strong>any</strong>  order.</p>
<p>The query result format is in the following example.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Users table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+-------------+</span>
<span class="token operator">|</span> user_id    <span class="token operator">|</span> user_name    <span class="token operator">|</span> credit      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> Moustafa     <span class="token operator">|</span> <span class="token number">100</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> Jonathan     <span class="token operator">|</span> <span class="token number">200</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> Winston      <span class="token operator">|</span> <span class="token number">10000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span> Luis         <span class="token operator">|</span> <span class="token number">800</span>         <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">------------+--------------+-------------+</span>

<span class="token comment"># Transactions table:</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+----------+---------------+</span>
<span class="token operator">|</span> trans_id   <span class="token operator">|</span> paid_by    <span class="token operator">|</span> paid_to    <span class="token operator">|</span> amount   <span class="token operator">|</span> transacted_on <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+----------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">400</span>      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">500</span>      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">200</span>      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+----------+---------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+-----------------------+</span>
<span class="token operator">|</span> <span class="token punctuation">`</span>user_id <span class="token punctuation">`</span>   <span class="token operator">|</span> <span class="token punctuation">`</span>user_name<span class="token punctuation">`</span>  <span class="token operator">|</span> <span class="token punctuation">`</span>credit <span class="token punctuation">`</span>    <span class="token operator">|</span> <span class="token punctuation">`</span>credit_limit_breached<span class="token punctuation">`</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+-----------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> Moustafa   <span class="token operator">|</span> <span class="token operator">-</span><span class="token number">100</span>       <span class="token operator">|</span> Yes                   <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> Jonathan   <span class="token operator">|</span> <span class="token number">500</span>        <span class="token operator">|</span> <span class="token keyword">No</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> Winston    <span class="token operator">|</span> <span class="token number">9900</span>       <span class="token operator">|</span> <span class="token keyword">No</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span> Luis       <span class="token operator">|</span> <span class="token number">800</span>        <span class="token operator">|</span> <span class="token keyword">No</span>                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+------------+-----------------------+</span>
</code></pre>
<p>Moustafa paid $400 on “2020-08-01” and received $200 on “2020-08-03”, credit (100 -400 +200) = -$100</p>
<p>Jonathan received $500 on “2020-08-02” and paid $200 on “2020-08-08”, credit (200 +500 -200) = $500</p>
<p>Winston received $400 on “2020-08-01” and paid $500 on “2020-08-03”, credit (10000 +400 -500) = $9990</p>
<p>Luis didn’t received any transfer, credit = $800</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题要求我们找出当前的用户的 balance，并且判断他们是否违约（balance &lt; 0 即违约）</p>
<p>注意到他们之间是互相进行转账的，那么在经过一系列的转账后，再加上之前的 credit，就得到每个人最后的 balance，最终再根据 balance 的正负判断违约情况。</p>
<p>那么解决问题需要以下几个步骤：</p>
<ul>
<li>根据 paid_by 和 paid_to 计算每个人相对应的收款和付款情况</li>
<li>最初的 credit + 收款 - 付款 = balance</li>
<li>判断是否违约</li>
<li>连接两个表并取出所需要的列</li>
</ul>
<p>那么<strong>第一步</strong>，我们有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># paid by </span>
<span class="token comment"># result table 中的 user_id 也就是 transactions 中的 paid_by</span>

<span class="token keyword">select</span> 
	paid_by<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'out'</span>
<span class="token keyword">from</span> 
	<span class="token keyword">transactions</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> paid_by
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"paid_by"</span><span class="token punctuation">,</span> <span class="token string">"out"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
<span class="token comment"># 说明id = 1,2,3 分别一共转出400,200,500</span>
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># paid to</span>
<span class="token keyword">select</span> 
	paid_to<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'in'</span>
<span class="token keyword">from</span> 
	<span class="token keyword">transactions</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> paid_to
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"paid_to"</span><span class="token punctuation">,</span> <span class="token string">"in"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
<span class="token comment"># 说明id = 1,2,3 分别一共收到200,500,400</span>
</code></pre>
<p>那么用 CTE 把他们合起来，方便接下来的操作</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> paid_to <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> paid_to<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'in'</span>
    <span class="token keyword">from</span> <span class="token keyword">Transactions</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> paid_to
<span class="token punctuation">)</span><span class="token punctuation">,</span>
paid_by <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> paid_by<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'out'</span>
    <span class="token keyword">from</span> <span class="token keyword">Transactions</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> paid_by
<span class="token punctuation">)</span>
</code></pre>
<p>接下来的三步，可以合在一起来看，就是根据之前的那个公式来计算最后每个人的 balance，再用 if 来判断违约情况，最后 join 取出需要的列！</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
    u<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    u<span class="token punctuation">.</span>user_name<span class="token punctuation">,</span>
    u<span class="token punctuation">.</span>credit <span class="token operator">+</span> ifnull<span class="token punctuation">(</span>pt<span class="token punctuation">.</span><span class="token operator">in</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> ifnull<span class="token punctuation">(</span>pb<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> credit<span class="token punctuation">,</span>
    <span class="token comment"># credit + 转入 - 转出 = balance</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>credit <span class="token operator">+</span> ifnull<span class="token punctuation">(</span>pt<span class="token punctuation">.</span><span class="token operator">in</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> ifnull<span class="token punctuation">(</span>pb<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'Yes'</span><span class="token punctuation">,</span><span class="token string">'No'</span><span class="token punctuation">)</span> 
    <span class="token keyword">as</span> credit_limit_breached
    <span class="token comment"># 判断是否违约，注意这里不能用 alias 也就是 credit 代替</span>
<span class="token keyword">from</span> Users u
<span class="token keyword">left</span> <span class="token keyword">join</span> paid_to pt
<span class="token comment"># left join 是因为 id = 4 没有转账，所以是0，前面的 ifnull 也是为了处理缺失值</span>
<span class="token keyword">on</span> u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> pt<span class="token punctuation">.</span>paid_to
<span class="token keyword">left</span> <span class="token keyword">join</span> paid_by pb
<span class="token comment"># 同上</span>
<span class="token keyword">on</span> u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> pb<span class="token punctuation">.</span>paid_by<span class="token punctuation">;</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> paid_to <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> paid_to<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'in'</span>
    <span class="token keyword">from</span> <span class="token keyword">Transactions</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> paid_to
<span class="token punctuation">)</span><span class="token punctuation">,</span>
paid_by <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> paid_by<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'out'</span>
    <span class="token keyword">from</span> <span class="token keyword">Transactions</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> paid_by
<span class="token punctuation">)</span>

<span class="token keyword">select</span>
    u<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    u<span class="token punctuation">.</span>user_name<span class="token punctuation">,</span>
    u<span class="token punctuation">.</span>credit <span class="token operator">+</span> ifnull<span class="token punctuation">(</span>pt<span class="token punctuation">.</span><span class="token operator">in</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> ifnull<span class="token punctuation">(</span>pb<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> credit<span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>credit <span class="token operator">+</span> ifnull<span class="token punctuation">(</span>pt<span class="token punctuation">.</span><span class="token operator">in</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> ifnull<span class="token punctuation">(</span>pb<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'Yes'</span><span class="token punctuation">,</span><span class="token string">'No'</span><span class="token punctuation">)</span> 
    <span class="token keyword">as</span> credit_limit_breached
<span class="token keyword">from</span> Users u
<span class="token keyword">left</span> <span class="token keyword">join</span> paid_to pt
<span class="token keyword">on</span> u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> pt<span class="token punctuation">.</span>paid_to
<span class="token keyword">left</span> <span class="token keyword">join</span> paid_by pb
<span class="token keyword">on</span> u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> pb<span class="token punctuation">.</span>paid_by<span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm7.png?raw=true">
</p>
<h3 id="span-id88.-calculate-salariesspan"><span id="8">8. Calculate Salaries</span></h3>
<p>Table  <code>Salaries</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> company_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> employee_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> employee_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> salary        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(company_id, employee_id)</code> is the primary key for this table.</p>
<p>This table contains the company id, the id, the name and the salary for an employee.</p>
<p>Write an SQL query to find the salaries of the employees after applying taxes.</p>
<p>The tax rate is calculated for each company based on the following criteria:</p>
<ul>
<li>0% If the max salary of any employee in the company is less than 1000$.</li>
<li>24% If the max salary of any employee in the company is in the range [1000, 10000] inclusive.</li>
<li>49% If the max salary of any employee in the company is greater than 10000$.</li>
</ul>
<p>Return the result table  <strong>in any order</strong>. Round the salary to the nearest integer.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Salaries table:</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+---------------+--------+</span>
<span class="token operator">|</span> company_id <span class="token operator">|</span> employee_id <span class="token operator">|</span> employee_name <span class="token operator">|</span> salary <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+---------------+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Tony          <span class="token operator">|</span> <span class="token number">2000</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Pronub        <span class="token operator">|</span> <span class="token number">21300</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Tyrrox        <span class="token operator">|</span> <span class="token number">10800</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Pam           <span class="token operator">|</span> <span class="token number">300</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> Bassem        <span class="token operator">|</span> <span class="token number">450</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">9</span>           <span class="token operator">|</span> Hermione      <span class="token operator">|</span> <span class="token number">700</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> Bocaben       <span class="token operator">|</span> <span class="token number">100</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Ognjen        <span class="token operator">|</span> <span class="token number">2200</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">13</span>          <span class="token operator">|</span> Nyancat       <span class="token operator">|</span> <span class="token number">3300</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">15</span>          <span class="token operator">|</span> Morninngcat   <span class="token operator">|</span> <span class="token number">1866</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+---------------+--------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+---------------+--------+</span>
<span class="token operator">|</span> company_id <span class="token operator">|</span> employee_id <span class="token operator">|</span> employee_name <span class="token operator">|</span> salary <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+---------------+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Tony          <span class="token operator">|</span> <span class="token number">1020</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Pronub        <span class="token operator">|</span> <span class="token number">10863</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Tyrrox        <span class="token operator">|</span> <span class="token number">5508</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Pam           <span class="token operator">|</span> <span class="token number">300</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> Bassem        <span class="token operator">|</span> <span class="token number">450</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">9</span>           <span class="token operator">|</span> Hermione      <span class="token operator">|</span> <span class="token number">700</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> Bocaben       <span class="token operator">|</span> <span class="token number">76</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Ognjen        <span class="token operator">|</span> <span class="token number">1672</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">13</span>          <span class="token operator">|</span> Nyancat       <span class="token operator">|</span> <span class="token number">2508</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">15</span>          <span class="token operator">|</span> Morninngcat   <span class="token operator">|</span> <span class="token number">5911</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+---------------+--------+</span>
</code></pre>
<p>For company 1, Max salary is 21300. Employees in company 1 have taxes = 49%</p>
<p>For company 2, Max salary is 700. Employees in company 2 have taxes = 0%</p>
<p>For company 3, Max salary is 7777. Employees in company 3 have taxes = 24%</p>
<p>The salary after taxes = salary - (taxes percentage / 100) * salary</p>
<p>For example, Salary for Morninngcat (3, 15) after taxes = 7777 - 7777 * (24 / 100) = 7777 - 1866.48 = 5910.52, which is rounded to 5911.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>根据文中信息，我们需要计算出三种情况下的税，并算出每个公司，每个人的扣税后的工资：</p>
<ul>
<li>如果公司中任何员工的最高工资低于1000，则不扣税</li>
<li>如果公司中任何员工的最高薪水在[1000，10000]，扣除 24% 的税</li>
<li>如果公司中任何员工的最高薪水大于10000，扣除 49% 的税</li>
</ul>
<p>那么我们要按步骤来解决问题：</p>
<ul>
<li>计算出每个公司的所有员工的最高工资</li>
<li>根据三个条件，计算税后工资</li>
</ul>
<p><strong>第一步</strong>，我们有：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	company_id<span class="token punctuation">,</span> 
	employee_id<span class="token punctuation">,</span> 
	employee_name<span class="token punctuation">,</span> 
	salary<span class="token punctuation">,</span> 
	<span class="token function">max</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> company_id<span class="token punctuation">)</span> <span class="token keyword">as</span> maxsal
	<span class="token comment"># max也可以用partition by来对每个company_id的最大值来进行拆分计算</span>
	<span class="token comment"># https://www.sqltutorial.org/sql-window-functions/sql-partition-by/</span>
<span class="token keyword">from</span> salaries
</code></pre>
<p>结果如下:</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"company_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_id"</span><span class="token punctuation">,</span> <span class="token string">"employee_name"</span><span class="token punctuation">,</span> <span class="token string">"salary"</span><span class="token punctuation">,</span> <span class="token string">"maxsal"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tony"</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">21300</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Pronub"</span><span class="token punctuation">,</span> <span class="token number">21300</span><span class="token punctuation">,</span> <span class="token number">21300</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Tyrrox"</span><span class="token punctuation">,</span> <span class="token number">10800</span><span class="token punctuation">,</span> <span class="token number">21300</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Pam"</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"Bassem"</span><span class="token punctuation">,</span> <span class="token number">450</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"Hermione"</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"Bocaben"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Ognjen"</span><span class="token punctuation">,</span> <span class="token number">2200</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">"Nyancat"</span><span class="token punctuation">,</span> <span class="token number">3300</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">"Morninngcat"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么通过 CTE，并继续用 case when 来判断是否满足交税条件。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> tmp <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> 
	company_id<span class="token punctuation">,</span> 
	employee_id<span class="token punctuation">,</span> 
	employee_name<span class="token punctuation">,</span> 
	salary<span class="token punctuation">,</span> 
	<span class="token function">max</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> company_id<span class="token punctuation">)</span> <span class="token keyword">as</span> maxsal
<span class="token keyword">from</span> salaries<span class="token punctuation">)</span>

<span class="token keyword">select</span> 
	company_id<span class="token punctuation">,</span> 
	employee_id<span class="token punctuation">,</span> 
	employee_name<span class="token punctuation">,</span> 
	<span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">case</span> 
			<span class="token keyword">when</span> maxsal <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token keyword">then</span> salary
			<span class="token keyword">when</span> maxsal <span class="token operator">&gt;</span> <span class="token number">10000</span> <span class="token keyword">then</span> salary<span class="token operator">*</span><span class="token number">0.51</span>
			<span class="token keyword">else</span> salary<span class="token operator">*</span><span class="token number">0.76</span> 
		  <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> salary
<span class="token keyword">from</span> tmp
</code></pre>
<p><font color="red">另一个答案</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	<span class="token number">a</span><span class="token punctuation">.</span>company_id<span class="token punctuation">,</span> 
	<span class="token number">a</span><span class="token punctuation">.</span>employee_id<span class="token punctuation">,</span> 
	<span class="token number">a</span><span class="token punctuation">.</span>employee_name<span class="token punctuation">,</span> 
	<span class="token function">round</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>salary<span class="token operator">*</span><span class="token number">b</span><span class="token punctuation">.</span>multiplier<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'salary'</span>
<span class="token keyword">from</span> salaries <span class="token number">a</span>
<span class="token keyword">join</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> 
    company_id<span class="token punctuation">,</span> employee_id<span class="token punctuation">,</span> employee_name<span class="token punctuation">,</span>
    <span class="token keyword">case</span> 
        <span class="token keyword">when</span> <span class="token function">max</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token keyword">then</span> <span class="token number">1</span>
        <span class="token keyword">when</span> <span class="token function">max</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token operator">between</span> <span class="token number">1000</span> <span class="token operator">and</span> <span class="token number">10000</span> <span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0.24</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0.49</span><span class="token punctuation">)</span> 
    <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token string">'multiplier'</span>
    <span class="token comment"># case when 筛选出了税收的乘子</span>
<span class="token keyword">from</span> salaries
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">b</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span>company_id<span class="token punctuation">)</span>
<span class="token comment"># 根据 company_id 把两个表join到一起</span>
<span class="token comment"># 使得乘子和工资相乘成为税后工资</span>
</code></pre>
<p>经过试验，这两个写法的速度平均都超过的 88% 的用户，所以都是可取的。</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm8.png?raw=true">
</p>
<h3 id="span-id99.-capital-gainlossspan"><span id="9">9. Capital Gain/Loss</span></h3>
<p>Table:  <code>Stocks</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> stock_name    <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> operation     <span class="token operator">|</span> <span class="token keyword">enum</span>    <span class="token operator">|</span>
<span class="token operator">|</span> operation_day <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> price         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(stock_name, day)</code> is the primary key for this table.</p>
<p>The operation column is an ENUM of type <code>('Sell', 'Buy')</code></p>
<p>Each row of this table indicates that the stock which has <code>stock_name</code> had an operation on the day operation_day with the price.</p>
<p>It is guaranteed that each ‘Sell’ operation for a stock has a corresponding ‘Buy’ operation in a previous day.</p>
<p>Write an SQL query to report the Capital gain/loss for each stock.</p>
<p>The capital gain/loss of a stock is total gain or loss after buying and selling the stock one or many times.</p>
<p>Return the result table in any order.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Stock table:</span>
<span class="token operator">+</span><span class="token comment">---------------+-----------+---------------+--------+</span>
<span class="token operator">|</span> stock_name    <span class="token operator">|</span> operation <span class="token operator">|</span> operation_day <span class="token operator">|</span> price  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-----------+---------------+--------+</span>
<span class="token operator">|</span> Leetcode      <span class="token operator">|</span> Buy       <span class="token operator">|</span> <span class="token number">1</span>             <span class="token operator">|</span> <span class="token number">1000</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Corona Masks  <span class="token operator">|</span> Buy       <span class="token operator">|</span> <span class="token number">2</span>             <span class="token operator">|</span> <span class="token number">10</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Leetcode      <span class="token operator">|</span> Sell      <span class="token operator">|</span> <span class="token number">5</span>             <span class="token operator">|</span> <span class="token number">9000</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Handbags      <span class="token operator">|</span> Buy       <span class="token operator">|</span> <span class="token number">17</span>            <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Corona Masks  <span class="token operator">|</span> Sell      <span class="token operator">|</span> <span class="token number">3</span>             <span class="token operator">|</span> <span class="token number">1010</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Corona Masks  <span class="token operator">|</span> Buy       <span class="token operator">|</span> <span class="token number">4</span>             <span class="token operator">|</span> <span class="token number">1000</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Corona Masks  <span class="token operator">|</span> Sell      <span class="token operator">|</span> <span class="token number">5</span>             <span class="token operator">|</span> <span class="token number">500</span>    <span class="token operator">|</span>
<span class="token operator">|</span> Corona Masks  <span class="token operator">|</span> Buy       <span class="token operator">|</span> <span class="token number">6</span>             <span class="token operator">|</span> <span class="token number">1000</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Handbags      <span class="token operator">|</span> Sell      <span class="token operator">|</span> <span class="token number">29</span>            <span class="token operator">|</span> <span class="token number">7000</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Corona Masks  <span class="token operator">|</span> Sell      <span class="token operator">|</span> <span class="token number">10</span>            <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-----------+---------------+--------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------------+</span>
<span class="token operator">|</span> stock_name    <span class="token operator">|</span> capital_gain_loss <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------------+</span>
<span class="token operator">|</span> Corona Masks  <span class="token operator">|</span> <span class="token number">9500</span>              <span class="token operator">|</span>
<span class="token operator">|</span> Leetcode      <span class="token operator">|</span> <span class="token number">8000</span>              <span class="token operator">|</span>
<span class="token operator">|</span> Handbags      <span class="token operator">|</span> <span class="token operator">-</span><span class="token number">23000</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------------+</span>
</code></pre>
<p>Leetcode stock was bought at day 1 for 1000$ and was sold at day 5 for 9000. Capital gain = 9000 - 1000 = 8000.</p>
<p>Handbags stock was bought at day 17 for 30000 and was sold at day 29 for 7000. Capital loss = 7000 - 30000 = -23000.</p>
<p>Corona Masks stock was bought at day 1 for 10$ and was sold at day 3 for 1010. It was bought again at day 4 for 1000 and was sold at day 5 for 500$.</p>
<p>At last, it was bought at day 6 for 1000 and was sold at day 10 for 10000. Capital gain/loss is the sum of capital gains/losses for each (‘Buy’ --&gt; ‘Sell’) operation = (1010 - 10) + (500 - 1000) + (10000 - 1000) = 1000 - 500 + 9000 = 9500.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>还记第七题中我们要分别计算 paid_to 和 paid_by 的总额，最后再把他们进行计算，本题也是这样把 sell 的总和减去 buy 的总和即可</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	stock_name<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> operation <span class="token operator">=</span> <span class="token string">'Buy'</span> <span class="token keyword">then</span> <span class="token operator">-</span>price <span class="token keyword">else</span> price <span class="token keyword">end</span><span class="token punctuation">)</span> 
    <span class="token keyword">as</span> capital_gain_loss 
    <span class="token comment"># buy 则要减去 price</span>
    <span class="token comment"># sell 则加上</span>
<span class="token keyword">from</span> stocks
<span class="token keyword">group</span> <span class="token keyword">by</span> stock_name
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm9.png?raw=true">
</p>
<h3 id="span-id1010.-consecutive-numbersspan"><span id="10">10. Consecutive Numbers</span></h3>
<p>Write a SQL query to find all numbers that appear at least three times consecutively.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----+-----+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> Num <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span>  <span class="token number">1</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span>  <span class="token number">1</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span>  <span class="token number">1</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span>  <span class="token number">2</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>  <span class="token operator">|</span>  <span class="token number">1</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>  <span class="token operator">|</span>  <span class="token number">2</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span>  <span class="token number">2</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----+</span>
</code></pre>
<p>For example, given the above  <code>Logs</code>  table,  <code>1</code>  is the only number that appears consecutively for at least three times.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------------+</span>
<span class="token operator">|</span> ConsecutiveNums <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>同一数字连续出现意味着：</p>
<ul>
<li>他们的 id 是紧挨着的</li>
<li>他们的值相等</li>
</ul>
<p>那么我们可以用三个别名命名 Logs，然后查看是否存在三个连续数字是相等的，对于超过三个的情况，是等同于三个连续的情况，因为超过三个数字连续必然其中的任意三个连续 id 的数字是相等的。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> <span class="token number">a</span><span class="token punctuation">.</span>num <span class="token keyword">as</span> ConsecutiveNums 
<span class="token keyword">from</span> 
	logs <span class="token number">a</span><span class="token punctuation">,</span>
	logs <span class="token number">b</span><span class="token punctuation">,</span>
	logs <span class="token number">c</span>
<span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>id
<span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">c</span><span class="token punctuation">.</span>id
<span class="token comment"># id 紧挨着</span>
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>num 
<span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">c</span><span class="token punctuation">.</span>num
<span class="token comment"># num 相等</span>
</code></pre>
<p>另一种写法：</p>
<p>介绍一下两个函数：</p>
<ul>
<li><a href="https://www.sqlservertutorial.net/sql-server-window-functions/sql-server-lag-function/">lag</a> 是一个窗口函数，它提供对位于当前行之前的指定 offset 的行的访问，默认为 1</li>
<li><a href="https://www.sqlservertutorial.net/sql-server-window-functions/sql-server-lead-function/">lead</a> 则是相反</li>
</ul>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>Num<span class="token punctuation">)</span> <span class="token keyword">as</span> ConsecutiveNums
<span class="token keyword">from</span> <span class="token punctuation">(</span>
	<span class="token keyword">select</span>
	Num<span class="token punctuation">,</span>
	lag<span class="token punctuation">(</span>Num<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> above<span class="token punctuation">,</span>
	<span class="token comment"># lag可以查看前一行的值</span>
	lead<span class="token punctuation">(</span>Num<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> below
	<span class="token comment"># lead可查看后一行的值</span>
	<span class="token keyword">from</span> Logs
	<span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">where</span> Num<span class="token operator">=</span>above
<span class="token operator">and</span> Num<span class="token operator">=</span>below
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm10.png?raw=true">
</p>
<h3 id="span-id1111.-count-student-number-in-departmentsspan"><span id="11">11. Count Student Number in Departments</span></h3>
<p>A university uses 2 data tables,  <strong><em>student</em></strong>  and  <strong><em>department</em></strong>, to store data about its students and the departments associated with each major.</p>
<p>Write a query to print the respective department name and number of students majoring in each department for all departments in the  <strong><em>department</em></strong>  table (even ones with no current students).</p>
<p>Sort your results by descending number of students; if two or more departments have the same number of students, then sort those departments alphabetically by department name.</p>
<p>The  <strong><em>student</em></strong>  is described as follow:</p>

<table>
<thead>
<tr>
<th>Column Name</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>student_id</td>
<td>Integer</td>
</tr>
<tr>
<td>student_name</td>
<td>String</td>
</tr>
<tr>
<td>gender</td>
<td>Character</td>
</tr>
<tr>
<td>dept_id</td>
<td>Integer</td>
</tr>
</tbody>
</table><p>where student_id is the student’s ID number, student_name is the student’s name, gender is their gender, and dept_id is the department ID associated with their declared major.</p>
<p>And the  <strong><em>department</em></strong>  table is described as below:</p>

<table>
<thead>
<tr>
<th>Column Name</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>dept_id</td>
<td>Integer</td>
</tr>
<tr>
<td>dept_name</td>
<td>String</td>
</tr>
</tbody>
</table><p>where dept_id is the department’s ID number and dept_name is the department name.</p>
<p>Here is an example  <strong>input</strong>:<br>
<strong><em>student</em></strong>  table:</p>

<table>
<thead>
<tr>
<th>student_id</th>
<th>student_name</th>
<th>gender</th>
<th>dept_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Jack</td>
<td>M</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>Jane</td>
<td>F</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>Mark</td>
<td>M</td>
<td>2</td>
</tr>
</tbody>
</table><p><strong><em>department</em></strong>  table:</p>

<table>
<thead>
<tr>
<th>dept_id</th>
<th>dept_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Engineering</td>
</tr>
<tr>
<td>2</td>
<td>Science</td>
</tr>
<tr>
<td>3</td>
<td>Law</td>
</tr>
</tbody>
</table><p>The  <strong>Output</strong>  should be:</p>

<table>
<thead>
<tr>
<th>dept_name</th>
<th>student_number</th>
</tr>
</thead>
<tbody>
<tr>
<td>Engineering</td>
<td>2</td>
</tr>
<tr>
<td>Science</td>
<td>1</td>
</tr>
<tr>
<td>Law</td>
<td>0</td>
</tr>
</tbody>
</table><p><font color="#EA5FD4">详解：</font></p>
<p>这个题目比较简单，我们要去计算每个 dept_name 对应的学生数量，这个题的难度甚至可以归类为简单。</p>
<p>我们只需要把表格连接到一起（注意缺失值）然后 count 每个 dept_name 对应的学生数量即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token number">d</span><span class="token punctuation">.</span>dept_name<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>student_id<span class="token punctuation">)</span> <span class="token keyword">as</span> student_number
<span class="token keyword">from</span> department <span class="token number">d</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> student s
<span class="token keyword">using</span> <span class="token punctuation">(</span>dept_id<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">d</span><span class="token punctuation">.</span>dept_id
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">2</span> <span class="token keyword">desc</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm11.png?raw=true">
</p>
<h3 id="span-id1212.-countries-you-can-safely-invest-inspan"><span id="12">12. Countries You Can Safely Invest In</span></h3>
<p>Table  <code>Person</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name    <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> id             <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name           <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> phone_number   <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
</code></pre>
<p><code>id</code> is the primary key for this table.<br>
Each row of this table contains the name of a person and their phone number.</p>
<p>Phone number will be in the form ‘xxx-yyyyyyy’ where xxx is the country code (3 characters) and yyyyyyy is the phone number (7 characters) where x and y are digits. Both can contain leading zeros.</p>
<p>Table  <code>Country</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name    <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> name           <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> country_code   <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
</code></pre>
<p><code>country_code</code> is the primary key for this table.</p>
<p>Each row of this table contains the country name and its code.</p>
<p><code>country_code</code> will be in the form ‘xxx’ where x is digits.</p>
<p>Table  <code>Calls</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------+</span>
<span class="token operator">|</span> caller_id   <span class="token operator">|</span> <span class="token keyword">int</span>  <span class="token operator">|</span>
<span class="token operator">|</span> callee_id   <span class="token operator">|</span> <span class="token keyword">int</span>  <span class="token operator">|</span>
<span class="token operator">|</span> duration    <span class="token operator">|</span> <span class="token keyword">int</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------+</span>
</code></pre>
<p>There is no primary key for this table, it may contain duplicates.<br>
Each row of this table contains the caller id, callee id and the duration of the call in minutes. <code>caller_id != callee_id</code></p>
<p>A telecommunications company wants to invest in new countries. The company intends to invest in the countries where the average call duration of the calls in this country is strictly greater than the global average call duration.</p>
<p>Write an SQL query to find the countries where this company can invest.</p>
<p>Return the result table in any order.</p>
<p>The query result format is in the following example.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># person table:</span>
<span class="token operator">+</span><span class="token comment">----+----------+--------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name     <span class="token operator">|</span> phone_number <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+--------------+</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Jonathan <span class="token operator">|</span> <span class="token number">051</span><span class="token operator">-</span><span class="token number">1234567</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">12</span> <span class="token operator">|</span> Elvis    <span class="token operator">|</span> <span class="token number">051</span><span class="token operator">-</span><span class="token number">7654321</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Moncef   <span class="token operator">|</span> <span class="token number">212</span><span class="token operator">-</span><span class="token number">1234567</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Maroua   <span class="token operator">|</span> <span class="token number">212</span><span class="token operator">-</span><span class="token number">6523651</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>  <span class="token operator">|</span> Meir     <span class="token operator">|</span> <span class="token number">972</span><span class="token operator">-</span><span class="token number">1234567</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>  <span class="token operator">|</span> Rachel   <span class="token operator">|</span> <span class="token number">972</span><span class="token operator">-</span><span class="token number">0011100</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+--------------+</span>

<span class="token comment"># country table:</span>
<span class="token operator">+</span><span class="token comment">----------+--------------+</span>
<span class="token operator">|</span> name     <span class="token operator">|</span> country_code <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+--------------+</span>
<span class="token operator">|</span> Peru     <span class="token operator">|</span> <span class="token number">051</span>          <span class="token operator">|</span>
<span class="token operator">|</span> Israel   <span class="token operator">|</span> <span class="token number">972</span>          <span class="token operator">|</span>
<span class="token operator">|</span> Morocco  <span class="token operator">|</span> <span class="token number">212</span>          <span class="token operator">|</span>
<span class="token operator">|</span> Germany  <span class="token operator">|</span> <span class="token number">049</span>          <span class="token operator">|</span>
<span class="token operator">|</span> Ethiopia <span class="token operator">|</span> <span class="token number">251</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+--------------+</span>

<span class="token comment"># calls table:</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+----------+</span>
<span class="token operator">|</span> caller_id <span class="token operator">|</span> callee_id <span class="token operator">|</span> duration <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">9</span>         <span class="token operator">|</span> <span class="token number">33</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">9</span>         <span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">59</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">12</span>        <span class="token operator">|</span> <span class="token number">102</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">12</span>        <span class="token operator">|</span> <span class="token number">330</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">12</span>        <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">9</span>         <span class="token operator">|</span> <span class="token number">13</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>         <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">7</span>         <span class="token operator">|</span> <span class="token number">7</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+----------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> country  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> Peru     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
</code></pre>
<pre><code>Explaination:

The average call duration for Peru is (102 + 102 + 330 + 330 + 5 + 5) / 6 = 145.666667
The average call duration for Israel is (33 + 4 + 13 + 13 + 3 + 1 + 1 + 7) / 8 = 9.37500
The average call duration for Morocco is (33 + 4 + 59 + 59 + 3 + 7) / 6 = 27.5000 
Global call duration average = (2 * (33 + 3 + 59 + 102 + 330 + 5 + 13 + 3 + 1 + 7)) / 20 = 55.70000
Since Peru is the only country where average call duration is greater than the global average, 
it's the only recommended country.
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题目的是找出所有国家平均 duration 大于全球平均 duration 的国家。</p>
<p>那么我们需要解决下面几个问题：</p>
<ul>
<li>每个国家的 duration 如何计算</li>
<li>怎么去掉 ‘_’ 后面的电话号码</li>
<li>全球 duration 平均如何计算</li>
</ul>
<p>那么第一步其实是最复杂的，因为从原文解释中，我们知道不管是打电话还是接电话，我们都要计算其 duration，那么我们只需要用 or 来把 person 和 country 两个表格连接到一起；也就是在用 on 来连接时，既把 caller_id 也把 callee_id 和 person 中的 id 连接。</p>
<p>那么，同时我们也要把 country 连接进来，才能去找每个地区对应的平均 duration。这里我们用 left 函数来去字符串前 n 个字符，这里 n = 3。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> tmp <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span>name <span class="token keyword">as</span> <span class="token string">'country'</span><span class="token punctuation">,</span> duration
<span class="token keyword">from</span> person <span class="token number">a</span>
<span class="token keyword">join</span> calls <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>caller_id
<span class="token operator">or</span> <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>callee_id
<span class="token keyword">join</span> country <span class="token number">c</span>
<span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span>country_code <span class="token operator">=</span> <span class="token keyword">left</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>phone_number<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"country"</span><span class="token punctuation">,</span> <span class="token string">"duration"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Morocco"</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Morocco"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Morocco"</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Morocco"</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Peru"</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Peru"</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Peru"</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Peru"</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Peru"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Peru"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Morocco"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Israel"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Morocco"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么接下来，我们只需要求每个地方的 duration 并判断是否大于全球平均的 duration 即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> tmp <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span>name <span class="token keyword">as</span> <span class="token string">'country'</span><span class="token punctuation">,</span> duration
<span class="token keyword">from</span> person <span class="token number">a</span>
<span class="token keyword">join</span> calls <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>caller_id
<span class="token operator">or</span> <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>callee_id
<span class="token keyword">join</span> country <span class="token number">c</span>
<span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span>country_code <span class="token operator">=</span> <span class="token keyword">left</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>phone_number<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">select</span> country
<span class="token keyword">from</span> tmp
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">having</span> <span class="token function">avg</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token keyword">from</span> calls<span class="token punctuation">)</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm12.png?raw=true">
</p>
<h3 id="span-id1313.-customers-who-bought-all-productsspan"><span id="13">13. Customers Who Bought All Products</span></h3>
<p>Table: <code>Customer</code></p>
<p>±------------±--------+<br>
| Column Name | Type    |<br>
±------------±--------+<br>
| customer_id | int     |<br>
| product_key | int     |<br>
±------------±--------+<br>
product_key is a foreign key to <code>Product</code> table.</p>
<p>Table: <code>Product</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> product_key <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p><code>product_key</code> is the primary key column for this table.</p>
<p>Write an SQL query for a report that provides the customer ids from the <code>Customer</code> table that bought all the products in the  <code>Product</code> table.</p>
<p>For example:</p>
<p>Customer table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span> product_key <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
</code></pre>
<p>Product table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> product_key <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p>Result table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p>The customers who bought all the products (5 and 6) are customers with id 1 and 3.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题比较简单，要我们找到购买所有产品的顾客，那么我们只需计算每个顾客购买的产品总数，看看是否等于 product 表里的产品总数。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> customer_id
<span class="token keyword">from</span> customer
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> product_key<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> product<span class="token punctuation">)</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm13.png?raw=true">
</p>
<h3 id="span-id1414.-customers-who-bought-products-a-and-b-but-not-cspan"><span id="14">14. Customers Who Bought Products A and B but Not C</span></h3>
<p>Table:  <code>Customers</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name         <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+</span>
<span class="token operator">|</span> customer_id         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> customer_name       <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------+</span>
</code></pre>
<p><code>customer_id</code> is the primary key for this table.<br>
<code>customer_name</code> is the name of the customer.</p>
<p>Table:  <code>Orders</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> order_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> customer_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> product_name  <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>order_id</code> is the primary key for this table.</p>
<p><code>customer_id</code> is the id of the customer who bought the product “product_name”.</p>
<p>Write an SQL query to report the <code>customer_id</code> and customer_name of customers who bought products “A”, “B” but did not buy the product “C” since we want to recommend them buy this product.</p>
<p>Return the result table  <strong>ordered</strong>  by customer_id.</p>
<p>The query result format is in the following example.</p>
<pre class=" language-sql"><code class="prism  language-sql">Customers <span class="token keyword">table</span>:
<span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span> customer_name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Daniel        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Diana         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Elizabeth     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> Jhon          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
</code></pre>
<p>Orders table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------+--------------+---------------+</span>
<span class="token operator">|</span> order_id   <span class="token operator">|</span> customer_id  <span class="token operator">|</span> product_name  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">10</span>         <span class="token operator">|</span>     <span class="token number">1</span>        <span class="token operator">|</span>     A         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">20</span>         <span class="token operator">|</span>     <span class="token number">1</span>        <span class="token operator">|</span>     B         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">30</span>         <span class="token operator">|</span>     <span class="token number">1</span>        <span class="token operator">|</span>     D         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span>         <span class="token operator">|</span>     <span class="token number">1</span>        <span class="token operator">|</span>     C         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">50</span>         <span class="token operator">|</span>     <span class="token number">2</span>        <span class="token operator">|</span>     A         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">60</span>         <span class="token operator">|</span>     <span class="token number">3</span>        <span class="token operator">|</span>     A         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">70</span>         <span class="token operator">|</span>     <span class="token number">3</span>        <span class="token operator">|</span>     B         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">80</span>         <span class="token operator">|</span>     <span class="token number">3</span>        <span class="token operator">|</span>     D         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">90</span>         <span class="token operator">|</span>     <span class="token number">4</span>        <span class="token operator">|</span>     C         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+</span>
</code></pre>
<p>Result table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span> customer_name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Elizabeth     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
</code></pre>
<p>Only the customer_id with id 3 bought the product A and B but not the product C.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找只买 A 和 B 并没有买 C 的顾客，那么我们首先该计算每个顾客分别买 A、B、C 的个数</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
    customer_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'A'</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'B'</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'C'</span>
<span class="token keyword">from</span> orders
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"customer_id"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么从上面的结果来看，自然是 customer_id = 3时，满足条件，那么我们进行一下修改。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> customers 
<span class="token keyword">where</span> customer_id <span class="token operator">in</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> customer_id
<span class="token keyword">from</span> orders
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1</span>
<span class="token operator">and</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1</span>
<span class="token operator">and</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>product_name <span class="token operator">=</span> <span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># having筛选 A &gt;= 1 and B &gt;= 1 and c = 0</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm14.png?raw=true">
</p>
<h3 id="span-id1515.-department-highest-salaryspan"><span id="15">15. Department Highest Salary</span></h3>
<p>The  <code>Employee</code>  table holds all employees. Every employee has an Id, a salary, and there is also a column for the department Id.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----+-------+--------+--------------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> Name  <span class="token operator">|</span> Salary <span class="token operator">|</span> DepartmentId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+--------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Joe   <span class="token operator">|</span> <span class="token number">70000</span>  <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Jim   <span class="token operator">|</span> <span class="token number">90000</span>  <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Henry <span class="token operator">|</span> <span class="token number">80000</span>  <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> Sam   <span class="token operator">|</span> <span class="token number">60000</span>  <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>  <span class="token operator">|</span> Max   <span class="token operator">|</span> <span class="token number">90000</span>  <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+--------+--------------+</span>
</code></pre>
<p>The  <code>Department</code>  table holds all departments of the company.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> Name     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> IT       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Sales    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
</code></pre>
<p>Write a SQL query to find employees who have the highest salary in each of the departments. For the above tables, your SQL query should return the following rows (order of rows does not matter).</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------+----------+--------+</span>
<span class="token operator">|</span> Department <span class="token operator">|</span> Employee <span class="token operator">|</span> Salary <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+----------+--------+</span>
<span class="token operator">|</span> IT         <span class="token operator">|</span> Max      <span class="token operator">|</span> <span class="token number">90000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> IT         <span class="token operator">|</span> Jim      <span class="token operator">|</span> <span class="token number">90000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Sales      <span class="token operator">|</span> Henry    <span class="token operator">|</span> <span class="token number">80000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+----------+--------+</span>
</code></pre>
<p><strong>Explanation:</strong></p>
<p>Max and Jim both have the highest salary in the IT department and Henry has the highest salary in the Sales department.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到每个 department 里面有最高 salary 的人。我们只需要用窗口函数来对每个 department 的人的工资进行降序排序并且找到序列等于 1 的人。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> Department<span class="token punctuation">,</span> Employee<span class="token punctuation">,</span> Salary <span class="token keyword">from</span>
<span class="token punctuation">(</span>
	<span class="token keyword">select</span> 
		<span class="token number">b</span><span class="token punctuation">.</span>name <span class="token keyword">as</span> <span class="token string">'Department'</span><span class="token punctuation">,</span> 
		<span class="token number">a</span><span class="token punctuation">.</span>Name <span class="token keyword">as</span> <span class="token string">'Employee'</span><span class="token punctuation">,</span>
	    salary<span class="token punctuation">,</span> 
	    dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token number">b</span><span class="token punctuation">.</span>id <span class="token keyword">order</span> <span class="token keyword">by</span> salary <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
	<span class="token keyword">from</span> employee <span class="token number">a</span>
	<span class="token keyword">join</span> department <span class="token number">b</span>
	<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>departmentid <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>id
<span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm15.png?raw=true">
</p>
<h3 id="span-id1616.-evaluate-boolean-expressionspan"><span id="16">16. Evaluate Boolean Expression</span></h3>
<p>Table  <code>Variables</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">value</span>         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>name</code> is the primary key for this table.<br>
This table contains the stored variables and their values.</p>
<p>Table  <code>Expressions</code>:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> left_operand  <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> operator      <span class="token operator">|</span> <span class="token keyword">enum</span>    <span class="token operator">|</span>
<span class="token operator">|</span> right_operand <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(left_operand, operator, right_operand)</code> is the primary key for this table.</p>
<p>This table contains a boolean expression that should be evaluated.<br>
operator is an enum that takes one of the values (’&lt;’, ‘&gt;’, ‘=’)</p>
<p>The values of left_operand and right_operand are guaranteed to be in the Variables table.</p>
<p>Write an SQL query to evaluate the boolean expressions in  <code>Expressions</code>  table.</p>
<p>Return the result table in any order.</p>
<p>The query result format is in the following example.</p>
<p>Variables table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------+-------+</span>
<span class="token operator">|</span> name <span class="token operator">|</span> <span class="token keyword">value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-------+</span>
<span class="token operator">|</span> x    <span class="token operator">|</span> <span class="token number">66</span>    <span class="token operator">|</span>
<span class="token operator">|</span> y    <span class="token operator">|</span> <span class="token number">77</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-------+</span>
</code></pre>
<p>Expressions table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+----------+---------------+</span>
<span class="token operator">|</span> left_operand <span class="token operator">|</span> operator <span class="token operator">|</span> right_operand <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------+---------------+</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">&gt;</span>        <span class="token operator">|</span> y             <span class="token operator">|</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">&lt;</span>        <span class="token operator">|</span> y             <span class="token operator">|</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">=</span>        <span class="token operator">|</span> y             <span class="token operator">|</span>
<span class="token operator">|</span> y            <span class="token operator">|</span> <span class="token operator">&gt;</span>        <span class="token operator">|</span> x             <span class="token operator">|</span>
<span class="token operator">|</span> y            <span class="token operator">|</span> <span class="token operator">&lt;</span>        <span class="token operator">|</span> x             <span class="token operator">|</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">=</span>        <span class="token operator">|</span> x             <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------+---------------+</span>
</code></pre>
<p>Result table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+----------+---------------+-------+</span>
<span class="token operator">|</span> left_operand <span class="token operator">|</span> operator <span class="token operator">|</span> right_operand <span class="token operator">|</span> <span class="token keyword">value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------+---------------+-------+</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">&gt;</span>        <span class="token operator">|</span> y             <span class="token operator">|</span> <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">&lt;</span>        <span class="token operator">|</span> y             <span class="token operator">|</span> <span class="token boolean">true</span>  <span class="token operator">|</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">=</span>        <span class="token operator">|</span> y             <span class="token operator">|</span> <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> y            <span class="token operator">|</span> <span class="token operator">&gt;</span>        <span class="token operator">|</span> x             <span class="token operator">|</span> <span class="token boolean">true</span>  <span class="token operator">|</span>
<span class="token operator">|</span> y            <span class="token operator">|</span> <span class="token operator">&lt;</span>        <span class="token operator">|</span> x             <span class="token operator">|</span> <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> x            <span class="token operator">|</span> <span class="token operator">=</span>        <span class="token operator">|</span> x             <span class="token operator">|</span> <span class="token boolean">true</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+----------+---------------+-------+</span>
</code></pre>
<p>As shown, you need find the value of each boolean exprssion in the table using the variables table.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要判断表格中的表示方法是否正确，也就是</p>
<ul>
<li>当 <code>operator = &gt;</code> 且左面的值大于右面的值，true</li>
<li>当 <code>operator = &lt;</code> 且左面的值小于右面的值，true</li>
<li>当 <code>operator = =</code> 且左面的值等于右面的值，true</li>
<li>其他情况，false</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	<span class="token number">e</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	<span class="token keyword">case</span> 
	    <span class="token keyword">when</span> operator <span class="token operator">=</span> <span class="token string">'='</span> <span class="token operator">and</span> v1<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token keyword">then</span> <span class="token string">'true'</span>
	    <span class="token keyword">when</span> operator <span class="token operator">=</span> <span class="token string">'&gt;'</span> <span class="token operator">and</span> v1<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token operator">&gt;</span> v2<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token keyword">then</span> <span class="token string">'true'</span>
	    <span class="token keyword">when</span> operator <span class="token operator">=</span> <span class="token string">'&lt;'</span> <span class="token operator">and</span> v1<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token operator">&lt;</span> v2<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token keyword">then</span> <span class="token string">'true'</span>
		<span class="token keyword">else</span> <span class="token string">'false'</span> <span class="token keyword">End</span> <span class="token string">'value'</span>
<span class="token keyword">from</span> Expressions <span class="token number">e</span> 
<span class="token keyword">join</span> Variables v1
<span class="token keyword">on</span> <span class="token number">e</span><span class="token punctuation">.</span>left_operand <span class="token operator">=</span> v1<span class="token punctuation">.</span>name 
<span class="token keyword">join</span> Variables v2
<span class="token keyword">on</span> <span class="token number">e</span><span class="token punctuation">.</span>right_operand <span class="token operator">=</span> v2<span class="token punctuation">.</span>name
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm16.png?raw=true">
</p>
<h3 id="span-id1717.-exchange-seatsspan"><span id="17">17. Exchange Seats</span></h3>
<p>Mary is a teacher in a middle school and she has a table  <code>seat</code>  storing students’ names and their corresponding seat ids.</p>
<p>The column <strong>id</strong> is continuous increment.</p>
<p>Mary wants to change seats for the adjacent students.</p>
<p>Can you write a SQL query to output the result for Mary?</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+---------+</span>
<span class="token operator">|</span>    id   <span class="token operator">|</span> student <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+</span>
<span class="token operator">|</span>    <span class="token number">1</span>    <span class="token operator">|</span> Abbot   <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span>    <span class="token operator">|</span> Doris   <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">3</span>    <span class="token operator">|</span> Emerson <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">4</span>    <span class="token operator">|</span> Green   <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">5</span>    <span class="token operator">|</span> Jeames  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+</span>
</code></pre>
<p>For the sample input, the output is:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+---------+</span>
<span class="token operator">|</span>    id   <span class="token operator">|</span> student <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+</span>
<span class="token operator">|</span>    <span class="token number">1</span>    <span class="token operator">|</span> Doris   <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span>    <span class="token operator">|</span> Abbot   <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">3</span>    <span class="token operator">|</span> Green   <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">4</span>    <span class="token operator">|</span> Emerson <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">5</span>    <span class="token operator">|</span> Jeames  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+</span>
</code></pre>
<p><strong>Note:</strong><br>
If the number of students is odd, there is no need to change the last one’s seat.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要把学生名称按照 id 的奇偶性来对调，那么有以下几种情况：</p>
<ul>
<li>当 id 为奇数，且不为最后一个，那么则 id 增加 1</li>
<li>当 id 为奇数，且为最后一个，那么 id 不变（落单了，不互换）</li>
<li>当 id 为偶数（不管是不是最后一个），都减去 1（偶数情况下，必然可以和前面的奇数位置互换！）</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
<span class="token punctuation">(</span><span class="token keyword">case</span> 
    <span class="token keyword">when</span> mod<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token operator">and</span> counts <span class="token operator">!=</span> id <span class="token keyword">then</span> id<span class="token operator">+</span><span class="token number">1</span>
    <span class="token keyword">when</span> mod<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token operator">and</span> counts <span class="token operator">=</span> id <span class="token keyword">then</span> id
    <span class="token keyword">else</span> id<span class="token number">-1</span>
<span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> student
<span class="token keyword">from</span>
    seat<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts <span class="token keyword">from</span> seat<span class="token punctuation">)</span> <span class="token keyword">as</span> seat_counts
<span class="token keyword">order</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm17.png?raw=true">
</p>
<h3 id="span-id1818.-find-the-start-and-end-number-of-continuous-rangesspan"><span id="18">18. Find the Start and End Number of Continuous Ranges</span></h3>
<p>Table:  <code>Logs</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> log_id        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>id</code> is the primary key for this table.<br>
Each row of this table contains the ID in a log Table.</p>
<p>Since some IDs have been removed from  <code>Logs</code>. Write an SQL query to find the start and end number of continuous ranges in table  <code>Logs</code>.</p>
<p>Order the result table by  <code>start_id</code>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Logs table:</span>
<span class="token operator">+</span><span class="token comment">------------+</span>
<span class="token operator">|</span> log_id     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+</span>

<span class="token comment"># Result table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+</span>
<span class="token operator">|</span> start_id   <span class="token operator">|</span> end_id       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>          <span class="token operator">|</span> <span class="token number">8</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span>         <span class="token operator">|</span> <span class="token number">10</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+</span>
</code></pre>
<p>The result table should contain all ranges in table Logs.</p>
<p>From 1 to 3 is contained in the table.</p>
<p>From 4 to 6 is missing in the table</p>
<p>From 7 to 8 is contained in the table.</p>
<p>Number 9 is missing in the table.</p>
<p>Number 10 is contained in the table.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到每段连续数字的开头和结尾，那么可以先尝试把所有数字用窗口函数从小到大排列。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> 
	log_id<span class="token punctuation">,</span>
    dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> log_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> rnk
<span class="token keyword">FROM</span> Logs 
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"log_id"</span><span class="token punctuation">,</span> <span class="token string">"rnk"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么我们发现这两列的差值好像有些地方相似，不放试一试。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> 
	l<span class="token punctuation">.</span>log_id<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>l<span class="token punctuation">.</span>log_id <span class="token operator">-</span> l<span class="token punctuation">.</span>rnk<span class="token punctuation">)</span> <span class="token keyword">AS</span> diff
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> 
		log_id<span class="token punctuation">,</span>
        dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> log_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> rnk
    <span class="token keyword">FROM</span> Logs   
<span class="token punctuation">)</span> l
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"log_id"</span><span class="token punctuation">,</span> <span class="token string">"diff"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>我们发现连续的数字对应的 <code>diff</code> 都是一样，那么我们可以对 <code>diff</code> 进行 group by，然后取最小值当做 start，最大值当做 end。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> log_diff <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> l<span class="token punctuation">.</span>log_id<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>l<span class="token punctuation">.</span>log_id <span class="token operator">-</span> l<span class="token punctuation">.</span>rnk<span class="token punctuation">)</span> <span class="token keyword">as</span> diff
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> log_id<span class="token punctuation">,</span>
        dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> log_id<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
        <span class="token keyword">from</span> Logs   
    <span class="token punctuation">)</span> l
<span class="token punctuation">)</span>

<span class="token keyword">select</span> 
    <span class="token function">min</span><span class="token punctuation">(</span>log_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'start_id'</span><span class="token punctuation">,</span>
    <span class="token function">max</span><span class="token punctuation">(</span>log_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'end_id'</span>
<span class="token keyword">from</span> log_diff
<span class="token keyword">group</span> <span class="token keyword">by</span> diff
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm18.png?raw=true">
</p>
<h3 id="span-id1919.-friend-requests-ii-who-has-the-most-friendsspan"><span id="19">19. Friend Requests II: Who Has the Most Friends</span></h3>
<p>先来回顾一下 <a href="https://zg104.github.io/sql#19"><em><strong>Friend Requests I: Overall Acceptance Rate</strong></em></a></p>
<p>In social network like Facebook or Twitter, people send friend requests and accept others’ requests as well.</p>
<p>Table  <code>request_accepted</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+-------------+------------+</span>
<span class="token operator">|</span> requester_id <span class="token operator">|</span> accepter_id <span class="token operator">|</span> accept_date<span class="token operator">|</span>
<span class="token operator">|</span><span class="token comment">--------------|-------------|------------|</span>
<span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> 2016_06<span class="token number">-03</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">08</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">08</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">09</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+-------------+------------+</span>
</code></pre>
<p>This table holds the data of friend acceptance, while <strong>requester_id</strong> and <strong>accepter_id</strong> both are the id of a person.</p>
<p>Write a query to find the the people who has most friends and the most friends number under the following rules:</p>
<ul>
<li>It is guaranteed there is only 1 people having the most friends.</li>
<li>The friend request could only been accepted once, which mean there is no multiple records with the same  <strong>requester_id</strong>  and  <strong>accepter_id</strong>  value.</li>
</ul>
<p>For the sample data above, the result is:</p>
<p>Result table:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> num  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token comment">------|------|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
</code></pre>
<p>The person with id ‘3’ is a friend of people ‘1’, ‘2’ and ‘4’, so he has 3 friends in total, which is the most number than any others.</p>
<p><strong>Follow-up:</strong><br>
In the real world, multiple people could have the same most number of friends, can you find all these people in this case?</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到有最多朋友的人，定义则是：</p>
<ul>
<li>只有一个人有最多的朋友</li>
<li>朋友申请只能接受一次，意味着没有多条拥有同样的 requester_id 和 accepter_id 的记录</li>
</ul>
<p>那么根据这个题的情况，id = 3 有最多的朋友，因为申请和接受是双向的，那么我们首先要搞清楚一共有多少个不同的人（不管是申请者还是接受者）</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> requester_id <span class="token keyword">as</span> <span class="token string">'all'</span> 
<span class="token keyword">from</span> request_accepted
<span class="token keyword">union</span> 
<span class="token keyword">select</span> accepter_id 
<span class="token keyword">from</span> request_accepted
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"all"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么接下来，我们需要把上面的记录和 request_accepted 合并，保证上面的人要么是申请者要么是接受者。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> requester_id <span class="token keyword">as</span> <span class="token string">'all'</span> <span class="token keyword">from</span> request_accepted
<span class="token keyword">union</span> 
<span class="token keyword">select</span> accepter_id <span class="token keyword">from</span> request_accepted<span class="token punctuation">)</span><span class="token punctuation">,</span>

t2 <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token keyword">as</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'num'</span>
<span class="token keyword">from</span> t1 <span class="token number">c</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> request_accepted r
<span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>requester_id
<span class="token operator">or</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>accepter_id
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"num"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么很容易可以看出，id = 3 是我们想要的，因为num 最大</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> requester_id <span class="token keyword">as</span> <span class="token string">'all'</span> <span class="token keyword">from</span> request_accepted
<span class="token keyword">union</span> 
<span class="token keyword">select</span> accepter_id <span class="token keyword">from</span> request_accepted<span class="token punctuation">)</span><span class="token punctuation">,</span>

t2 <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token keyword">as</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'num'</span>
<span class="token keyword">from</span> t1 <span class="token number">c</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> request_accepted r
<span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>requester_id
<span class="token operator">or</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>accepter_id
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2
<span class="token keyword">where</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">from</span> t2<span class="token punctuation">)</span>
</code></pre>
<p><strong>Follow-up:</strong></p>
<p>在现实世界中，多个人可能拥有相同数量的朋友，在这种情况下，您可以找到所有这些人吗？</p>
<p>这种情况，我们需要用 window function 来把 num 进行排序，rank = 1 的就是我们想要的，所以稍微改一下即可。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> requester_id <span class="token keyword">as</span> <span class="token string">'all'</span> <span class="token keyword">from</span> request_accepted
<span class="token keyword">union</span> 
<span class="token keyword">select</span> accepter_id <span class="token keyword">from</span> request_accepted<span class="token punctuation">)</span><span class="token punctuation">,</span>

t2 <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token keyword">as</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'num'</span><span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> t1 <span class="token number">c</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> request_accepted r
<span class="token keyword">on</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>requester_id
<span class="token operator">or</span> <span class="token number">c</span><span class="token punctuation">.</span><span class="token keyword">all</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>accepter_id
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">select</span> id<span class="token punctuation">,</span>num
<span class="token keyword">from</span> t2
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p>试验一下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>:{<span class="token string">"request_accepted"</span>:<span class="token punctuation">[</span><span class="token string">"requester_id"</span><span class="token punctuation">,</span><span class="token string">"accepter_id"</span><span class="token punctuation">,</span><span class="token string">"accept_date"</span><span class="token punctuation">]</span>}<span class="token punctuation">,</span>
<span class="token string">"rows"</span>:
{<span class="token string">"request_accepted"</span>:
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"2016/06/03"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"2016/06/08"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"2016/06/08"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">"2016/06/09"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"2016/06/09"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}}
</code></pre>
<p>结果：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"num"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>当然这个也适用于原题的情况，所以我们就把这个当做正确答案了。</p>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm19.png?raw=true">
</p>
<h3 id="span-id2020.-game-play-analysis-iiispan"><span id="20">20. Game Play Analysis III</span></h3>
<p>先来回顾一下：</p>
<ul>
<li><a href="https://zg104.github.io/sql#22"><em>Game Play Analysis I</em></a></li>
<li><a href="https://zg104.github.io/sql#23"><em>Game Play Analysis II</em></a></li>
</ul>
<p>Table: <code>Activity</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> player_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> device_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> event_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> games_played <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>(player_id, event_date)</code> is the primary key of this table.</p>
<p>This table shows the activity of players of some game.</p>
<p>Each row is a record of a player who logged in and played a number of games (possibly 0) before logging out on some day using some device.</p>
<p>Write an SQL query that reports for each player and date, how many games played <strong>so far</strong> by the player. That is, the total number of games played by the player until that date. Check the example for clarity.</p>
<p>The query result format is in the following example:</p>
<p><strong>Activity table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> player_id <span class="token operator">|</span> device_id <span class="token operator">|</span> event_date <span class="token operator">|</span> games_played <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">6</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------+------------+---------------------+</span>
<span class="token operator">|</span> player_id <span class="token operator">|</span> event_date <span class="token operator">|</span> games_played_so_far <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+---------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">5</span>                   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">11</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token number">12</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">0</span>                   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">5</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+---------------------+</span>
</code></pre>
<p>For the player with id 1, 5 + 6 = 11 games played by 2016-05-02, and 5 + 6 + 1 = 12 games played by 2017-06-25.</p>
<p>For the player with id 3, 0 + 5 = 5 games played by 2018-07-03.</p>
<p>Note that for each player we only care about the days when the player logged in.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要计算出截止到某一日期，每个玩家一共玩了多少游戏，也就是基于 event_date 计算所玩游戏的累积和。</p>
<p>那么我们可以使用 <strong>sum partition by</strong> 的语法来解决，sum 就是求和，partition by 意味着我们可以根据不同指标来分开求和，order by 就是按照某一指标来按照顺序求和。（这也是常用的 window function）</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
    player_id<span class="token punctuation">,</span> 
    event_date<span class="token punctuation">,</span> 
    <span class="token function">sum</span><span class="token punctuation">(</span>games_played<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id <span class="token keyword">order</span> <span class="token keyword">by</span> event_date<span class="token punctuation">)</span> 
    <span class="token keyword">as</span> games_played_so_far
<span class="token keyword">from</span> activity 
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm20.png?raw=true">
</p>
<h3 id="span-id2121.-game-play-analysis-ivspan"><span id="21">21. Game Play Analysis IV</span></h3>
<p>Table: <code>Activity</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> player_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> device_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> event_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> games_played <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p><code>(player_id, event_date)</code> is the primary key of this table.</p>
<p>This table shows the activity of players of some game.</p>
<p>Each row is a record of a player who logged in and played a number of games (possibly 0) before logging out on some day using some device.</p>
<p>Write an SQL query that reports the  <strong>fraction</strong>  of players that logged in again on the day after the day they first logged in, <strong>rounded to 2 decimal places</strong>. In other words, you need to count the number of players that logged in for at least two consecutive days starting from their first login date, then divide that number by the total number of players.</p>
<p>The query result format is in the following example:</p>
<p><strong>Activity table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> player_id <span class="token operator">|</span> device_id <span class="token operator">|</span> event_date <span class="token operator">|</span> games_played <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">6</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2016</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-----------+------------+--------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> fraction  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> <span class="token number">0.33</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
</code></pre>
<p>Only the player with id 1 logged back in after the first day he had logged in so the answer is 1/3 = 0.33</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要求出在第一天登录后又在第二天登录的人占总人数的比例，那么我们要：</p>
<ul>
<li>把每个人的登录时间排序（这个人的登录时间必然存在 rank = 2）</li>
<li>两个表格 self join，来检查 player_id 是否相等，并且 event_date 之间是否差 1</li>
</ul>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	player_id<span class="token punctuation">,</span> 
	event_date<span class="token punctuation">,</span> 
	dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id <span class="token keyword">order</span> <span class="token keyword">by</span> event_date<span class="token punctuation">)</span> <span class="token keyword">as</span> date_rank
<span class="token keyword">from</span> Activity
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"player_id"</span><span class="token punctuation">,</span> <span class="token string">"event_date"</span><span class="token punctuation">,</span> <span class="token string">"date_rank"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2016-03-01"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2016-03-02"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2017-06-25"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2016-03-02"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2018-07-03"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>接下来把上面的结果和 activity 合并，注意要用 left join，因为此时会出现 null 的情况。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> date_ranked <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> 
	    player_id<span class="token punctuation">,</span> 
	    event_date<span class="token punctuation">,</span> 
	    dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id <span class="token keyword">order</span> <span class="token keyword">by</span> event_date<span class="token punctuation">)</span> 
	    <span class="token keyword">as</span> date_rank
    <span class="token keyword">from</span> Activity
<span class="token punctuation">)</span>

<span class="token keyword">select</span>
	<span class="token function">round</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span>checked<span class="token punctuation">.</span>player_id<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> total<span class="token punctuation">.</span>player_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> 
	<span class="token keyword">as</span> fraction
<span class="token keyword">from</span> Activity <span class="token keyword">as</span> total
<span class="token keyword">left</span> <span class="token keyword">join</span> date_ranked <span class="token keyword">as</span> checked
<span class="token keyword">on</span> total<span class="token punctuation">.</span>player_id <span class="token operator">=</span> checked<span class="token punctuation">.</span>player_id 
<span class="token operator">and</span> checked<span class="token punctuation">.</span>date_rank <span class="token operator">=</span> <span class="token number">2</span> 
<span class="token operator">and</span> datediff<span class="token punctuation">(</span>checked<span class="token punctuation">.</span>event_date<span class="token punctuation">,</span> total<span class="token punctuation">.</span>event_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm21.png?raw=true">
</p>
<h3 id="span-id2222.-get-highest-answer-rate-questionspan"><span id="22">22. Get Highest Answer Rate Question</span></h3>
<p>Get the highest answer rate question from a table  <code>survey_log</code>  with these columns:  <strong>id</strong>,  <strong>action</strong>,  <strong>question_id</strong>,  <strong>answer_id</strong>,  <strong>q_num</strong>,  <strong>timestamp</strong>.</p>
<p>id means user id; action has these kind of values: “show”, “answer”, “skip”; answer_id is not null when action column is “answer”, while is null for “show” and “skip”; q_num is the numeral order of the question in current session.</p>
<p>Write a sql query to identify the question which has the highest answer rate.</p>
<p><strong>Example:</strong></p>
<p><strong>Input:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------+-----------+--------------+------------+-----------+------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> <span class="token keyword">action</span>    <span class="token operator">|</span> question_id  <span class="token operator">|</span> answer_id  <span class="token operator">|</span> q_num     <span class="token operator">|</span> <span class="token keyword">timestamp</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+--------------+------------+-----------+------------+</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span> <span class="token keyword">show</span>      <span class="token operator">|</span> <span class="token number">285</span>          <span class="token operator">|</span> <span class="token boolean">null</span>       <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">123</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span> answer    <span class="token operator">|</span> <span class="token number">285</span>          <span class="token operator">|</span> <span class="token number">124124</span>     <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">124</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span> <span class="token keyword">show</span>      <span class="token operator">|</span> <span class="token number">369</span>          <span class="token operator">|</span> <span class="token boolean">null</span>       <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">125</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span> skip      <span class="token operator">|</span> <span class="token number">369</span>          <span class="token operator">|</span> <span class="token boolean">null</span>       <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">126</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+--------------+------------+-----------+------------+</span>
</code></pre>
<p><strong>Output:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span> survey_log  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
<span class="token operator">|</span>    <span class="token number">285</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+</span>
</code></pre>
<p><strong>Explanation:</strong><br>
question 285 has answer rate 1/1, while question 369 has 0/1 answer rate, so output 285.</p>
<p><strong>Note:</strong> The highest answer rate meaning is: answer number’s ratio in show number in the same question.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们需要找到解答率最高的题目，那么就要计算出每个题目的解答率，并降序排序，然后取第一个，比较简单。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> question_id <span class="token keyword">AS</span> survey_log
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> question_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>answer_id<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>question_id<span class="token punctuation">)</span> <span class="token keyword">as</span> num
<span class="token keyword">FROM</span> survey_log
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> num <span class="token keyword">DESC</span>
<span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">)</span> tmp
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm22.png?raw=true">
</p>
<h3 id="span-id2323.-highest-grade-for-each-studentspan"><span id="23">23. Highest Grade For Each Student</span></h3>
<p>Table:  <code>Enrollments</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> student_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> course_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> grade         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(student_id, course_id)</code> is the primary key of this table.</p>
<p>Write a SQL query to find the highest grade with its corresponding course for each student. In case of a tie, you should find the course with the smallest <code>course_id</code>. The output must be sorted by increasing  <code>student_id</code>.</p>
<p>The query result format is in the following example:</p>
<p><strong>Enrollments table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------+-------------------+</span>
<span class="token operator">|</span> student_id <span class="token operator">|</span> course_id <span class="token operator">|</span> grade <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-------+</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">95</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">95</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">90</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">99</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">75</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">82</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------+-------------------+</span>
<span class="token operator">|</span> student_id <span class="token operator">|</span> course_id <span class="token operator">|</span> grade <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">99</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">95</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">82</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找每个课程里面的每个学生的最高成绩，如果持平，按照 course_id 排序，结果按照 student_id 排序。</p>
<p>这个题也比较简单，只需要针对每个学生的成绩进行排序即可，注意是按照成绩降序排列，并按照 course_id 升序排列，然后取出所有 rank = 1 的结果即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    student_id<span class="token punctuation">,</span> 
    course_id<span class="token punctuation">,</span>
    grade
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 
    student_id<span class="token punctuation">,</span> 
    course_id<span class="token punctuation">,</span>
    grade<span class="token punctuation">,</span>
    dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> student_id <span class="token keyword">order</span> <span class="token keyword">by</span> grade <span class="token keyword">desc</span><span class="token punctuation">,</span> course_id <span class="token keyword">asc</span><span class="token punctuation">)</span> rnk
<span class="token keyword">from</span> enrollments<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm23.png?raw=true">
</p>
<h3 id="span-id2424.-get-highest-answer-rate-questionspan"><span id="24">24. Get Highest Answer Rate Question</span></h3>
<p>先来回顾一下 <a href="https://zg104.github.io/sql#25"><em>Immediate Food Delivery I</em></a></p>
<p>Table:  <code>Delivery</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------------------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name                 <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+---------+</span>
<span class="token operator">|</span> delivery_id                 <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> customer_id                 <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> order_date                  <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> customer_pref_delivery_date <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------------+---------+</span>
</code></pre>
<p><code>delivery_id</code> is the primary key of this table.</p>
<p>The table holds information about food delivery to customers that make orders at some date and specify a preferred delivery date (on the same order date or after it).</p>
<p>If the preferred delivery date of the customer is the same as the order date then the order is called  <em>immediate</em> otherwise it’s called  <em>scheduled</em>.</p>
<p>The <em>first order</em> of a customer is the order with the earliest order date that customer made. It is guaranteed that a customer has exactly one first order.</p>
<p>Write an SQL query to find the percentage of immediate orders in the first orders of all customers, <strong>rounded to 2 decimal places</strong>.</p>
<p>The query result format is in the following example:</p>
<p><strong>Delivery table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+-------------+------------+-----------------------------+</span>
<span class="token operator">|</span> delivery_id <span class="token operator">|</span> customer_id <span class="token operator">|</span> order_date <span class="token operator">|</span> customer_pref_delivery_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+------------+-----------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">11</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">12</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">24</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">24</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">22</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">11</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">13</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">09</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">09</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+------------+-----------------------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------------------+</span>
<span class="token operator">|</span> immediate_percentage <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+</span>
<span class="token operator">|</span> <span class="token number">50.00</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------+</span>
</code></pre>
<p>The customer id 1 has a first order with delivery id 1 and it is scheduled.<br>
The customer id 2 has a first order with delivery id 2 and it is immediate.<br>
The customer id 3 has a first order with delivery id 5 and it is scheduled.<br>
The customer id 4 has a first order with delivery id 7 and it is immediate.<br>
Hence, half the customers have immediate first orders.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到所有 customers 的 first orders 中的 immediate orders 所占比例，</p>
<p>那么 first orders 就是该人最早的单；immediate orders 就是 order_date = customer_pref_delivery_date 的情况。</p>
<p>首先我们要根据每个人，来确定他们的 first_order 所在日期，所以可以用 <strong>min partition by</strong>。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	<span class="token keyword">distinct</span> customer_id<span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'date'</span>
<span class="token keyword">from</span> delivery
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"customer_id"</span><span class="token punctuation">,</span> <span class="token string">"date"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2019-08-01"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2019-08-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2019-08-21"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"2019-08-09"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>接下来，要把上面的结果与 delivery 合并，保证 <code>date = customer_pref_delivery_date</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> delivery <span class="token number">b</span>
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 
    <span class="token keyword">distinct</span> customer_id<span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'date'</span>
<span class="token keyword">from</span> delivery<span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>customer_id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>customer_id
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>customer_pref_delivery_date
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"delivery_id"</span><span class="token punctuation">,</span> <span class="token string">"customer_id"</span><span class="token punctuation">,</span> <span class="token string">"order_date"</span><span class="token punctuation">,</span> <span class="token string">"customer_pref_delivery_date"</span><span class="token punctuation">,</span> <span class="token string">"customer_id"</span><span class="token punctuation">,</span> <span class="token string">"date"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2019-08-01"</span><span class="token punctuation">,</span> <span class="token string">"2019-08-02"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2019-08-02"</span><span class="token punctuation">,</span> <span class="token string">"2019-08-02"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2019-08-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2019-08-11"</span><span class="token punctuation">,</span> <span class="token string">"2019-08-12"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2019-08-24"</span><span class="token punctuation">,</span> <span class="token string">"2019-08-24"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2019-08-21"</span><span class="token punctuation">,</span> <span class="token string">"2019-08-22"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2019-08-11"</span><span class="token punctuation">,</span> <span class="token string">"2019-08-13"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"2019-08-09"</span><span class="token punctuation">,</span> <span class="token string">"2019-08-09"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"2019-08-09"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>可以看出一共有两个满足条件的结果，那么稍加改动可计算出最后的百分比。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	<span class="token function">round</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token number">b</span><span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> 
	<span class="token keyword">as</span> immediate_percentage
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> 
    <span class="token keyword">distinct</span> customer_id<span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'date'</span>
<span class="token keyword">from</span> delivery<span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">right</span> <span class="token keyword">join</span> delivery <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>customer_id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>customer_id
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>customer_pref_delivery_date
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm24.png?raw=true">
</p>
<h3 id="span-id2525.-investments-in-2016span"><span id="25">25. Investments in 2016</span></h3>
<p>Write a query to print the sum of all total investment values in 2016 (<strong>TIV_2016</strong>), to a scale of 2 decimal places, for all policy holders who meet the following criteria:</p>
<ol>
<li>Have the same  <strong>TIV_2015</strong>  value as one or more other policyholders.</li>
<li>Are not located in the same city as any other policyholder (i.e.: the (latitude, longitude) attribute pairs must be unique).</li>
</ol>
<p><strong>Input Format:</strong><br>
The  <strong><em>insurance</em></strong>  table is described as follows:</p>

<table>
<thead>
<tr>
<th>Column Name</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>PID</td>
<td>INTEGER(11)</td>
</tr>
<tr>
<td>TIV_2015</td>
<td>NUMERIC(15,2)</td>
</tr>
<tr>
<td>TIV_2016</td>
<td>NUMERIC(15,2)</td>
</tr>
<tr>
<td>LAT</td>
<td>NUMERIC(5,2)</td>
</tr>
<tr>
<td>LON</td>
<td>NUMERIC(5,2)</td>
</tr>
</tbody>
</table><p>where  <strong>PID</strong>  is the policyholder’s policy ID,  <strong>TIV_2015</strong>  is the total investment value in 2015,  <strong>TIV_2016</strong>  is the total investment value in 2016,  <strong>LAT</strong>  is the latitude of the policy holder’s city, and  <strong>LON</strong>  is the longitude of the policy holder’s city.</p>
<p><strong>Sample Input</strong></p>

<table>
<thead>
<tr>
<th>PID</th>
<th>TIV_2015</th>
<th>TIV_2016</th>
<th>LAT</th>
<th>LON</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10</td>
<td>5</td>
<td>10</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
<td>20</td>
<td>20</td>
<td>20</td>
</tr>
<tr>
<td>3</td>
<td>10</td>
<td>30</td>
<td>20</td>
<td>20</td>
</tr>
<tr>
<td>4</td>
<td>10</td>
<td>40</td>
<td>40</td>
<td>40</td>
</tr>
</tbody>
</table><p><strong>Sample Output</strong></p>

<table>
<thead>
<tr>
<th>TIV_2016</th>
</tr>
</thead>
<tbody>
<tr>
<td>45.00</td>
</tr>
</tbody>
</table><p><strong>Explanation</strong></p>
<p>The first record in the table, like the last record, meets both of the two criteria.<br>
The <strong>TIV_2015</strong> value ‘10’ is as the same as the third and forth record, and its location unique.</p>
<p>The second record does not meet any of the two criteria. Its <strong>TIV_2015</strong> is not like any other policyholders.</p>
<p>And its location is the same with the third record, which makes the third record fail, too.</p>
<p>So, the result is the sum of <strong>TIV_2016</strong> of the first and last record, which is 45.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到所有2016年的投资值的和（sum(TIV_2016)）满足：</p>
<ul>
<li>有多个同样的 TIV_2015</li>
<li>(lat, lon) 对必须唯一</li>
</ul>
<p>那么第一步要移除重复的位置，也就是保证每一个 (lat, lon) 对应唯一结果。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span><span class="token punctuation">(</span>
	<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>lat<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> lat<span class="token punctuation">,</span> lon <span class="token keyword">order</span> <span class="token keyword">by</span> lat<span class="token punctuation">,</span>lon<span class="token punctuation">)</span> rn 
    <span class="token keyword">from</span> insurance
<span class="token punctuation">)</span> <span class="token number">a</span> <span class="token keyword">where</span> rn<span class="token operator">=</span><span class="token number">1</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"PID"</span><span class="token punctuation">,</span> <span class="token string">"TIV_2015"</span><span class="token punctuation">,</span> <span class="token string">"TIV_2016"</span><span class="token punctuation">,</span> <span class="token string">"LAT"</span><span class="token punctuation">,</span> <span class="token string">"LON"</span><span class="token punctuation">,</span> <span class="token string">"rn"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">5.00</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">40.00</span><span class="token punctuation">,</span> <span class="token number">40.00</span><span class="token punctuation">,</span> <span class="token number">40.00</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>第二步就是移除唯一的 TIV_2015 这一列</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span><span class="token punctuation">(</span>
	<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>tiv_2015<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> tiv_2015<span class="token punctuation">)</span> tv 
	<span class="token keyword">from</span> insurance
<span class="token punctuation">)</span><span class="token number">b</span> <span class="token keyword">where</span> tv<span class="token operator">&gt;</span><span class="token number">1</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"PID"</span><span class="token punctuation">,</span> <span class="token string">"TIV_2015"</span><span class="token punctuation">,</span> <span class="token string">"TIV_2016"</span><span class="token punctuation">,</span> <span class="token string">"LAT"</span><span class="token punctuation">,</span> <span class="token string">"LON"</span><span class="token punctuation">,</span> <span class="token string">"tv"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">5.00</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">30.00</span><span class="token punctuation">,</span> <span class="token number">20.00</span><span class="token punctuation">,</span> <span class="token number">20.00</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10.00</span><span class="token punctuation">,</span> <span class="token number">40.00</span><span class="token punctuation">,</span> <span class="token number">40.00</span><span class="token punctuation">,</span> <span class="token number">40.00</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>接下来就要把这两种情况得到的结果合并到一起，要同时满足。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># Remove duplicate location entries</span>
<span class="token keyword">with</span> temp1 <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span><span class="token punctuation">(</span>
        <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>lat<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> lat<span class="token punctuation">,</span> lon <span class="token keyword">order</span> <span class="token keyword">by</span> lat<span class="token punctuation">,</span>lon<span class="token punctuation">)</span> rn 
        <span class="token keyword">from</span> insurance
    <span class="token punctuation">)</span> <span class="token number">a</span> <span class="token keyword">where</span> rn<span class="token operator">=</span><span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token comment"># Remove TIV_2015 entries which are unique</span>
temp2 <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span><span class="token punctuation">(</span>
        <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>tiv_2015<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> tiv_2015<span class="token punctuation">)</span> tv 
        <span class="token keyword">from</span> insurance
    <span class="token punctuation">)</span><span class="token number">b</span> <span class="token keyword">where</span> tv<span class="token operator">&gt;</span><span class="token number">1</span>
    <span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>temp1<span class="token punctuation">.</span>tiv_2016<span class="token punctuation">)</span> <span class="token keyword">as</span> TIV_2016 <span class="token keyword">from</span> temp1<span class="token punctuation">,</span> temp2 <span class="token keyword">where</span> temp1<span class="token punctuation">.</span>pid<span class="token operator">=</span>temp2<span class="token punctuation">.</span>pid
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm25.png?raw=true">
</p>
<h3 id="span-id2626.-last-person-to-fit-in-the-elevatorspan"><span id="26">26. Last Person to Fit in the Elevator</span></h3>
<p>Table:  <code>Queue</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> person_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> person_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> weight      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> turn        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p><code>person_id</code> is the primary key column for this table.<br>
This table has the information about all people waiting for an elevator.<br>
The <code>person_id</code> and <code>turn</code> columns will contain all numbers from 1 to n, where n is the number of rows in the table.</p>
<p>The maximum weight the elevator can hold is  <strong>1000</strong>.</p>
<p>Write an SQL query to find the <code>person_name</code>  of the last person who will fit in the elevator without exceeding the weight limit. It is guaranteed that the person who is first in the queue can fit in the elevator.</p>
<p>The query result format is in the following example:</p>
<p><strong>Queue table</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------+-------------------+--------+------+</span>
<span class="token operator">|</span> person_id <span class="token operator">|</span> person_name       <span class="token operator">|</span> weight <span class="token operator">|</span> turn <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-------------------+--------+------+</span>
<span class="token operator">|</span> <span class="token number">5</span>         <span class="token operator">|</span> George Washington <span class="token operator">|</span> <span class="token number">250</span>    <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> John Adams        <span class="token operator">|</span> <span class="token number">350</span>    <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>         <span class="token operator">|</span> Thomas Jefferson  <span class="token operator">|</span> <span class="token number">400</span>    <span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> Will Johnliams    <span class="token operator">|</span> <span class="token number">200</span>    <span class="token operator">|</span> <span class="token number">4</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> Thomas Jefferson  <span class="token operator">|</span> <span class="token number">175</span>    <span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> James Elephant    <span class="token operator">|</span> <span class="token number">500</span>    <span class="token operator">|</span> <span class="token number">6</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+-------------------+--------+------+</span>
</code></pre>
<p><strong>Result table</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------------+</span>
<span class="token operator">|</span> person_name       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+</span>
<span class="token operator">|</span> Thomas Jefferson  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+</span>
</code></pre>
<p>Queue table is ordered by turn in the example for simplicity.<br>
In the example George Washington(id 5), John Adams(id 3) and Thomas Jefferson(id 6) will enter the elevator as their weight sum is 250 + 350 + 400 = 1000.<br>
Thomas Jefferson(id 6) is the last person to fit in the elevator because he has the last turn in these three people.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>这个题跟之前的一道题很像，都是要求累积和，这里根据 turn 来求 weight 的累积和，然后找到累积和小于或等于 1000 的情况，按 turn 的降序排列，取第一个即可，由于 turn 是唯一的，我们不需要考虑持平的可能，所以不需要用 dense_rank()。</p>
<p>先来计算累积和：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
    turn<span class="token punctuation">,</span>
    person_name<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> turn<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'cumulative_sum'</span>
<span class="token keyword">from</span> queue
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"turn"</span><span class="token punctuation">,</span> <span class="token string">"person_name"</span><span class="token punctuation">,</span> <span class="token string">"cumulative_sum"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"George Washington"</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"John Adams"</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Thomas Jefferson"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"Will Johnliams"</span><span class="token punctuation">,</span> <span class="token number">1200</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"Thomas Jefferson"</span><span class="token punctuation">,</span> <span class="token number">1375</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"James Elephant"</span><span class="token punctuation">,</span> <span class="token number">1875</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>并限制 cumulative_sum 小于等于 1000，按 turn 的降序排列，取第一个即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> person_name
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span>
    turn<span class="token punctuation">,</span>
    person_name<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> turn<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'cumulative_sum'</span>
<span class="token keyword">from</span> queue<span class="token punctuation">)</span> t1
<span class="token keyword">where</span> cumulative_sum <span class="token operator">&lt;=</span> <span class="token number">1000</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> turn <span class="token keyword">desc</span>
<span class="token keyword">limit</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm26.png?raw=true">
</p>
<h3 id="span-id2727.-managers-with-at-least-5-direct-reportsspan"><span id="27">27. Managers with at Least 5 Direct Reports</span></h3>
<p>The  <code>Employee</code>  table holds all employees including their managers. Every employee has an Id, and there is also a column for the manager Id.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------+----------+-----------+----------+</span>
<span class="token operator">|</span>Id    <span class="token operator">|</span>Name 	  <span class="token operator">|</span>Department <span class="token operator">|</span>ManagerId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+----------+-----------+----------+</span>
<span class="token operator">|</span><span class="token number">101</span>   <span class="token operator">|</span>John 	  <span class="token operator">|</span>A 	      <span class="token operator">|</span><span class="token boolean">null</span>      <span class="token operator">|</span>
<span class="token operator">|</span><span class="token number">102</span>   <span class="token operator">|</span>Dan 	  <span class="token operator">|</span>A 	      <span class="token operator">|</span><span class="token number">101</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token number">103</span>   <span class="token operator">|</span>James 	  <span class="token operator">|</span>A 	      <span class="token operator">|</span><span class="token number">101</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token number">104</span>   <span class="token operator">|</span>Amy 	  <span class="token operator">|</span>A 	      <span class="token operator">|</span><span class="token number">101</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token number">105</span>   <span class="token operator">|</span>Anne 	  <span class="token operator">|</span>A 	      <span class="token operator">|</span><span class="token number">101</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token number">106</span>   <span class="token operator">|</span>Ron 	  <span class="token operator">|</span>B 	      <span class="token operator">|</span><span class="token number">101</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+----------+-----------+----------+</span>
</code></pre>
<p>Given the  <code>Employee</code>  table, write a SQL query that finds out managers with at least 5 direct report. For the above table, your SQL query should return:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token operator">|</span> Name  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token operator">|</span> John  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
</code></pre>
<p><strong>Note:</strong><br>
No one would report to himself.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到拥有至少 5 个直接报告的 manager，那么我们需要 self join 这个表格，并且查看 id = managerid 的情况</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> employee <span class="token number">a</span><span class="token punctuation">,</span> employee <span class="token number">b</span>
<span class="token keyword">where</span> <span class="token number">b</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">a</span><span class="token punctuation">.</span>managerid
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"Id"</span><span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">,</span> <span class="token string">"Department"</span><span class="token punctuation">,</span> <span class="token string">"ManagerId"</span><span class="token punctuation">,</span> <span class="token string">"Id"</span><span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">,</span> <span class="token string">"Department"</span><span class="token punctuation">,</span> <span class="token string">"ManagerId"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">106</span><span class="token punctuation">,</span> <span class="token string">"Ron"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token string">"Anne"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token string">"Amy"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">103</span><span class="token punctuation">,</span> <span class="token string">"James"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token string">"Dan"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么 id = 101 有 5 个直接报告，所以稍微改一下</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token number">b</span><span class="token punctuation">.</span>name
<span class="token keyword">from</span> employee <span class="token number">a</span><span class="token punctuation">,</span> employee <span class="token number">b</span>
<span class="token keyword">where</span> <span class="token number">b</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">a</span><span class="token punctuation">.</span>managerid
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">5</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm27.png?raw=true">
</p>
<h3 id="span-id2828.-market-analysis-ispan"><span id="28">28. Market Analysis I</span></h3>
<p>Table:  <code>Users</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name    <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> user_id        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> join_date      <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> favorite_brand <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
</code></pre>
<p><code>user_id</code> is the primary key of this table.<br>
This table has the info of the users of an online shopping website where users can sell and buy items.</p>
<p>Table:  <code>Orders</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> order_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> order_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> item_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> buyer_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> seller_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>order_id</code> is the primary key of this table.<br>
item_id is a foreign key to the Items table.<br>
buyer_id and seller_id are foreign keys to the Users table.</p>
<p>Table:  <code>Items</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> item_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> item_brand    <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>item_id</code> is the primary key of this table.</p>
<p>Write an SQL query to find for each user, the join date and the number of orders they made as a buyer in  <strong>2019</strong>.</p>
<p>The query result format is in the following example:</p>
<p><strong>Users table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+------------+----------------+</span>
<span class="token operator">|</span> user_id <span class="token operator">|</span> join_date  <span class="token operator">|</span> favorite_brand <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------------+----------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> Lenovo         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">09</span> <span class="token operator">|</span> Samsung        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">19</span> <span class="token operator">|</span> LG             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> HP             <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------------+----------------+</span>
</code></pre>
<p><strong>Orders table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------+------------+---------+----------+-----------+</span>
<span class="token operator">|</span> order_id <span class="token operator">|</span> order_date <span class="token operator">|</span> item_id <span class="token operator">|</span> buyer_id <span class="token operator">|</span> seller_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+---------+----------+-----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">02</span> <span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">03</span> <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">04</span> <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">04</span> <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">05</span> <span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+---------+----------+-----------+</span>
</code></pre>
<p><strong>Items table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+------------+</span>
<span class="token operator">|</span> item_id <span class="token operator">|</span> item_brand <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> Samsung    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> Lenovo     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> LG         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> HP         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-----------+------------+----------------+</span>
<span class="token operator">|</span> buyer_id  <span class="token operator">|</span> join_date  <span class="token operator">|</span> orders_in_2019 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">09</span> <span class="token operator">|</span> <span class="token number">2</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">19</span> <span class="token operator">|</span> <span class="token number">0</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>         <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">0</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+------------+----------------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到每个用户的 join date、在2019年下的单数，题目很简单，在三个表格之中进行合并，并限制日期在 2019 年即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token number">a</span><span class="token punctuation">.</span>user_id buyer_id<span class="token punctuation">,</span> join_date<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>order_id<span class="token punctuation">)</span> <span class="token keyword">as</span> orders_in_2019
<span class="token keyword">from</span> users <span class="token number">a</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> orders <span class="token keyword">where</span> order_date <span class="token operator">between</span> <span class="token string">'2019-01-01'</span> <span class="token operator">and</span> <span class="token string">'2019-12-31'</span><span class="token punctuation">)</span> tmp
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>user_id <span class="token operator">=</span> tmp<span class="token punctuation">.</span>buyer_id
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">a</span><span class="token punctuation">.</span>user_id
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm28.png?raw=true">
</p>
<h3 id="span-id2929.-monthly-transactions-ispan"><span id="29">29. Monthly Transactions I</span></h3>
<p>Table:  <code>Transactions</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> country       <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> state         <span class="token operator">|</span> <span class="token keyword">enum</span>    <span class="token operator">|</span>
<span class="token operator">|</span> amount        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> trans_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>id is the primary key of this table.<br>
The table has information about incoming transactions.<br>
The state column is an enum of type [“approved”, “declined”].</p>
<p>Write an SQL query to find for each month and country, the number of transactions and their total amount, the number of approved transactions and their total amount.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># transactions table:</span>
<span class="token operator">+</span><span class="token comment">------+---------+----------+--------+------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> country <span class="token operator">|</span> state    <span class="token operator">|</span> amount <span class="token operator">|</span> trans_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+----------+--------+------------+</span>
<span class="token operator">|</span> <span class="token number">121</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> approved <span class="token operator">|</span> <span class="token number">1000</span>   <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">122</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> declined <span class="token operator">|</span> <span class="token number">2000</span>   <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">123</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> approved <span class="token operator">|</span> <span class="token number">2000</span>   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">124</span>  <span class="token operator">|</span> DE      <span class="token operator">|</span> approved <span class="token operator">|</span> <span class="token number">2000</span>   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+----------+--------+------------+</span>

<span class="token comment"># result table:</span>
<span class="token operator">+</span><span class="token comment">----------+---------+-------------+----------------+--------------------+-----------------------+</span>
<span class="token operator">|</span> month    <span class="token operator">|</span> country <span class="token operator">|</span> trans_count <span class="token operator">|</span> approved_count <span class="token operator">|</span> trans_total_amount <span class="token operator">|</span> approved_total_amount <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+---------+-------------+----------------+--------------------+-----------------------+</span>
<span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">12</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span> <span class="token number">3000</span>               <span class="token operator">|</span> <span class="token number">1000</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span> <span class="token number">2000</span>               <span class="token operator">|</span> <span class="token number">2000</span>                  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span>  <span class="token operator">|</span> DE      <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span> <span class="token number">2000</span>               <span class="token operator">|</span> <span class="token number">2000</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+---------+-------------+----------------+--------------------+-----------------------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到对于每个月每个过年的交易数量和交易总量，通过的交易数和总量，那么自然先计算总共的，再根据条件筛选 approved 的情况。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
    <span class="token keyword">left</span><span class="token punctuation">(</span>trans_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'month'</span><span class="token punctuation">,</span>
    <span class="token comment"># left 取字符串前 n 个字符</span>
    country<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> trans_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token string">'approved'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> approved_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> trans_total_amount<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token string">'approved'</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> approved_total_amount 
    <span class="token comment"># if 限定 approve 条件</span>
<span class="token keyword">from</span> <span class="token keyword">transactions</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm29.png?raw=true">
</p>
<h3 id="span-id3030.-monthly-transactions-iispan"><span id="30">30. Monthly Transactions II</span></h3>
<p>Table:  <code>Transactions</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name    <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> id             <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> country        <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> state          <span class="token operator">|</span> <span class="token keyword">enum</span>    <span class="token operator">|</span>
<span class="token operator">|</span> amount         <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> trans_date     <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
</code></pre>
<p>id is the primary key of this table.<br>
The table has information about incoming transactions.<br>
The state column is an enum of type [“approved”, “declined”].</p>
<p>Table:  <code>Chargebacks</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name    <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
<span class="token operator">|</span> trans_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> charge_date    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+---------+</span>
</code></pre>
<p>Chargebacks contains basic information regarding incoming chargebacks from some transactions placed in Transactions table.<br>
trans_id is a foreign key to the id column of Transactions table.<br>
Each chargeback corresponds to a transaction made previously even if they were not approved.</p>
<p>Write an SQL query to find for each month and country, the number of approved transactions and their total amount, the number of chargebacks and their total amount.</p>
<p><strong>Note</strong>: In your query, given the month and country, ignore rows with all zeros.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># transactions table:</span>
<span class="token operator">+</span><span class="token comment">------+---------+----------+--------+------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> country <span class="token operator">|</span> state    <span class="token operator">|</span> amount <span class="token operator">|</span> trans_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+----------+--------+------------+</span>
<span class="token operator">|</span> <span class="token number">101</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> approved <span class="token operator">|</span> <span class="token number">1000</span>   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> declined <span class="token operator">|</span> <span class="token number">2000</span>   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> approved <span class="token operator">|</span> <span class="token number">3000</span>   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">10</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">104</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> approved <span class="token operator">|</span> <span class="token number">4000</span>   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">105</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> approved <span class="token operator">|</span> <span class="token number">5000</span>   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">15</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+---------+----------+--------+------------+</span>

<span class="token comment"># chargebacks table:</span>
<span class="token operator">+</span><span class="token comment">------------+------------+</span>
<span class="token operator">|</span> trans_id   <span class="token operator">|</span> trans_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+</span>
<span class="token operator">|</span> <span class="token number">102</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">29</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">101</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">105</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+</span>

<span class="token comment"># result table:</span>
<span class="token operator">+</span><span class="token comment">----------+---------+----------------+-----------------+-------------------+--------------------+</span>
<span class="token operator">|</span> month    <span class="token operator">|</span> country <span class="token operator">|</span> approved_count <span class="token operator">|</span> approved_amount <span class="token operator">|</span> chargeback_count  <span class="token operator">|</span> chargeback_amount  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+---------+----------------+-----------------+-------------------+--------------------+</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span> <span class="token number">1000</span>            <span class="token operator">|</span> <span class="token number">1</span>                 <span class="token operator">|</span> <span class="token number">2000</span>               <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> <span class="token number">3</span>              <span class="token operator">|</span> <span class="token number">12000</span>           <span class="token operator">|</span> <span class="token number">1</span>                 <span class="token operator">|</span> <span class="token number">1000</span>               <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">09</span>  <span class="token operator">|</span> US      <span class="token operator">|</span> <span class="token number">0</span>              <span class="token operator">|</span> <span class="token number">0</span>               <span class="token operator">|</span> <span class="token number">1</span>                 <span class="token operator">|</span> <span class="token number">5000</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+---------+----------------+-----------------+-------------------+--------------------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>跟上一题类似，但是我们要分别找到对应状态为 approved 和 chargeback 的所有信息，那么当满足 chargeback table 条件的情况，我们设置 state 为chargeback，再 union 状态为 approved 的情况</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">WITH</span> M <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> 
	C<span class="token punctuation">.</span>trans_id <span class="token keyword">AS</span> <span class="token string">'id'</span><span class="token punctuation">,</span> 
	T<span class="token punctuation">.</span>country<span class="token punctuation">,</span> 
	T<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> 
	C<span class="token punctuation">.</span>trans_date<span class="token punctuation">,</span> 
	<span class="token string">'chargeback'</span> <span class="token keyword">AS</span> <span class="token string">'state'</span>
<span class="token keyword">FROM</span> Chargebacks C <span class="token keyword">JOIN</span> <span class="token keyword">Transactions</span> T
<span class="token keyword">ON</span> T<span class="token punctuation">.</span>ID <span class="token operator">=</span> C<span class="token punctuation">.</span>trans_id
<span class="token comment"># 满足 chargeback 的 trans_id 都对应着新的 state = chargeback</span>

<span class="token keyword">UNION</span>

<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> country<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> trans_date<span class="token punctuation">,</span> state
<span class="token keyword">FROM</span> <span class="token keyword">Transactions</span>
<span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'approved'</span><span class="token punctuation">)</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"country"</span><span class="token punctuation">,</span> <span class="token string">"amount"</span><span class="token punctuation">,</span> <span class="token string">"trans_date"</span><span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"2019-06-30"</span><span class="token punctuation">,</span> <span class="token string">"chargeback"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token string">"2019-05-29"</span><span class="token punctuation">,</span> <span class="token string">"chargeback"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">"2019-09-18"</span><span class="token punctuation">,</span> <span class="token string">"chargeback"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"2019-05-18"</span><span class="token punctuation">,</span> <span class="token string">"approved"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token number">103</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token string">"2019-06-10"</span><span class="token punctuation">,</span> <span class="token string">"approved"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">"2019-06-15"</span><span class="token punctuation">,</span> <span class="token string">"approved"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么根据不同的 state，我们把对应的情况一次查找出来，使用 case when 函数或者 if 函数都可以</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> 
	<span class="token keyword">left</span><span class="token punctuation">(</span>trans_id<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'month'</span><span class="token punctuation">,</span> country<span class="token punctuation">,</span> 
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'approved'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'approved_count'</span><span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'approved'</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'approved_amount'</span><span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'chargeback'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'chargeback_count'</span><span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'chargeback'</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'chargeback_amount'</span>
	<span class="token comment"># 当然也可用 if</span>
<span class="token keyword">FROM</span> M
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">WITH</span> M <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> C<span class="token punctuation">.</span>trans_id <span class="token keyword">AS</span> <span class="token string">'id'</span><span class="token punctuation">,</span> T<span class="token punctuation">.</span>country<span class="token punctuation">,</span> T<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> C<span class="token punctuation">.</span>trans_date<span class="token punctuation">,</span> <span class="token string">'chargeback'</span> <span class="token keyword">AS</span> <span class="token string">'state'</span>
<span class="token keyword">FROM</span> Chargebacks C <span class="token keyword">JOIN</span> <span class="token keyword">Transactions</span> T
<span class="token keyword">ON</span> T<span class="token punctuation">.</span>ID <span class="token operator">=</span> C<span class="token punctuation">.</span>trans_id

<span class="token keyword">UNION</span>

<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> country<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> trans_date<span class="token punctuation">,</span> state
<span class="token keyword">FROM</span> <span class="token keyword">Transactions</span>
<span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'approved'</span><span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> 
	<span class="token keyword">left</span><span class="token punctuation">(</span>trans_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'month'</span><span class="token punctuation">,</span> country<span class="token punctuation">,</span> 
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'approved'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'approved_count'</span><span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'approved'</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'approved_amount'</span><span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'chargeback'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'chargeback_count'</span><span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> state <span class="token operator">=</span> <span class="token string">'chargeback'</span> <span class="token keyword">THEN</span> amount <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'chargeback_amount'</span>
	<span class="token comment"># 当然也可用 if</span>
<span class="token keyword">FROM</span> M
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm30.png?raw=true">
</p>
<h3 id="span-id3131.-movie-ratingspan"><span id="31">31. Movie Rating</span></h3>
<p>Table:  <code>Movies</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> movie_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> title         <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>movie_id</code> is the primary key for this table.<br>
title is the name of the movie.</p>
<p>Table:  <code>Users</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> user_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>user_id</code> is the primary key for this table.</p>
<p>Table:  <code>Movie_Rating</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> movie_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> user_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> rating        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> created_at    <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(movie_id, user_id)</code> is the primary key for this table.<br>
This table contains the rating of a movie by a user in their review.<br>
created_at is the user’s review date.</p>
<p>Write the following SQL query:</p>
<ul>
<li>
<p>Find the name of the user who has rated the greatest number of movies. In case of a tie, return lexicographically smaller user name.</p>
</li>
<li>
<p>Find the movie name with the  <em><strong>highest average</strong></em>  rating in <strong>February 2020</strong>. In case of a tie, return lexicographically smaller movie name.</p>
</li>
</ul>
<p>The query is returned in 2 rows, the query result format is in the following example:</p>
<p><strong>Movies table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
<span class="token operator">|</span> movie_id    <span class="token operator">|</span>  title       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Avengers     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Frozen <span class="token number">2</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Joker        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
</code></pre>
<p><strong>Users table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
<span class="token operator">|</span> user_id     <span class="token operator">|</span>  name        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Daniel       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Monica       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Maria        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> James        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+</span>
</code></pre>
<p><strong>Movie_Rating table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+--------------+--------------+-------------+</span>
<span class="token operator">|</span> movie_id    <span class="token operator">|</span> user_id      <span class="token operator">|</span> rating       <span class="token operator">|</span> created_at  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+--------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">12</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">11</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">17</span>  <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">01</span>  <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">22</span>  <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">4</span>            <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">25</span>  <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">-------------+--------------+--------------+-------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> results      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
<span class="token operator">|</span> Daniel       <span class="token operator">|</span>
<span class="token operator">|</span> Frozen <span class="token number">2</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+</span>
</code></pre>
<p>Daniel and Monica have rated 3 movies (“Avengers”, “Frozen 2” and “Joker”) but Daniel is smaller lexicographically.<br>
Frozen 2 and Joker have a rating average of 3.5 in February but Frozen 2 is smaller lexicographically.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们把 created_at 转换成年月，并把三个表格合并</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> cte <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> 
	title<span class="token punctuation">,</span> 
	name<span class="token punctuation">,</span> 
	rating<span class="token punctuation">,</span> 
	<span class="token keyword">left</span><span class="token punctuation">(</span>created_at<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'created_at'</span>
<span class="token keyword">from</span> movie_rating
<span class="token keyword">join</span> users
<span class="token keyword">using</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
<span class="token keyword">join</span> movies 
<span class="token keyword">using</span> <span class="token punctuation">(</span>movie_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"rating"</span><span class="token punctuation">,</span> <span class="token string">"created_at"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"Joker"</span><span class="token punctuation">,</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2020-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Frozen 2"</span><span class="token punctuation">,</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"2020-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Avengers"</span><span class="token punctuation">,</span> <span class="token string">"Daniel"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2020-01"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Joker"</span><span class="token punctuation">,</span> <span class="token string">"Monica"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"2020-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Frozen 2"</span><span class="token punctuation">,</span> <span class="token string">"Monica"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2020-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Avengers"</span><span class="token punctuation">,</span> <span class="token string">"Monica"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"2020-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Frozen 2"</span><span class="token punctuation">,</span> <span class="token string">"Maria"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2020-03"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Avengers"</span><span class="token punctuation">,</span> <span class="token string">"Maria"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2020-02"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"Avengers"</span><span class="token punctuation">,</span> <span class="token string">"James"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2020-01"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么接下来找给电影打分数量最多的用户，和在 2020 年 2 月有最高平均分的电影名，我们只需分别找出再 union 到一起</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> cte <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> title<span class="token punctuation">,</span> name<span class="token punctuation">,</span> rating<span class="token punctuation">,</span> <span class="token keyword">left</span><span class="token punctuation">(</span>created_at<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'created_at'</span>
<span class="token keyword">from</span> movie_rating
<span class="token keyword">join</span> users
<span class="token keyword">using</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
<span class="token keyword">join</span> movies 
<span class="token keyword">using</span> <span class="token punctuation">(</span>movie_id<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">select</span> name <span class="token keyword">as</span> results <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span>
    name<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> cte
<span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">)</span> t1
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> title <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 
    title<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">avg</span><span class="token punctuation">(</span>rating<span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> cte
<span class="token keyword">where</span> created_at <span class="token operator">=</span> <span class="token string">'2020-02'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> title<span class="token punctuation">)</span> t2
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm31.png?raw=true">
</p>
<h3 id="span-id3232.-new-users-daily-countspan"><span id="32">32. New Users Daily Count</span></h3>
<p>Table:  <code>Traffic</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> user_id       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> activity      <span class="token operator">|</span> <span class="token keyword">enum</span>    <span class="token operator">|</span>
<span class="token operator">|</span> activity_date <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>There is no primary key for this table, it may have duplicate rows.<br>
The activity column is an ENUM type of (‘login’, ‘logout’, ‘jobs’, ‘groups’, ‘homepage’).</p>
<p>Write an SQL query that reports for every date within at most <strong>90 days</strong>  from today, the number of users that logged in for the first time on that date. Assume today is  <strong>2019-06-30</strong>.</p>
<p>The query result format is in the following example:</p>
<p><strong>Traffic table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+----------+---------------+</span>
<span class="token operator">|</span> user_id <span class="token operator">|</span> activity <span class="token operator">|</span> activity_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+----------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> login    <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> homepage <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> logout   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> login    <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> logout   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> login    <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> jobs     <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> logout   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> login    <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> groups   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> logout   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> login    <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> logout   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> login    <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> logout   <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+----------+---------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------+-------------+</span>
<span class="token operator">|</span> login_date <span class="token operator">|</span> user_count  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">21</span> <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------------+</span>
</code></pre>
<p>Note that we only care about dates with non zero user count.<br>
The user with id 5 first logged in on 2019-03-01 so he’s not counted on 2019-06-21.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>假设今天是 2019-06-30，我们要找到从今天开始往前推最多 90 天内，那一天第一次等于的用户人数。</p>
<p>首先我们先找到每个用户登录的最早日期</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t <span class="token keyword">as</span> 
<span class="token punctuation">(</span>
  <span class="token keyword">select</span> 
    user_id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>activity_date<span class="token punctuation">)</span> <span class="token keyword">as</span> first_date
  <span class="token keyword">from</span> Traffic 
  <span class="token keyword">where</span> activity<span class="token operator">=</span><span class="token string">'login'</span>
  <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token string">"first_date"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"2019-05-01"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"2019-06-21"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"2019-01-01"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"2019-06-21"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"2019-03-01"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么在这个基础上，我们筛选 login_date 在从今天开始算的之前 90 以内，第一次登录的人数。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> t <span class="token keyword">as</span> 
<span class="token punctuation">(</span>
  <span class="token keyword">select</span> 
    user_id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>activity_date<span class="token punctuation">)</span> <span class="token keyword">as</span> first_date
  <span class="token keyword">from</span> Traffic 
  <span class="token keyword">where</span> activity<span class="token operator">=</span><span class="token string">'login'</span>
  <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 
  first_date <span class="token keyword">as</span> login_date
  <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> user_id<span class="token punctuation">)</span> <span class="token keyword">as</span> user_count
<span class="token keyword">from</span> t
<span class="token keyword">where</span> first_date <span class="token operator">&gt;=</span> date_sub<span class="token punctuation">(</span><span class="token string">'2019-06-30'</span><span class="token punctuation">,</span>interval <span class="token number">90</span> day<span class="token punctuation">)</span>
<span class="token comment"># date_sub 把当前日期按照一定的 interval 相减</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm32.png?raw=true">
</p>
<h3 id="span-id3333.-nth-highest-salaryspan"><span id="33">33. Nth Highest Salary</span></h3>
<p>Write a SQL query to get the  _n_th  highest salary from the  <code>Employee</code>  table.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> Salary <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">100</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> <span class="token number">200</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> <span class="token number">300</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+--------+</span>
</code></pre>
<p>For example, given the above Employee table, the  _n_th  highest salary where  <em>n</em>  = 2 is  <code>200</code>. If there is no  _n_th  highest salary, then the query should return  <code>null</code>.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token operator">|</span> getNthHighestSalary<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
<span class="token operator">|</span> <span class="token number">200</span>                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们只需要用 window fuction 来找到第 n 高的薪资就可以了。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> getNthHighestSalary<span class="token punctuation">(</span>N <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">RETURN</span> <span class="token punctuation">(</span>
      <span class="token comment"># Write your MySQL query statement below.</span>
      <span class="token keyword">select</span>
      <span class="token function">max</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> getNthHighestSalary
      <span class="token keyword">from</span>
      <span class="token punctuation">(</span><span class="token keyword">select</span> salary<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> salary <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk <span class="token keyword">from</span> employee<span class="token punctuation">)</span> t
      <span class="token keyword">where</span> rnk <span class="token operator">=</span> N
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm33.png?raw=true">
</p>
<h3 id="span-id3434.-number-of-trusted-contacts-of-a-customerspan"><span id="34">34. Number of Trusted Contacts of a Customer</span></h3>
<p>Table:  <code>Customers</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> customer_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> customer_name <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> email         <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>customer_id is the primary key for this table.<br>
Each row of this table contains the name and the email of a customer of an online shop.</p>
<p>Table:  <code>Contacts</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> user_id       <span class="token operator">|</span> id      <span class="token operator">|</span>
<span class="token operator">|</span> contact_name  <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> contact_email <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>(user_id, contact_email) is the primary key for this table.<br>
Each row of this table contains the name and email of one contact of customer with user_id.<br>
This table contains information about people each customer trust. The contact may or may not exist in the Customers table.</p>
<p>Table:  <code>Invoices</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name  <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
<span class="token operator">|</span> invoice_id   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> price        <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> user_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+---------+</span>
</code></pre>
<p>invoice_id is the primary key for this table.<br>
Each row of this table indicates that user_id has an invoice with invoice_id and a price.</p>
<p>Write an SQL query to find the following for each  <code>invoice_id</code>:</p>
<ul>
<li><code>customer_name</code>: The name of the customer the invoice is related to.</li>
<li><code>price</code>: The price of the invoice.</li>
<li><code>contacts_cnt</code>: The number of contacts related to the customer.</li>
<li><code>trusted_contacts_cnt</code>: The number of contacts related to the customer and at the same time they are customers to the shop. (i.e His/Her email exists in the Customers table.)</li>
</ul>
<p>Order the result table by  <code>invoice_id</code>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># customers table:</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+--------------------+</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span> customer_name <span class="token operator">|</span> email              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+--------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Alice         <span class="token operator">|</span> alice<span class="token variable">@leetcode.com</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Bob           <span class="token operator">|</span> bob<span class="token variable">@leetcode.com</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">13</span>          <span class="token operator">|</span> John          <span class="token operator">|</span> john<span class="token variable">@leetcode.com</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span> Alex          <span class="token operator">|</span> alex<span class="token variable">@leetcode.com</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+--------------------+</span>

<span class="token comment"># contacts table:</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+--------------------+</span>
<span class="token operator">|</span> user_id     <span class="token operator">|</span> contact_name <span class="token operator">|</span> contact_email      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+--------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Bob          <span class="token operator">|</span> bob<span class="token variable">@leetcode.com</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> John         <span class="token operator">|</span> john<span class="token variable">@leetcode.com</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Jal          <span class="token operator">|</span> jal<span class="token variable">@leetcode.com</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Omar         <span class="token operator">|</span> omar<span class="token variable">@leetcode.com</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Meir         <span class="token operator">|</span> meir<span class="token variable">@leetcode.com</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span> Alice        <span class="token operator">|</span> alice<span class="token variable">@leetcode.com</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+--------------------+</span>

<span class="token comment"># invoices table:</span>
<span class="token operator">+</span><span class="token comment">------------+-------+---------+</span>
<span class="token operator">|</span> invoice_id <span class="token operator">|</span> price <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------+---------+</span>
<span class="token operator">|</span> <span class="token number">77</span>         <span class="token operator">|</span> <span class="token number">100</span>   <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">88</span>         <span class="token operator">|</span> <span class="token number">200</span>   <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">99</span>         <span class="token operator">|</span> <span class="token number">300</span>   <span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">66</span>         <span class="token operator">|</span> <span class="token number">400</span>   <span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">55</span>         <span class="token operator">|</span> <span class="token number">500</span>   <span class="token operator">|</span> <span class="token number">13</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">44</span>         <span class="token operator">|</span> <span class="token number">60</span>    <span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------+---------+</span>

<span class="token comment"># result table:</span>
<span class="token operator">+</span><span class="token comment">------------+---------------+-------+--------------+----------------------+</span>
<span class="token operator">|</span> invoice_id <span class="token operator">|</span> customer_name <span class="token operator">|</span> price <span class="token operator">|</span> contacts_cnt <span class="token operator">|</span> trusted_contacts_cnt <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------------+-------+--------------+----------------------+</span>
<span class="token operator">|</span> <span class="token number">44</span>         <span class="token operator">|</span> Alex          <span class="token operator">|</span> <span class="token number">60</span>    <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span> <span class="token number">1</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">55</span>         <span class="token operator">|</span> John          <span class="token operator">|</span> <span class="token number">500</span>   <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span> <span class="token number">0</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">66</span>         <span class="token operator">|</span> Bob           <span class="token operator">|</span> <span class="token number">400</span>   <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">0</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">77</span>         <span class="token operator">|</span> Alice         <span class="token operator">|</span> <span class="token number">100</span>   <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">88</span>         <span class="token operator">|</span> Alice         <span class="token operator">|</span> <span class="token number">200</span>   <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span> <span class="token number">2</span>                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">99</span>         <span class="token operator">|</span> Bob           <span class="token operator">|</span> <span class="token number">300</span>   <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span> <span class="token number">0</span>                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+---------------+-------+--------------+----------------------+</span>
</code></pre>
<p>Alice has three contacts, two of them are trusted contacts (Bob and John).<br>
Bob has two contacts, none of them is a trusted contact.<br>
Alex has one contact and it is a trusted contact (Alice).<br>
John doesn’t have any contacts.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题踩比赞多，因为不光题看着复杂，实际上难度也基本没有，归在简单类型里也是无可厚非。</p>
<p>我们只需把这几个表格合并起来，找到对应的列取出来，然后 group by + count即可，具体解释写在代码注释里。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    i<span class="token punctuation">.</span>invoice_id<span class="token punctuation">,</span>
    <span class="token number">c1</span><span class="token punctuation">.</span>customer_name<span class="token punctuation">,</span>
    <span class="token function">max</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> price<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span>co<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token keyword">as</span> contacts_cnt<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">c2</span><span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span> <span class="token keyword">as</span> trusted_contacts_cnt 
<span class="token keyword">from</span> invoices i
<span class="token keyword">join</span> customers <span class="token number">c1</span>
<span class="token comment"># 里面无缺失值可用 join</span>
<span class="token keyword">on</span> i<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token number">c1</span><span class="token punctuation">.</span>customer_id
<span class="token keyword">left</span> <span class="token keyword">join</span> contacts co
<span class="token comment"># contacts 里的 id = 13 不存在</span>
<span class="token keyword">on</span> co<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token number">c1</span><span class="token punctuation">.</span>customer_id
<span class="token keyword">left</span> <span class="token keyword">join</span> customers <span class="token number">c2</span>
<span class="token comment"># 再次 join customers 保证 contact_name = customer_name</span>
<span class="token keyword">on</span> <span class="token number">c2</span><span class="token punctuation">.</span>customer_name <span class="token operator">=</span> co<span class="token punctuation">.</span>contact_name
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm34.png?raw=true">
</p>
<h3 id="span-id3535.-page-recommendationsspan"><span id="35">35. Page Recommendations</span></h3>
<p>Table:  <code>Friendship</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> user1_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> user2_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>(user1_id, user2_id) is the primary key for this table.<br>
Each row of this table indicates that there is a friendship relation between user1_id and user2_id.</p>
<p>Table:  <code>Likes</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> user_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> page_id     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p>(user_id, page_id) is the primary key for this table.<br>
Each row of this table indicates that user_id likes page_id.</p>
<p>Write an SQL query to recommend pages to the user with  <code>user_id</code>  = 1 using the pages that your friends liked. It should not recommend pages you already liked.</p>
<p>Return result table in any order without duplicates.</p>
<p>The query result format is in the following example:</p>
<p><strong>Friendship table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------+----------+</span>
<span class="token operator">|</span> user1_id <span class="token operator">|</span> user2_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">4</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">5</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>        <span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+----------+</span>
</code></pre>
<p><strong>Likes table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------+---------+</span>
<span class="token operator">|</span> user_id <span class="token operator">|</span> page_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+</span>
<span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span> <span class="token number">88</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> <span class="token number">23</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token number">24</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token number">56</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> <span class="token number">11</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span> <span class="token number">33</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span> <span class="token number">77</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token number">77</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>       <span class="token operator">|</span> <span class="token number">88</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> recommended_page <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>
<span class="token operator">|</span> <span class="token number">23</span>               <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">24</span>               <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">56</span>               <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">33</span>               <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">77</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+</span>
</code></pre>
<p>User one is friend with users 2, 3, 4 and 6.<br>
Suggested pages are 23 from user 2, 24 from user 3, 56 from user 3 and 33 from user 6.<br>
Page 77 is suggested from both user 2 and user 3.<br>
Page 88 is not suggested because user 1 already likes it.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们需要找到 user_id = 1 的朋友喜欢的 pages，并排除他自己本身喜欢的 pages。</p>
<p>那么，我们要先找出跟 id = 1 的朋友关系信息，并查找朋友对应的 pages。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Friendship <span class="token number">f</span>
<span class="token keyword">JOIN</span> Likes l
<span class="token keyword">ON</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token punctuation">.</span>user1_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">f</span><span class="token punctuation">.</span>user2_id<span class="token operator">=</span>l<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> 
<span class="token operator">OR</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token punctuation">.</span>user2_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">f</span><span class="token punctuation">.</span>user1_id<span class="token operator">=</span>l<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"user1_id"</span><span class="token punctuation">,</span> <span class="token string">"user2_id"</span><span class="token punctuation">,</span> <span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token string">"page_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>接下来要排除 id = 1 喜欢的 pages，那么继续 left join likes table</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Friendship <span class="token number">f</span>
<span class="token keyword">JOIN</span> Likes l
<span class="token keyword">ON</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token punctuation">.</span>user1_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">f</span><span class="token punctuation">.</span>user2_id<span class="token operator">=</span>l<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> 
<span class="token operator">OR</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token punctuation">.</span>user2_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">f</span><span class="token punctuation">.</span>user1_id<span class="token operator">=</span>l<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> Likes s
<span class="token keyword">ON</span> s<span class="token punctuation">.</span>user_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> l<span class="token punctuation">.</span>page_id<span class="token operator">=</span>s<span class="token punctuation">.</span>page_id
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"user1_id"</span><span class="token punctuation">,</span> <span class="token string">"user2_id"</span><span class="token punctuation">,</span> <span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token string">"page_id"</span><span class="token punctuation">,</span> <span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token string">"page_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
<span class="token comment"># 可以看到最后一行代表的是存在朋友推荐和id = 1的pages一样</span>
<span class="token comment"># 所以接下来要把这一行去掉就可以</span>
</code></pre>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">distinct</span> l<span class="token punctuation">.</span>page_id recommended_page
<span class="token keyword">FROM</span> Friendship <span class="token number">f</span>
<span class="token keyword">JOIN</span> Likes l
<span class="token keyword">ON</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token punctuation">.</span>user1_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">f</span><span class="token punctuation">.</span>user2_id<span class="token operator">=</span>l<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> 
<span class="token operator">OR</span> <span class="token punctuation">(</span><span class="token number">f</span><span class="token punctuation">.</span>user2_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">f</span><span class="token punctuation">.</span>user1_id<span class="token operator">=</span>l<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> Likes s
<span class="token keyword">ON</span> s<span class="token punctuation">.</span>user_id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> l<span class="token punctuation">.</span>page_id<span class="token operator">=</span>s<span class="token punctuation">.</span>page_id
<span class="token keyword">WHERE</span> s<span class="token punctuation">.</span>page_id <span class="token operator">is</span> <span class="token boolean">null</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm35.png?raw=true">
</p>
<h3 id="span-id3636.-product-price-at-a-given-datespan"><span id="36">36. Product Price at a Given Date</span></h3>
<p>Table:  <code>Products</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> product_id    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> new_price     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> change_date   <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>(product_id, change_date)</code> is the primary key of this table.<br>
Each row of this table indicates that the price of some product was changed to a new price at some date.</p>
<p>Write an SQL query to find the prices of all products on  <strong>2019-08-16</strong>. Assume the price of all products before any change is  <strong>10</strong>.</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># products table:</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-------------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> new_price <span class="token operator">|</span> change_date <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">20</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">14</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">50</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">14</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">30</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">15</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">35</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">16</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">65</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">17</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">20</span>        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">18</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+-------------+</span>

<span class="token comment"># result table:</span>
<span class="token operator">+</span><span class="token comment">------------+-------+</span>
<span class="token operator">|</span> product_id <span class="token operator">|</span> price <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------+</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">50</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">35</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">10</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	t<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span>
	<span class="token keyword">coalesce</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>new_price<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 		price<span class="token punctuation">,</span>
	p<span class="token punctuation">.</span>change_date<span class="token punctuation">,</span>
	row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> t<span class="token punctuation">.</span>product_id <span class="token keyword">order</span> <span class="token keyword">by</span> p<span class="token punctuation">.</span>change_date <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> product_id
<span class="token keyword">from</span> Products<span class="token punctuation">)</span>t
<span class="token keyword">left</span> <span class="token keyword">join</span>
products p 
<span class="token keyword">on</span> t<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id
<span class="token operator">and</span> p<span class="token punctuation">.</span>change_date <span class="token operator">&lt;=</span> <span class="token string">'2019-08-16'</span>
</code></pre>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"product_id"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"change_date"</span><span class="token punctuation">,</span> <span class="token string">"rnk"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token string">"2019-08-16"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">"2019-08-15"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"2019-08-14"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">"2019-08-14"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么我们只需取出 rnk = 1 的信息即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> product_id<span class="token punctuation">,</span> price <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> t<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span><span class="token keyword">coalesce</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>new_price<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">as</span> price<span class="token punctuation">,</span>p<span class="token punctuation">.</span>change_date<span class="token punctuation">,</span>
row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> t<span class="token punctuation">.</span>product_id <span class="token keyword">order</span> <span class="token keyword">by</span> p<span class="token punctuation">.</span>change_date <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> product_id
<span class="token keyword">from</span> Products<span class="token punctuation">)</span>t
<span class="token keyword">left</span> <span class="token keyword">join</span>
products p 
<span class="token keyword">on</span> t<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id
<span class="token operator">and</span> p<span class="token punctuation">.</span>change_date<span class="token operator">&lt;=</span><span class="token string">'2019-08-16'</span><span class="token punctuation">)</span> tmp
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm36.png?raw=true">
</p>
<h3 id="span-id3737.-project-employees-iiispan"><span id="37">37. Project Employees III</span></h3>
<p>如需要查阅 <strong>Project Employees II</strong> ，请点击<a href="https://zg104.github.io/sql#28">这里</a>。</p>
<p>Table: <code>Project</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
<span class="token operator">|</span> project_id  <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------+</span>
</code></pre>
<p>(project_id, employee_id) is the primary key of this table.<br>
employee_id is a foreign key to <code>Employee</code> table.</p>
<p>Table: <code>Employee</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name      <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
<span class="token operator">|</span> employee_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> name             <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> experience_years <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+---------+</span>
</code></pre>
<p>employee_id is the primary key of this table.</p>
<p>Write an SQL query that reports the  <strong>most experienced</strong>  employees in each project. In case of a tie, report all employees with the maximum number of experience years.</p>
<p>The query result format is in the following example:</p>
<p><strong>Project table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
<span class="token operator">|</span> project_id  <span class="token operator">|</span> employee_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------+</span>
</code></pre>
<p><strong>Employee table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+--------+------------------+</span>
<span class="token operator">|</span> employee_id <span class="token operator">|</span> name   <span class="token operator">|</span> experience_years <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Khaled <span class="token operator">|</span> <span class="token number">3</span>                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Ali    <span class="token operator">|</span> <span class="token number">2</span>                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> John   <span class="token operator">|</span> <span class="token number">3</span>                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> Doe    <span class="token operator">|</span> <span class="token number">2</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+------------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
<span class="token operator">|</span> project_id  <span class="token operator">|</span> employee_id   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">1</span>             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">3</span>             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">1</span>             <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+---------------+</span>
</code></pre>
<p>Both employees with id 1 and 3 have the most experience among the employees of the first project. For the second project, the employee with id 1 has the most experience.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要找到每个 project 里 experience_years 最多的 employees，那么只需用 window function partition by 即可。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">with</span> cte <span class="token keyword">as</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> 
    project_id<span class="token punctuation">,</span> 
    p<span class="token punctuation">.</span>employee_id<span class="token punctuation">,</span> 
    experience_years<span class="token punctuation">,</span>
    dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> project_id <span class="token keyword">order</span> <span class="token keyword">by</span> experience_years <span class="token keyword">desc</span><span class="token punctuation">)</span> rnk
<span class="token keyword">from</span> project p
<span class="token keyword">join</span> employee <span class="token number">e</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span>employee_id<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">select</span> project_id<span class="token punctuation">,</span> employee_id
<span class="token keyword">from</span> cte 
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm37.png?raw=true">
</p>
<h3 id="span-id3838.-rank-scoresspan"><span id="38">38. Rank Scores</span></h3>
<p>Write a SQL query to rank scores. If there is a tie between two scores, both should have the same ranking. Note that after a tie, the next ranking number should be the next consecutive integer value. In other words, there should be no “holes” between ranks.</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----+-------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> Score <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> <span class="token number">3.50</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> <span class="token number">3.65</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> <span class="token number">4.00</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> <span class="token number">3.85</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>  <span class="token operator">|</span> <span class="token number">4.00</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>  <span class="token operator">|</span> <span class="token number">3.65</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------+</span>
</code></pre>
<p>For example, given the above  <code>Scores</code>  table, your query should generate the following report (order by highest score):</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------+---------+</span>
<span class="token operator">|</span> score <span class="token operator">|</span> Rank    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+---------+</span>
<span class="token operator">|</span> <span class="token number">4.00</span>  <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4.00</span>  <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3.85</span>  <span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3.65</span>  <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3.65</span>  <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3.50</span>  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+---------+</span>
</code></pre>
<p><strong>Important Note:</strong> For MySQL solutions, to escape reserved words used as column names, you can use an apostrophe before and after the keyword. For example <strong><code>Rank</code></strong>.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>本题是非常 popular 的一道题，虽然简单，但是也告诉我们 window function 的重要性！</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
	score<span class="token punctuation">,</span> 
	dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> 
	<span class="token keyword">as</span> <span class="token punctuation">`</span>Rank<span class="token punctuation">`</span>
<span class="token keyword">from</span> scores
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm38.png?raw=true">
</p>
<h3 id="span-id3939.-rectangles-areaspan"><span id="39">39. Rectangles Area</span></h3>
<p>Table:  <code>Points</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> id            <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> x_value       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> y_value       <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>id is the primary key for this table.<br>
Each point is represented as a 2D Dimensional (x_value, y_value).</p>
<p>Write an SQL query to report of all possible rectangles which can be formed by any two points of the table.</p>
<p>Each row in the result contains three columns (p1, p2, area) where:</p>
<ul>
<li><strong>p1</strong>  and  <strong>p2</strong>  are the id of two opposite corners of a rectangle and p1 &lt; p2.</li>
<li>Area of this rectangle is represented by the column  <strong>area</strong>.</li>
</ul>
<p>Report the query in descending order by area in case of tie in ascending order by p1 and p2.</p>
<p><strong>Points table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------+-------------+-------------+</span>
<span class="token operator">|</span> id       <span class="token operator">|</span> x_value     <span class="token operator">|</span> y_value     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">8</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>        <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">10</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------------+-------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">----------+-------------+-------------+</span>
<span class="token operator">|</span> p1       <span class="token operator">|</span> p2          <span class="token operator">|</span> area        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>        <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+-------------+-------------+</span>
</code></pre>
<p>p1 should be less than p2 and area greater than 0.<br>
p1 = 1 and p2 = 2, has an area equal to |2-4| * |8-7| = 2.<br>
p1 = 2 and p2 = 3, has an area equal to |4-2| * |7-10| = 6.<br>
p1 = 1 and p2 = 3 It’s not possible because the rectangle has an area equal to 0.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>给定了角的坐标，我们来求长方形面积，我们知道矩形面积等于</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">横</mi><mi mathvariant="normal">坐</mi><mi mathvariant="normal">标</mi><mi mathvariant="normal">之</mi><mi mathvariant="normal">差</mi><mi mathvariant="normal">∣</mi><mo>∗</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">纵</mi><mi mathvariant="normal">坐</mi><mi mathvariant="normal">标</mi><mi mathvariant="normal">之</mi><mi mathvariant="normal">差</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|横坐标之差|  * |纵坐标之差|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∣</span><span class="mord cjk_fallback">横</span><span class="mord cjk_fallback">坐</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">之</span><span class="mord cjk_fallback">差</span><span class="mord">∣</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∣</span><span class="mord cjk_fallback">纵</span><span class="mord cjk_fallback">坐</span><span class="mord cjk_fallback">标</span><span class="mord cjk_fallback">之</span><span class="mord cjk_fallback">差</span><span class="mord">∣</span></span></span></span></span></span></p>
<p>所以我们可以使用 self join 来判断是否可以形成矩形：</p>
<ul>
<li>id 不能相同</li>
<li>矩形面积大于 0</li>
</ul>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> 
    <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token keyword">as</span> p1<span class="token punctuation">,</span>
    <span class="token number">b</span><span class="token punctuation">.</span>id <span class="token keyword">as</span> p2<span class="token punctuation">,</span>
    abs<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>x_value<span class="token number">-b</span><span class="token punctuation">.</span>x_value<span class="token punctuation">)</span> <span class="token operator">*</span> abs<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>y_value<span class="token number">-b</span><span class="token punctuation">.</span>y_value<span class="token punctuation">)</span> <span class="token keyword">as</span> area
<span class="token keyword">from</span> points <span class="token number">a</span><span class="token punctuation">,</span> points <span class="token number">b</span>
<span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token operator">&lt;&gt;</span> <span class="token number">b</span><span class="token punctuation">.</span>id
<span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>id <span class="token operator">&lt;</span> <span class="token number">b</span><span class="token punctuation">.</span>id  <span class="token comment"># 防止重复</span>
<span class="token operator">and</span> abs<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>x_value<span class="token number">-b</span><span class="token punctuation">.</span>x_value<span class="token punctuation">)</span> <span class="token operator">*</span> abs<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>y_value<span class="token number">-b</span><span class="token punctuation">.</span>y_value<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> area <span class="token keyword">desc</span><span class="token punctuation">,</span> p1<span class="token punctuation">,</span>p2
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm39.png?raw=true">
</p>
<h3 id="span-id4040.-restaurant-growthspan"><span id="40">40. Restaurant Growth</span></h3>
<p>Table:  <code>Customer</code></p>
<p>±--------------±--------+<br>
| Column Name   | Type    |<br>
±--------------±--------+<br>
| customer_id   | int     |<br>
| name          | varchar |<br>
| visited_on    | date    |<br>
| amount        | int     |<br>
±--------------±--------+<br>
(customer_id, visited_on) is the primary key for this table.<br>
This table contains data about customer transactions in a restaurant.<br>
visited_on is the date on which the customer with ID (customer_id) have visited the restaurant.<br>
amount is the total paid by a customer.</p>
<p>You are the restaurant owner and you want to analyze a possible expansion (there will be at least one customer every day).</p>
<p>Write an SQL query to compute moving average of how much customer paid in a 7 days window (current day + 6 days before) .</p>
<p>The query result format is in the following example:</p>
<p>Return result table ordered by visited_on.</p>
<p><code>average_amount</code> should be <strong>rounded to 2 decimal places</strong>, all dates are in the format (‘YYYY-MM-DD’).</p>
<p><strong>Customer table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+--------------+--------------+-------------+</span>
<span class="token operator">|</span> customer_id <span class="token operator">|</span> name         <span class="token operator">|</span> visited_on   <span class="token operator">|</span> amount      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------------+--------------+-------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Jhon         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>   <span class="token operator">|</span> <span class="token number">100</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> Daniel       <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span>   <span class="token operator">|</span> <span class="token number">110</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Jade         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">03</span>   <span class="token operator">|</span> <span class="token number">120</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>           <span class="token operator">|</span> Khaled       <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">04</span>   <span class="token operator">|</span> <span class="token number">130</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span> Winston      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span>   <span class="token operator">|</span> <span class="token number">110</span>         <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">6</span>           <span class="token operator">|</span> Elvis        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">06</span>   <span class="token operator">|</span> <span class="token number">140</span>         <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">7</span>           <span class="token operator">|</span> Anna         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span>   <span class="token operator">|</span> <span class="token number">150</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8</span>           <span class="token operator">|</span> Maria        <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">08</span>   <span class="token operator">|</span> <span class="token number">80</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">9</span>           <span class="token operator">|</span> Jaze         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">09</span>   <span class="token operator">|</span> <span class="token number">110</span>         <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> Jhon         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">10</span>   <span class="token operator">|</span> <span class="token number">130</span>         <span class="token operator">|</span> 
<span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> Jade         <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">10</span>   <span class="token operator">|</span> <span class="token number">150</span>         <span class="token operator">|</span> 
<span class="token operator">+</span><span class="token comment">-------------+--------------+--------------+-------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------------+--------------+----------------+</span>
<span class="token operator">|</span> visited_on   <span class="token operator">|</span> amount       <span class="token operator">|</span> average_amount <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------------+</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span>   <span class="token operator">|</span> <span class="token number">860</span>          <span class="token operator">|</span> <span class="token number">122.86</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">08</span>   <span class="token operator">|</span> <span class="token number">840</span>          <span class="token operator">|</span> <span class="token number">120</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">09</span>   <span class="token operator">|</span> <span class="token number">840</span>          <span class="token operator">|</span> <span class="token number">120</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">10</span>   <span class="token operator">|</span> <span class="token number">1000</span>         <span class="token operator">|</span> <span class="token number">142.86</span>         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+----------------+</span>
</code></pre>
<p>1st moving average from 2019-01-01 to 2019-01-07 has an average_amount of (100 + 110 + 120 + 130 + 110 + 140 + 150)/7 = 122.86<br>
2nd moving average from 2019-01-02 to 2019-01-08 has an average_amount of (110 + 120 + 130 + 110 + 140 + 150 + 80)/7 = 120<br>
3rd moving average from 2019-01-03 to 2019-01-09 has an average_amount of (120 + 130 + 110 + 140 + 150 + 80 + 110)/7 = 120<br>
4th moving average from 2019-01-04 to 2019-01-10 has an average_amount of (130 + 110 + 140 + 150 + 80 + 110 + 130 + 150)/7 = 142.86</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要计算七天内的移动平均值（当前日期 + 6天前），那么可以用 window function + rows preceding 来解决。</p>
<p>具体语法和解释请看 <strong>Rows and Range, Preceding and Following</strong> <a href="https://stevestedman.com/2013/04/rows-and-range-preceding-and-following/?format=pdf" title="Download PDF"><img src="http://stevestedman.com/wp-content/plugins/wp-post-to-pdf-enhanced/asset/images/pdf.png" alt="Download PDF"></a></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">WITH</span> CTE <span class="token keyword">AS</span> 
<span class="token punctuation">(</span>  <span class="token keyword">SELECT</span>
    visited_on<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ASC</span> <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> amount<span class="token punctuation">,</span>
    <span class="token comment"># moving sum</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ASC</span> <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> average_amount<span class="token punctuation">,</span>
    <span class="token comment"># moving average</span>
    ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> RN
  <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> visited_on<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">AS</span> amount <span class="token keyword">FROM</span> Customer <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> visited_on<span class="token punctuation">)</span> T
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> visited_on
<span class="token punctuation">)</span>
</code></pre>
<p>结果如下;</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"visited_on"</span><span class="token punctuation">,</span> <span class="token string">"amount"</span><span class="token punctuation">,</span> <span class="token string">"average_amount"</span><span class="token punctuation">,</span> <span class="token string">"RN"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"2019-01-01"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100.0000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-02"</span><span class="token punctuation">,</span> <span class="token number">210</span><span class="token punctuation">,</span> <span class="token number">105.0000</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-03"</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">,</span> <span class="token number">110.0000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-04"</span><span class="token punctuation">,</span> <span class="token number">460</span><span class="token punctuation">,</span> <span class="token number">115.0000</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-05"</span><span class="token punctuation">,</span> <span class="token number">570</span><span class="token punctuation">,</span> <span class="token number">114.0000</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-06"</span><span class="token punctuation">,</span> <span class="token number">710</span><span class="token punctuation">,</span> <span class="token number">118.3333</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-07"</span><span class="token punctuation">,</span> <span class="token number">860</span><span class="token punctuation">,</span> <span class="token number">122.8571</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-08"</span><span class="token punctuation">,</span> <span class="token number">840</span><span class="token punctuation">,</span> <span class="token number">120.0000</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-09"</span><span class="token punctuation">,</span> <span class="token number">840</span><span class="token punctuation">,</span> <span class="token number">120.0000</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token string">"2019-01-10"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">142.8571</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>这里的原理大概是这样：</p>
<p align="center">
	  <img src="https://stevestedman.com/wp-content/uploads/rows_range_preceding_following41.jpg">
</p>
<p>我们这里的 <code>ROWS BETWEEN 6 PRECEDING AND CURRENT ROW</code> 就是当前的行和其之前的 6 行，总共 7 行，这里要注意！注意在不满足总共 7 行的情况下，会在之前的所有行的基础上运行函数。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">WITH</span> CTE <span class="token keyword">AS</span> 
<span class="token punctuation">(</span> <span class="token keyword">SELECT</span>
    visited_on<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ASC</span> <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> 
    <span class="token keyword">AS</span> amount<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ASC</span> <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> 
    <span class="token keyword">AS</span> average_amount<span class="token punctuation">,</span>
    ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ASC</span><span class="token punctuation">)</span> 
    <span class="token keyword">AS</span> RN
  <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> visited_on<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">AS</span> amount <span class="token keyword">FROM</span> Customer <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> visited_on<span class="token punctuation">)</span> T
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> visited_on
<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> visited_on<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>average_amount<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> average_amount
<span class="token keyword">FROM</span> CTE
<span class="token keyword">WHERE</span> RN <span class="token operator">&gt;=</span> <span class="token number">7</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm40.png?raw=true">
</p>
<h3 id="span-id4141.-running-total-for-different-gendersspan"><span id="41">41. Running Total for Different Genders</span></h3>
<p>Table:  <code>Scores</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> player_name   <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> gender        <span class="token operator">|</span> <span class="token keyword">varchar</span> <span class="token operator">|</span>
<span class="token operator">|</span> day           <span class="token operator">|</span> <span class="token keyword">date</span>    <span class="token operator">|</span>
<span class="token operator">|</span> score_points  <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p>(gender, day) is the primary key for this table.<br>
A competition is held between females team and males team.<br>
Each row of this table indicates that a player_name and with gender has scored score_point in someday.<br>
Gender is ‘F’ if the player is in females team and ‘M’ if the player is in males team.</p>
<p>Write an SQL query to find the total score for each gender at each day.</p>
<p>Order the result table by gender and day</p>
<p>The query result format is in the following example:</p>
<p><strong>Scores table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">-------------+--------+------------+--------------+</span>
<span class="token operator">|</span> player_name <span class="token operator">|</span> gender <span class="token operator">|</span> day        <span class="token operator">|</span> score_points <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+------------+--------------+</span>
<span class="token operator">|</span> Aron        <span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">17</span>           <span class="token operator">|</span>
<span class="token operator">|</span> Alice       <span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span> <span class="token number">23</span>           <span class="token operator">|</span>
<span class="token operator">|</span> Bajrang     <span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span> <span class="token number">7</span>            <span class="token operator">|</span>
<span class="token operator">|</span> Khali       <span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token number">11</span>           <span class="token operator">|</span>
<span class="token operator">|</span> Slaman      <span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> <span class="token number">13</span>           <span class="token operator">|</span>
<span class="token operator">|</span> Joe         <span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token operator">|</span> <span class="token number">3</span>            <span class="token operator">|</span>
<span class="token operator">|</span> Jose        <span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span>
<span class="token operator">|</span> Priya       <span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token operator">|</span> <span class="token number">23</span>           <span class="token operator">|</span>
<span class="token operator">|</span> Priyanka    <span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> <span class="token number">17</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+------------+--------------+</span>
</code></pre>
<p><strong>Result table:</strong></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">--------+------------+-------+</span>
<span class="token operator">|</span> gender <span class="token operator">|</span> day        <span class="token operator">|</span> total <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+------------+-------+</span>
<span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> <span class="token number">17</span>    <span class="token operator">|</span>
<span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token operator">|</span> <span class="token number">40</span>    <span class="token operator">|</span>
<span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token operator">|</span> <span class="token number">57</span>    <span class="token operator">|</span>
<span class="token operator">|</span> F      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span>
<span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">18</span> <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span>
<span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">25</span> <span class="token operator">|</span> <span class="token number">13</span>    <span class="token operator">|</span>
<span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">30</span> <span class="token operator">|</span> <span class="token number">26</span>    <span class="token operator">|</span>
<span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token operator">|</span> <span class="token number">29</span>    <span class="token operator">|</span>
<span class="token operator">|</span> M      <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span> <span class="token operator">|</span> <span class="token number">36</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------+------------+-------+</span>
</code></pre>
<p>For females team:<br>
First day is 2019-12-30, Priyanka scored 17 points and the total score for the team is 17.<br>
Second day is 2019-12-31, Priya scored 23 points and the total score for the team is 40.<br>
Third day is 2020-01-01, Aron scored 17 points and the total score for the team is 57.<br>
Fourth day is 2020-01-07, Alice scored 23 points and the total score for the team is 80.<br>
For males team:<br>
First day is 2019-12-18, Jose scored 2 points and the total score for the team is 2.<br>
Second day is 2019-12-25, Khali scored 11 points and the total score for the team is 13.<br>
Third day is 2019-12-30, Slaman scored 13 points and the total score for the team is 26.<br>
Fourth day is 2019-12-31, Joe scored 3 points and the total score for the team is 29.<br>
Fifth day is 2020-01-07, Bajrang scored 7 points and the total score for the team is 36.</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span>
    gender<span class="token punctuation">,</span>
    day<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>score_points<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> gender <span class="token keyword">order</span> <span class="token keyword">by</span> day<span class="token punctuation">)</span> <span class="token keyword">as</span> total
    <span class="token comment"># 求累计和！ 很常用！</span>
<span class="token keyword">from</span> scores
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm41.png?raw=true">
</p>
<h3 id="span-id4242.-shortest-distance-in-a-planespan"><span id="42">42. Shortest Distance in a Plane</span></h3>
<p>Table <code>point_2d</code> holds the coordinates (x,y) of some unique points (more than two) in a plane.</p>
<p>Write a query to find the shortest distance between these points rounded to 2 decimals.</p>

<table>
<thead>
<tr>
<th>x</th>
<th>y</th>
</tr>
</thead>
<tbody>
<tr>
<td>-1</td>
<td>-1</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>-1</td>
<td>-2</td>
</tr>
</tbody>
</table><p>The shortest distance is 1.00 from point (-1,-1) to (-1,2). So the output should be:</p>

<table>
<thead>
<tr>
<th>shortest</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.00</td>
</tr>
</tbody>
</table><p><strong>Note:</strong> The longest distance among all the points are less than 10000.</p>
<p><font color="#EA5FD4">详解：</font></p>
<p>给定几个点，找到他们中的最短距离，那么我们要计算出每对不同点之间的距离，求最小值即可。</p>
<p>首先用 self join求出每对点的距离</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> sqrt<span class="token punctuation">(</span>power<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">b</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> power<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>y<span class="token number">-b</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> distance
<span class="token keyword">from</span> point_2d <span class="token number">a</span><span class="token punctuation">,</span> point_2d <span class="token number">b</span>
</code></pre>
<p>结果如下;</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"distance"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1.4142135623730951</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2.23606797749979</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1.4142135623730951</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">2.23606797749979</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>当然，距离必须大于 0，并且要找到最小的。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> shortest
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
<span class="token keyword">select</span> sqrt<span class="token punctuation">(</span>power<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">b</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> power<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>y<span class="token number">-b</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> distance
<span class="token keyword">from</span> point_2d <span class="token number">a</span><span class="token punctuation">,</span> point_2d <span class="token number">b</span>
<span class="token keyword">where</span> sqrt<span class="token punctuation">(</span>power<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">b</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> power<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>y<span class="token number">-b</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
<span class="token punctuation">)</span> t
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm42.png?raw=true">
</p>
<h3 id="span-id4343.-team-scores-in-football-tournamentspan"><span id="43">43. Team Scores in Football Tournament</span></h3>
<p>Table:  <code>Teams</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+----------+</span>
<span class="token operator">|</span> team_id       <span class="token operator">|</span> <span class="token keyword">int</span>      <span class="token operator">|</span>
<span class="token operator">|</span> team_name     <span class="token operator">|</span> <span class="token keyword">varchar</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+----------+</span>
</code></pre>
<p>team_id is the primary key of this table.<br>
Each row of this table represents a single football team.</p>
<p>Table: <code>Matches</code></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> <span class="token keyword">Column</span> Name   <span class="token operator">|</span> <span class="token keyword">Type</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
<span class="token operator">|</span> match_id      <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> host_team     <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> guest_team    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span> 
<span class="token operator">|</span> host_goals    <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">|</span> guest_goals   <span class="token operator">|</span> <span class="token keyword">int</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+---------+</span>
</code></pre>
<p><code>match_id</code> is the primary key of this table.<br>
Each row is a record of a finished match between two different teams.</p>
<p>Teams host_team and guest_team are represented by their IDs in the teams table (team_id) and they scored host_goals and guest_goals goals respectively.</p>
<p>You would like to compute the scores of all teams after all matches. Points are awarded as follows:</p>
<ul>
<li>A team receives three points if they win a match (Score strictly more goals than the opponent team).</li>
<li>A team receives one point if they draw a match (Same number of goals as the opponent team).</li>
<li>A team receives no points if they lose a match (Score less goals than the opponent team).</li>
</ul>
<p>Write an SQL query that selects the  <strong>team_id</strong>,  <strong>team_name</strong>  and  <strong>num_points</strong>  of each team in the tournament after all described matches. Result table should be ordered by  <strong>num_points</strong>  (decreasing order). In case of a tie, order the records by  <strong>team_id</strong>  (increasing order).</p>
<p>The query result format is in the following example:</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token comment"># teams table:</span>
<span class="token operator">+</span><span class="token comment">-----------+--------------+</span>
<span class="token operator">|</span> team_id   <span class="token operator">|</span> team_name    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+--------------+</span>
<span class="token operator">|</span> <span class="token number">10</span>        <span class="token operator">|</span> Leetcode FC  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">20</span>        <span class="token operator">|</span> NewYork FC   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">30</span>        <span class="token operator">|</span> Atlanta FC   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span>        <span class="token operator">|</span> Chicago FC   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">50</span>        <span class="token operator">|</span> Toronto FC   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+--------------+</span>

<span class="token comment"># matches table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+-------------+--------------+</span>
<span class="token operator">|</span> match_id   <span class="token operator">|</span> host_team    <span class="token operator">|</span> guest_team    <span class="token operator">|</span> host_goals  <span class="token operator">|</span> guest_goals  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+-------------+--------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>          <span class="token operator">|</span> <span class="token number">10</span>           <span class="token operator">|</span> <span class="token number">20</span>            <span class="token operator">|</span> <span class="token number">3</span>           <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>          <span class="token operator">|</span> <span class="token number">30</span>           <span class="token operator">|</span> <span class="token number">10</span>            <span class="token operator">|</span> <span class="token number">2</span>           <span class="token operator">|</span> <span class="token number">2</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>          <span class="token operator">|</span> <span class="token number">10</span>           <span class="token operator">|</span> <span class="token number">50</span>            <span class="token operator">|</span> <span class="token number">5</span>           <span class="token operator">|</span> <span class="token number">1</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>          <span class="token operator">|</span> <span class="token number">20</span>           <span class="token operator">|</span> <span class="token number">30</span>            <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>          <span class="token operator">|</span> <span class="token number">50</span>           <span class="token operator">|</span> <span class="token number">30</span>            <span class="token operator">|</span> <span class="token number">1</span>           <span class="token operator">|</span> <span class="token number">0</span>            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+-------------+--------------+</span>

<span class="token comment"># result table:</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+</span>
<span class="token operator">|</span> team_id    <span class="token operator">|</span> team_name    <span class="token operator">|</span> num_points    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">10</span>         <span class="token operator">|</span> Leetcode FC  <span class="token operator">|</span> <span class="token number">7</span>             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">20</span>         <span class="token operator">|</span> NewYork FC   <span class="token operator">|</span> <span class="token number">3</span>             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">50</span>         <span class="token operator">|</span> Toronto FC   <span class="token operator">|</span> <span class="token number">3</span>             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">30</span>         <span class="token operator">|</span> Atlanta FC   <span class="token operator">|</span> <span class="token number">1</span>             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">40</span>         <span class="token operator">|</span> Chicago FC   <span class="token operator">|</span> <span class="token number">0</span>             <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+--------------+---------------+</span>
</code></pre>
<p><font color="#EA5FD4">详解：</font></p>
<p>我们要计算每个队伍的总得分，那么我们应该先计算主队和客队在规则下分别对应的得分。</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> m<span class="token punctuation">.</span>host_team<span class="token punctuation">,</span> m<span class="token punctuation">.</span>guest_team<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">&gt;</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">3</span>
      <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">=</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">1</span> 
      <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> host_point<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">&gt;</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">0</span>
      <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">=</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">1</span> 
      <span class="token keyword">ELSE</span> <span class="token number">3</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> guest_point
<span class="token keyword">FROM</span> Matches <span class="token keyword">AS</span> m
</code></pre>
<p>结果如下：</p>
<pre class=" language-sql"><code class="prism  language-sql">{<span class="token string">"headers"</span>: <span class="token punctuation">[</span><span class="token string">"host_team"</span><span class="token punctuation">,</span> <span class="token string">"guest_team"</span><span class="token punctuation">,</span> <span class="token string">"host_point"</span><span class="token punctuation">,</span> <span class="token string">"guest_point"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token string">"values"</span>: 
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>}
</code></pre>
<p>那么接下来，我们对应主客队使用 case when 进行筛选并记录分数，最后 sum + group by 求解。</p>
<p><font color="red">正确答案如下：</font></p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> T2<span class="token punctuation">.</span>team_id<span class="token punctuation">,</span> T2<span class="token punctuation">.</span>team_name<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">point</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> num_points <span class="token keyword">FROM</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> t<span class="token punctuation">.</span>team_id<span class="token punctuation">,</span> t<span class="token punctuation">.</span>team_name<span class="token punctuation">,</span> T1<span class="token punctuation">.</span>host_team<span class="token punctuation">,</span> T1<span class="token punctuation">.</span>guest_team<span class="token punctuation">,</span> T1<span class="token punctuation">.</span>host_point<span class="token punctuation">,</span> T1<span class="token punctuation">.</span>guest_point<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> t<span class="token punctuation">.</span>team_id <span class="token operator">=</span> T1<span class="token punctuation">.</span>host_team <span class="token keyword">THEN</span> host_point
      <span class="token keyword">WHEN</span> t<span class="token punctuation">.</span>team_id <span class="token operator">=</span> T1<span class="token punctuation">.</span>guest_team <span class="token keyword">THEN</span> guest_point
      <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">point</span> 
<span class="token keyword">FROM</span> Teams t
<span class="token keyword">JOIN</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> m<span class="token punctuation">.</span>host_team<span class="token punctuation">,</span> m<span class="token punctuation">.</span>guest_team<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">&gt;</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">3</span>
      <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">=</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">1</span> 
      <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> host_point<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">&gt;</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">0</span>
      <span class="token keyword">WHEN</span> m<span class="token punctuation">.</span>host_goals <span class="token operator">=</span> m<span class="token punctuation">.</span>guest_goals <span class="token keyword">THEN</span> <span class="token number">1</span> 
      <span class="token keyword">ELSE</span> <span class="token number">3</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> guest_point
<span class="token keyword">FROM</span> Matches <span class="token keyword">AS</span> m<span class="token punctuation">)</span> <span class="token keyword">AS</span> T1<span class="token punctuation">)</span> <span class="token keyword">AS</span> T2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> T2<span class="token punctuation">.</span>team_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">point</span><span class="token punctuation">)</span> <span class="token keyword">DESC</span><span class="token punctuation">,</span> team_id <span class="token keyword">ASC</span><span class="token punctuation">;</span>
</code></pre>
<p align="center">
	  <img src="https://github.com/zg104/zg104.github.io/blob/master/image/sqlm43.png?raw=true">
</p>
</div>
</body>

</html>
